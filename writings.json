{"version":"https://jsonfeed.org/version/1","title":"Johan's Writings","home_page_url":"https://johan.im/","feed_url":"https://johan.im/writings.json","description":"","items":[{"id":"https://johan.im/writings/posting-mastodon-deploying-static-site/","url":"https://johan.im/writings/posting-mastodon-deploying-static-site/","title":"Posting to Mastodon when deploying a static site","content_html":"<p>This is how I made my <a href=\"https://johan.im/micro\">micro notes</a> auto-post to my Mastodon account. Warning: duct-tape and\nstrings ahead. I wrote this system during the nighttime hours in the hospital, where I watched over\nour 10 month old baby who had contracted bronchitis (no worries, everything turned out fine with\nher).</p>\n<h2>Preface: my setup</h2>\n<ul>\n<li>I use a static site generator. I use <a href=\"http://lume.land/\">Lume</a>, but that doesn't really matter.</li>\n<li>I host my site on GitHub Pages. Not likely to matter.</li>\n<li>I use GitHub Actions for actually deploying my site from the repo to GitHub Pages. This probably\nmatters a lot. As long as you have <em>something</em> that runs on every push, you should be able to\ntranslate the steps below to <code>$YOUR_CI</code>.</li>\n</ul>\n<p>I don't use any persistent database anywhere (I use Cloudflare functions for other features in this\nsite). Since the entrypoint to deploy <em>anything</em> on this site is via pushing commits onto the <code>main</code>\nbranch, that's the key for doing anything &quot;hook-y&quot;, like taking an action when some content is\nupdated.</p>\n<hr>\n<h2>The plan</h2>\n<p>Roughly, it works like below. You should be able to translate it to your host/CI runner:</p>\n<ol>\n<li>Push new micro note/blog post.</li>\n<li>On CI, check out the code base and find the filename of the post file. Make some slug/ID out of\nit.</li>\n<li>Look for the slug/ID in a checked in file. This is our &quot;database&quot; over already posted files.</li>\n<li>If it's there, bail.</li>\n<li>If not, we run a script to format the post text and post it to Mastodon over its API.</li>\n<li>Write the file slug/ID to the checked in file. Commit and push (this is still in CI).</li>\n</ol>\n<details class=\"Notice\">\n<summary>Bonus</summary>\n<p>I also do some fanciness before step 5) where I wait before the site is fully deployed before I post\nto Mastodon. If not, people could click the linkback to the post on Mastodon and get to a 404 on my\nsite!</p>\n<p>Here's the source code. Note the <code>ENDPOINT</code> variable which is <code>https://johan.im/status.json</code>, where\nI — at build time — put all goodies.</p>\n<pre><code class=\"language-bash\">#!/usr/bin/env bash\n#\n# Waits for a give note to be deployed at johan.im\n#\n# Usage:\n# ./script/wait-for-status.sh &lt;path to note&gt;\n# ./script/wait-for-status.sh --latest\n\nENDPOINT=&quot;https://johan.im/status.json&quot;\nDIR=&quot;src/notes&quot;\n\nfile_path=&quot;$1&quot;\n\nif [ -z &quot;$file_path&quot; ]; then\n    echo &quot;Usage: script/wait-for-status.sh &lt;path&gt; | --latest&quot;\n    exit 1\nfi\n\nif [ &quot;$file_path&quot; == &quot;--latest&quot; ]; then\n    file_path=$(ls -r1 &quot;$DIR&quot; | grep -v &quot;_&quot; | head -n 1)\nelse\n    file_path=$(basename &quot;$file_path&quot;)\nfi\n\n# 2022-01-04-09-37.md -&gt; 202201040937\nfile_id=$(echo &quot;$file_path&quot; | sed -e &quot;s/-//g&quot; | cut -f 1 -d &quot;.&quot;)\n\nwhile true; do\n    deployed=$(curl -s &quot;$ENDPOINT&quot; | jq -r &quot;.micro&quot;)\n    is_deployed=$([ &quot;$deployed&quot; = &quot;$file_id&quot; ] &amp;&amp; echo true || echo false)\n\n    echo &quot;$([ &quot;$is_deployed&quot; = true ] &amp;&amp; echo &quot;✅&quot; || echo &quot;🕣&quot;) [$(date -u)] Deployed: $deployed $([ &quot;$is_deployed&quot; = true ] &amp;&amp; echo &quot;==&quot; || echo &quot;!=&quot;) Latest: $file_id&quot;\n\n    if [ &quot;$is_deployed&quot; = true ]; then\n        break\n    fi\n\n    sleep 2\ndone\n</code></pre>\n</details>\n<h2>Deciding when to post</h2>\n<p>As mentioned, I use GitHub Actions. YAML seems to be the requirement for all new CI tools these\ndays, and Actions isn't an exception. This is how the first part of my\n<code>.github/workflows/deploy.yml</code> looks like. The code below includes the steps 2-3):</p>\n<details>\n    <summary><code>deploy.yml</code></summary>\n<pre><code class=\"language-yaml\">name: Build and deploy\n\non:\n    push:\n        paths:\n            - &quot;src/**/*&quot;\n\nenv:\n    DENO_VERSION: v1.40.3\n    MASTODON_LOG_FILE: .mastodon-notes\n    NOTES_DIR: src/notes\n\njobs:\n    build:\n        name: Build\n        # Omitted: builds the static site into .html files\n    deploy:\n        name: Deploy\n        # Omitted: puts the built site onto gh-pages branch\n    check_latest_note:\n        name: Check latest note\n        runs-on: ubuntu-latest\n        outputs:\n            do_post: ${{ steps.mastodon_note_check.outputs.do_post }}\n            latest_note_id: ${{ steps.mastodon_note_check.outputs.latest_note_id }}\n            latest_note_path: ${{ steps.mastodon_note_check.outputs.latest_note_path }}\n        steps:\n            - name: Checkout code\n              uses: actions/checkout@v4\n\n            - name: Check if latest note is already posted\n              id: mastodon_note_check\n              run: |\n                latest=&quot;$NOTES_DIR/$(ls -r1 &quot;$NOTES_DIR&quot; | grep -v &quot;_&quot; | head -n 1)&quot;\n                note_id=$(./script/check-mastodon-note.sh &quot;$latest&quot;)\n                [ -z &quot;$note_id&quot; ] &amp;&amp; echo &quot;Latest note $latest is posted. Bail.&quot; || echo &quot;Latest note $latest is not posted. Do post.&quot;\n                [ ! -z &quot;$note_id&quot; ] &amp;&amp; echo &quot;do_post=true&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;\n                echo &quot;latest_note_id=$note_id&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;\n                echo &quot;latest_note_path=$latest&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;\n                cat &quot;$GITHUB_OUTPUT&quot;\n              env:\n                  NOTES_DIR: ${{ env.NOTES_DIR }}\n</code></pre>\n</details>\n<p>Let's go over it.</p>\n<pre><code class=\"language-bash\">latest=&quot;$NOTES_DIR/$(ls -r1 &quot;$NOTES_DIR&quot; | grep -v &quot;_&quot; | head -n 1)&quot;\n</code></pre>\n<p>This puts the latest file in <code>src/notes</code> into a <code>$latest</code> variable. Like this:</p>\n<pre><code class=\"language-bash\">$ NOTES_DIR=&quot;src/notes&quot;\n$ latest=&quot;$NOTES_DIR/$(ls -r1 &quot;$NOTES_DIR&quot; | grep -v &quot;_&quot; | head -n 1)&quot;\n$ echo $latest\nsrc/notes/2024-02-03-21-21-00.md\n</code></pre>\n<p>We feed that into the <code>check-mastodon-note.sh</code> script I have in a separate file, since I'm an\ninconsistent, chaotic programmer. Before reading that code, I'll show you how my &quot;database&quot; over\nposted notes look like:</p>\n<pre><code class=\"language-bash\">$ cat .mastodon-notes\n20231215140531\n20240106124758\n20240118204458\n</code></pre>\n<p>It's an append log with the note date (hyphens removed). Ergo, if the note date is in that list,\nwe've posted to Mastodon already and can bail early.</p>\n<p>Here's my script for checking that:</p>\n<details>\n    <summary><code>check-mastodon-note.sh</code></summary>\n<pre><code class=\"language-bash\">#!/usr/bin/env bash\n#\n# Check whether we've posted the input file path to Mastodon (persisted in $MASTODON_LIST)\n#\n# Usage:\n#\n# ./script/check-mastodon-note.sh &lt;path to file&gt;\n# ./script/check-mastodon-note.sh --latest\n# same as:\n# ./script/check-mastodon-note.sh $(ls -r1 &quot;src/notes&quot; | grep -v &quot;_&quot; | head -n 1)\n\nMASTODON_LIST=&quot;.mastodon-notes&quot;\nDIR=&quot;src/notes&quot;\n\nfile_path=&quot;$1&quot;\n\nif [ &quot;$file_path&quot; == &quot;--latest&quot; ]; then\n    file_path=$(ls -r1 &quot;$DIR&quot; | grep -v &quot;_&quot; | head -n 1)\nelse\n    file_path=$(basename &quot;$file_path&quot;)\nfi\n\n# 2022-01-04-09-37.md -&gt; 202201040937\nfile_id=$(echo &quot;$file_path&quot; | sed -e &quot;s/-//g&quot; | cut -f 1 -d &quot;.&quot;)\n\ncase `cat &quot;$MASTODON_LIST&quot; | grep -Fxq &quot;$file_id&quot; &gt;/dev/null; echo $?` in\n  0)\n    # found\n    exit 0\n    ;;\n  1)\n    # not found, continue\n    echo &quot;$file_id&quot;\n    exit 0\n    ;;\n  *)\n    # error\n    echo &quot;An error occurred when checking $MASTODON_LIST for note: $file_id&quot; 1&gt;&amp;2\n    exit 1\n    ;;\nesac\n</code></pre>\n</details>\n<p>We print the resulting note ID (date with hyphens removed) on <code>stdout</code> if we <em>don't</em> find it in the\nlist. Sweet! Back to the deploy YAML:</p>\n<pre><code class=\"language-yaml\">[ ! -z &quot;$note_id&quot; ] &amp;&amp; echo &quot;do_post=true&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;\necho &quot;latest_note_id=$note_id&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;\necho &quot;latest_note_path=$latest&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;\n</code></pre>\n<p>Push some metadata into the magic <code>GITHUB_OUTPUT</code> environment variable (which points to a file).\nThis is GitHub's way of persisting data between jobs.</p>\n<h2>Posting to Mastodon's API</h2>\n<p>This is the API posting part of <code>deploy.yml</code>:</p>\n<details>\n    <summary><code>deploy.yml</code></summary>\n<pre><code class=\"language-yaml\">post_mastodon:\n    name: Post to Mastodon\n    needs: [deploy, check_latest_note] # can't send post with permalink until site is deployed\n    runs-on: ubuntu-latest\n    if: needs.check_latest_note.outputs.do_post == 'true'\n    steps:\n        - name: Checkout code\n          uses: actions/checkout@v4\n\n        - name: Setup Deno\n          uses: denoland/setup-deno@v1\n          with:\n              deno-version: ${{ env.DENO_VERSION }}\n\n        - name: Post to Mastodon API\n          run: deno run --allow-net --allow-read --allow-write --allow-env script/mastodon.ts &quot;$LATEST_NOTE_PATH&quot;\n          env:\n              MASTODON_ACCESS_TOKEN: ${{ secrets.MASTODON_ACCESS_TOKEN }}\n              LATEST_NOTE_PATH: ${{ needs.check_latest_note.outputs.latest_note_path }}\n</code></pre>\n</details>\n<p><code>if: needs.check_latest_note.outputs.do_post == 'true'</code> will skip this job if we bailed in the\nprevious job. Very handy.</p>\n<details class=\"Notice\">\n    <summary>How to obtain an access token for Mastodon's API</summary>\n<p>Fear not, Mastodon are one of those services which has a seat in heaven: they give you a plain old\naccess token (bearer) which you can use in all API calls 🥹 No messing around with OAuth.</p>\n<p>Read all about it <a href=\"https://docs.joinmastodon.org/client/token/\">in their docs</a>.</p>\n<p>Then put the token as <code>MASTODON_ACCESS_TOKEN</code> in your repo's secret section in settings.</p>\n</details>\n<p>The <code>mastodon.ts</code> script itself isn't that interesting. In a nutshell, it reads the contents of the\nfile on the path it receives as script argument, parses some front matter, truncates the text, makes\na permalink, and do a <code>POST</code> to the API.</p>\n<details>\n    <summary><code>mastodon.ts</code></summary>\n<pre><code class=\"language-ts\">// deno run --allow-net --allow-read --allow-write --allow-env script/mastodon.ts &lt;path&gt;\n// Env vars:\n// - MASTODON_ACCESS_TOKEN\n// - DRY (optional)\n\nimport { parse } from 'yaml';\nimport { extract } from 'front_matter/any.ts';\nimport { notePermalinkOf } from '../src/_includes/permalinks.ts';\nimport * as path from 'path';\n\nconst DRY_RUN = !!Deno.env.get('DRY');\n\nconst accessToken = Deno.env.get('MASTODON_ACCESS_TOKEN');\n\nif (!accessToken) {\n    console.error('No ACCESS_TOKEN');\n    Deno.exit(1);\n}\n\nconst metaFile = import.meta.dirname + '/../src/_data/meta.yml';\n\ninterface Meta {\n    site: string;\n    mastodon: {\n        instance?: string;\n    };\n}\nconst meta = (await Deno.readTextFile(metaFile).then(parse)) as Partial&lt;Meta&gt;;\n\nif (!meta?.mastodon?.instance) {\n    console.error(`No mastodon.instance key in ${metaFile.toString()}`);\n    Deno.exit(1);\n}\n\nconst truncateToStatus = (str: string, permalink: string) =&gt; {\n    const maxLimit = 500;\n    const footer = `\\n\\n↳ ${permalink}`;\n    const statusLimit = maxLimit - footer.length;\n\n    if (str.length &lt;= statusLimit) {\n        return str + footer;\n    }\n\n    return str.slice(0, statusLimit - 1) + '…' + footer;\n};\n\nconst API_ROOT = `https://${meta.mastodon.instance}`;\n\nconst postStatus = async (filePath: string) =&gt; {\n    console.log(`Posting contents of ${filePath}`);\n\n    const latestId = path.basename(filePath).replaceAll('-', '').split('.').at(0)!;\n\n    console.log(`Latest note ID is: ${latestId}`);\n\n    const note = extract(await Deno.readTextFile(import.meta.dirname + `/../${filePath}`));\n\n    if (note.attrs.draft || note.attrs.skip_mastodon) {\n        console.log(\n            `Skipping posting because one of &quot;draft&quot; or &quot;skip_mastodon&quot; are true for note ${filePath}`,\n        );\n        return;\n    }\n\n    const permalink = meta.site + notePermalinkOf(latestId);\n\n    const statusBody = truncateToStatus(note.body.trim(), permalink);\n\n    console.log(\n        `&gt; Posting status (${statusBody.length} chars):\\n----------------------------\\n${statusBody}`,\n    );\n\n    if (DRY_RUN) {\n        console.log(`&gt; Status posted to &lt;DRY RUN&gt;`);\n        return;\n    }\n\n    const url = new URL('/api/v1/statuses', API_ROOT);\n    const form = new FormData();\n\n    form.append('status', statusBody);\n\n    const res = await fetch(url, {\n        method: 'POST',\n        headers: {\n            Authorization: `Bearer ${accessToken}`,\n            'Idempotency-Key': crypto.randomUUID(),\n        },\n        body: form,\n    });\n\n    const json = await res.json();\n\n    if (!res.ok) {\n        throw new Error(`Posting failed with ${res.status}: ${json.error}`);\n    }\n\n    console.log(`&gt; Status posted to ${json.url}`);\n};\n\n// Main\n\nif (!Deno.args[0]) {\n    console.error('Run with mastodon.ts &lt;path to note&gt;');\n    Deno.exit(1);\n}\n\nawait postStatus(Deno.args[0]).catch((err) =&gt; {\n    console.error(err);\n    Deno.exit(1);\n});\n</code></pre>\n</details>\n<h2>Persisting to the database file</h2>\n<p>Yay, you've made it this far! Let's check out the final stretch of the lovely YAML:</p>\n<details>\n    <summary><code>deploy.yml</code></summary>\n<pre><code class=\"language-yaml\">- name: Write to log\n  run: |\n      echo &quot;$LATEST_UNPOSTED&quot; &gt;&gt; $MASTODON_LOG_FILE\n      cat &quot;$MASTODON_LOG_FILE&quot;\n  env:\n      MASTODON_LOG_FILE: ${{ env.MASTODON_LOG_FILE }}\n      LATEST_UNPOSTED: ${{ needs.check_latest_note.outputs.latest_note_id }}\n\n- name: Commit and push posted notes\n  run: |\n    git config user.name &quot;Automated&quot;\n    git config user.email &quot;actions@users.noreply.github.com&quot;\n    git add $MASTODON_LOG_FILE\n    timestamp=$(date -u)\n    git commit -m &quot;Latest post to Mastodon: $timestamp [skip-ci]&quot; || exit 0\n    git push\n  env:\n      MASTODON_LOG_FILE: ${{ env.MASTODON_LOG_FILE }}\n</code></pre>\n</details>\n<ol>\n<li>Append the date/ID of the latest post into the log/database file.</li>\n<li>Commit this and push to persist.</li>\n</ol>\n<p>Done!</p>\n<hr>\n<p>As you can see, it's essentially just keeping track of the latest unposted file and shoves that\naround betwen the steps in the GitHub Action 🤷 But I like the approach of thinking in files and\nthus always keeping the state within the repo's boundaries.</p>\n<p>I love DIY solutions over external services. Mo' dependencies, mo' problems.</p>\n","date_published":"Wed, 07 Feb 2024 14:36:58 GMT"},{"id":"https://johan.im/writings/mastodon/","url":"https://johan.im/writings/mastodon/","title":"Mastodon","content_html":"<p>During November this year, Elon Musk took over as acting CEO of Twitter. It was a horrible event: it\nfelt like the end of the world, and ideological users left or set up alternative social media\naccounts for themselves. It became totally normal to tweet your contact details with &quot;Find me at X&quot;\n(as I've would go through all those tweets and follow people on Instagram/Tumblr/what-have-you) like\nthe service would shut down at any given time.</p>\n<p>Now, the (Twitter) apocalypse didn't come. It might still do, because Elon either kicked or caused\nthousands of employees to leave. But I think a non-trivial blow was caused against the OG social\nmedia giant, since people like me actually got off of their asses and created Mastodon accounts. I\nrecommend skimming through the\n<a href=\"https://en.wikipedia.org/wiki/Mastodon_(social_network)\">Wikipedia page for Mastodon</a> (huh, it was\nstarted as recently as 2016, I didn't know that).</p>\n<p>I've loved Twitter from all the way since I joined in 2008. I recall my &quot;final exam&quot; project in high\nschool was a Twitter client built in Java and Swing. Twitter has enriched my digital life with\nknowledge, joy, random banter, news, and true sense of &quot;we&quot; during major events. Sentimentally, like\na big ol' family. However, I'm totally aware of the problems of the platform when it comes to\nharassment and the likes. Also, I've heard the product itself (the web UI and mobile apps) isn't\namong people's favourite things to interact with. Non-linear timeline, suggestions, seeing tweets\nfrom people you don't follow, ads, etc. etc. I've had non of that, since I've used the\n<a href=\"https://tapbots.com/\">Tweetbot clients for Mac and iOS</a> for years. That's how I've kept sane during\nall this time. I urge you to try out a 3rd party client too.</p>\n<p>Speaking of 3rd party clients leads me into this interesting topic: openness and ownership. At\ncertain points in time, Twitter took measures in severely limiting their 3rd party APIs so that app\ndevelopers couldn't provide all the features you'd get with Twitter's own apps. This sucks for us\nusers, obviously, but from a bUsIneSs pErSpEctIvE it makes sense: Twitter is a public company with\nobligations to their shareholders. I get that. (Even though they still don't do well financially.)\nIn Mastodon world (&quot;the fediverse&quot; – Federated Universe), this could never happen, because there's\nnot a single entity in control over the APIs. For an &quot;internet enthusiast&quot; as myself, steeped in\n90s/00s open software culture and with a gradual dissatisfaction with centralised companies in\nSilicon Valley owning my shit, Mastodon is really lovely.</p>\n<p>Mastodon is:</p>\n<ul>\n<li>open source, so you can fork the source code and run it on your on server</li>\n<li>maintained by a German non-profit (not an American organisation for once! *tears of joy)</li>\n<li>ad-free, backed by supporters</li>\n<li>Supporting W3C's <a href=\"https://en.wikipedia.org/wiki/ActivityPub\">ActivityPub</a> protocol for talking\nwith other services</li>\n<li>decentralised, anybody can boot up their own Mastodon instance and connect to the &quot;federation&quot;</li>\n</ul>\n<p>The last point is of course not something regular users will do. This quote comes to mind:</p>\n<blockquote>\n<p>People don’t want to run their own servers, and never will.</p>\n<p><a href=\"https://moxie.org/2022/01/07/web3-first-impressions.html\">Moxie Marlinspike</a></p>\n</blockquote>\n<p>This is just an implementation detail, but I like that you <em>can</em> do this. But I won't. Instead, I\ntrust the instance I'm registered to at the moment. But if I wanted to, I could just take my stuff\nand migrate to another instance. This is really important, since it lowers the anxiety of picking an\ninstance when you sign up (they should front this more in the onboarding).</p>\n<p>The &quot;how to pick an instance&quot; part of Mastodon is probably their biggest UX challenge at the moment.\nI'm at <a href=\"https://hachyderm.io/about\">Hachyderm</a>, which is run by a great engineer at GitHub. The\ninstance is well maintained and has sane server rules. How did I find it? Via\n<a href=\"https://hachyderm.io/@mislav\">@mislav</a> on Twitter, in his\n<a href=\"https://twitter.com/mislav/status/1592905424214274049\">good intro thread</a> to Mastodon.</p>\n<p>I'm kind of torn on the subject of &quot;Twitter vs Mastodon&quot;. One one hand, I love the hacker ethics of\nMastodon. On the other hand, I love the original attitudes of Twitter and <em>my</em> timeline. I don't\nwant Twitter to fail per se, but at the same time, I'm happy that Mastodon got an influx of users\nduring the Elon Musk takeover. But the takeover was, to me, completely unnecessary. They did not\nhave to sell to Musk. Now, a month later, a <em>bunch</em> of great engineers – some of the best in the\nworld – have left the company. Twitter may have suffered from the ordinary big-co Silicon Valley\nbullshit when it comes to policies, investors, management, and so on, but I've heard their\nengineering team is really, really great. So I'm sad for them having to leave their work and code\ndue to the rich asshole barging in.</p>\n<p>Now when the dust has settled a bit after the Twitter doomsday frenzy, I appreciate Mastodon <em>a\nlot</em>. It's so cosy checking out my timeline there, since it feels like Twitter felt in the\nbeginning, before the harsh reality of profit making got on them. The hacker feel of the system also\nbrings out nostalgia. Even though I've been guarded from most of Twitter's bad product decisions\nthanks to the aforementioned choice of 3rd party clients, the feel of Mastodon is something special.\nMaybe it's just a feel of starting over. But it creates a fuzzy feeling knowing that the project is\nbased on attitudes and philosophies I can get behind. Does it have the same reach and scale as\nTwitter? Of course not, that's not the goal. Most Twitter users whose tweets I enjoy the most are on\nMastodon anyway. Is it annoying checking two apps? A bit, yes, but the content also vary in that\nMastodon posts (&quot;toots&quot;) feels more well written and have higher quality.</p>\n<p>Mastodon certainly isn't perfect. It surely has or will have its problems and scandals or whatnot.\nWe'll see. For now though, I'm just happy to have discovered a new project and technology I like for\nmyself.</p>\n<p>Now I'm just waiting for Tapbot's <a href=\"https://hachyderm.io/@ivory@tapbots.social\">Ivory</a> client to\nland…</p>\n<p>(I'm <a href=\"https://hachyderm.io/@brookie\">@brookie@johan.im</a> on Mastodon by the way!)</p>\n","date_published":"Fri, 30 Dec 2022 10:20:00 GMT"},{"id":"https://johan.im/writings/my-favourite-software/","url":"https://johan.im/writings/my-favourite-software/","title":"My favourite software","content_html":"<h2>1. Typescript</h2>\n<p>I started programming in Java and PHP. Those two worlds were vastly different. PHP stood for\nfreedom, fun, and anything-is-possible. Java was rigid, hard, and verbose – much because of the need\nfor <em>types</em> everywhere. However, when I got the Java code to compile, it was <em>usually</em> okay in\nruntime (as okay it can be for a 15 year old). Java was heavily used in university, and I grew to\nhate it even more. The interpreted languages like PHP, Ruby, and Javascript felt much nicer.</p>\n<p>Fast forward to around 2018, and I got the chance to play around with Typescript (and GraphQL) at\nwork. This was a turning point in my journey as programmer: the types actually helped me. The type\nsystem – although not as &quot;correct&quot; as in Haskell et al – was expressive, flexible, and quite easy to\nunderstand. And the language itself resembled Javascript so much I didn't think about it.</p>\n<p>What I love about Typescript is:</p>\n<ul>\n<li>the no-nonsense setup:<pre><code class=\"language-bash\">npm i --save-dev typescript\ntouch script.ts\nnpx tsc script.ts\n</code></pre>\n</li>\n<li>the backwards compatibility with Javascript: one can gradually add types if that suits the\nproject.</li>\n<li>I'm not annoyed over any particular syntax of the language.</li>\n<li>that it's actively maintained, and the community is growing and full of tools.</li>\n</ul>\n<hr>\n<p>Typescript is probably the single piece of software that has made me write better code over the last\nfew years. I need less automatic tests, less or no linting. It has opened a new world (of types) to\nme, and has made me never wanting to go back.</p>\n<h2>2. Deno</h2>\n<p><a href=\"https://deno.land/\">Deno</a> is what NodeJS was supposed to be. I think. It's a new Javascript runtime\nwhich does a lot of things right. Peruse the Manual and if you've written a bit of NodeJS, you'll\nprobably find yourself nod along as you read through the Deno docs.</p>\n<p>There are a lot of built-in things, and the ecosystem is spreading. Typescript is a first class\ncitizen. Testing, formatting, and linting are included. Web APIs are available on the server.</p>\n<p>Deno fixes so many things in Node which I'd either get annoyed with or work around.</p>\n<h2>3. cUrl</h2>\n<p>The <code>curl</code> command just works. There are wrappers and replacements which are &quot;simpler&quot; and more\nintuitive. But this is one of these cases where I think it's good to learn the low level tools,\nsince <code>curl</code> is available on a <em>lot</em> of machines.</p>\n<p>I for one appreciate elegant CLI tools which doesn't make me figure out their fantasy world of\noptions and arguments. But <code>curl</code> is such a fundamental way to interact with remote data (I use it\nfor HTTP 100% of the cases).</p>\n<h2>4. Lume</h2>\n<p><a href=\"https://lumeland.github.io/\">Lume</a> is a static site generator (using Deno and Typescript). I\nrecently moved to it from Eleventy, and before that from Jekyll -&gt; Wintersmith -&gt; Metalsmith. Lume\nis the first one which is close to 100% intuitive, and the first one that I'm not annoyed over when\nusing. I've read some of the Lume source code, and it's lovely: succinct and readable.</p>\n<p>Lume does what it does, and does it really well.</p>\n<h2>5. Numi</h2>\n<p><a href=\"https://numi.app/\">Numi</a> is a calculator app, like Soulver, which I use a couple of times per day.\nI've bound it to be visible when I press <code>cmd+shift+x</code> for quick calculations. I use it for\neverything from credit card bills to protein intake calculations. It's declarative in the sense that\nit &quot;does what I think it does&quot;. If I type <code>5% of 100g</code> it'll output <code>5 g</code>. It has\n<a href=\"https://github.com/nikolaeu/numi/wiki/Documentation\">nice documentation</a>.</p>\n<p>Numi doesn't just to maths: it can deal with unit, timezone, and currency conversions too, and many\nother things.</p>\n<p>This tech isn't novel, but Numi pulls it off in a minimal packaging, and I love it.</p>\n<h2>6. Tweetbot</h2>\n<p>I honestly don't understand why people are using the regular Twitter.com or Twitter clients for\niOS/Android. People complain daily about &quot;The Algorithm&quot;, non-chronological timelines, ads, etc.\netc. Just start using a 3rd party client already!</p>\n<p>I've used a ton of clients since I joined Twitter. Many of them are now dead because of Twitter's\nbig purge (they killed a lot of API functionality and tweaked some legal agreement I think). But\n<a href=\"https://tapbots.com/tweetbot/\">Tweetbot</a> is still standing, and are actively pushing new features.\nI'm a happy subscriber.</p>\n<p>The team has always produced super slick designs, and their work is still cool in a world which\ndoesn't really do skeumorphism any longer.</p>\n<p>Tweetbot for Mac and iOS have all the features I need. It makes intelligent use of gestures on\nrespective platform, and I can customise things. No ads. No weird sorting or algorithm. It's\nliterally how Twitter used to be.</p>\n","date_published":"Wed, 23 Feb 2022 00:00:00 GMT"},{"id":"https://johan.im/writings/sublime-text-deno/","url":"https://johan.im/writings/sublime-text-deno/","title":"Setting up Sublime Text for Deno","content_html":"<p>I've recently switched back to Sublime Text as main editor, as described in a recent\n<a href=\"https://johan.im/micro/202202080950\">/micro post</a>. As a test to get a feel for the ecosystem, I've set out on a\njourney to make it more ergonomic to develop <a href=\"https://deno.land/\">Deno</a> code. &quot;Ergonomic&quot; as in\n&quot;actually use Typescript features and not show any red compile errors for Deno specific code&quot;. Also,\nI want to try to have Sublime support\n<a href=\"https://deno.land/manual/linking_to_external_code/import_maps\">import maps</a>,\n<a href=\"https://deno.land/manual/getting_started/configuration_file\">the Deno config file</a>, and format on\nsave.</p>\n<h1>Install necessary packages</h1>\n<p>(I assume you have <a href=\"https://packagecontrol.io/installation\">Package Control up and running</a>.)</p>\n<p><strong>Required:</strong></p>\n<ul>\n<li><a href=\"https://packagecontrol.io/packages/LSP\">LSP</a>. Client implementation of the Language Server\nProtocol for Sublime Text. This is a base package, which is used by other language specific\npackages. There are packages for Typescript, CSS, Deno, JSON, Lua, Vue, etc. etc.</li>\n<li><a href=\"https://packagecontrol.io/packages/LSP-Deno\">LSP-Deno</a>. Convenience package for starting the Deno\nLSP server. This enables Deno features in Sublime.</li>\n</ul>\n<p><strong>Optional:</strong></p>\n<ul>\n<li><a href=\"https://packagecontrol.io/packages/LSP-json\">LSP-json</a>. Schema validation/completions for your\nJSON and Sublime files. This is for making JSON files more &quot;VS Code like&quot; in the way that keys in\nvarious settings files can be autocompleted and validated. Handy but in no way required.</li>\n</ul>\n<h2>Sublime project configuration</h2>\n<p>First of all, we need a place where we can instruct Sublime (and installed packages) where to look\nfor custom Deno settings. That is, settings that describe paths to files, and lint and format\nconfig. Essentially holding the values described in\n<a href=\"https://deno.land/manual/getting_started/configuration_file\">&quot;Configuration file&quot;</a>.</p>\n<p>These will go into a <code>xxx.sublime-project</code> file, where <code>xxx</code> is the name of your project (anything).\nCreate one if you haven't.</p>\n<hr>\n<p>(Sublime has this concept of &quot;projects&quot; I don't really like. One has to go to <em>Window -&gt; Open\nproject…</em> in order for the editor to actually load the project config file, <em>or</em> use\n<code>subl --project path/to/project.sublime-project</code>. It's not loaded when the editor is brought up via\n<code>subl .</code> from the command line. This feels lame. Sort of\n<a href=\"https://github.com/sublimehq/sublime_text/issues/828\">tracked here</a>.)</p>\n<hr>\n<p>This is a sample <code>xxx.sublime-project</code> for Deno:</p>\n<pre><code class=\"language-json\">{\n    &quot;settings&quot;: {\n        &quot;LSP&quot;: {\n            &quot;LSP-typescript&quot;: {\n                &quot;enabled&quot;: false\n            },\n            &quot;Deno&quot;: {\n                &quot;enabled&quot;: true,\n                &quot;settings&quot;: {\n                    &quot;deno.config&quot;: &quot;./deno.jsonc&quot;,\n                    &quot;deno.unstable&quot;: true,\n                    &quot;deno.importMap&quot;: &quot;./import_map.json&quot;,\n                    &quot;deno.suggest.imports.hosts&quot;: {\n                        &quot;https://deno.land&quot;: true,\n                        &quot;https://some-other-cdn.com&quot;: true\n                    }\n                }\n            }\n        }\n    }\n}\n</code></pre>\n<p>All <code>deno.*</code> settings are documented\n<a href=\"https://github.com/sublimelsp/LSP-Deno/blob/main/LSP-Deno.sublime-settings\">here, with defaults</a>.</p>\n<p>Line by line:</p>\n<ul>\n<li><code>LSP-typescript</code>. Let's be really sure to disable the TypeScript Language Server, since that'll\ninterfere with <code>.ts</code> files with Deno calls.</li>\n<li><code>deno.config</code>: Path to the Deno\n<a href=\"https://deno.land/manual/getting_started/configuration_file\">configuration file</a>.</li>\n<li><code>deno.unstable</code>: Enable unstable features or not.</li>\n<li><code>deno.importMap</code>: Path to an <a href=\"https://deno.land/manual/npm_nodejs/import_maps\">import map</a>.</li>\n<li><code>deno.suggest.imports.hosts</code>: Hosts that will appear as suggestions when importing.</li>\n</ul>\n<p>(As mentioned above, the LSP-json package really helps you with the autocomplete here. I found it\ntricky to figure out the exact structure of these settings.)</p>\n<p>For me, there's no need to do further tweaks in most Deno projects.</p>\n<p>Now, Sublime should be able to pick up your import map, as well as your Deno configuration.</p>\n<p>If configured correctly, you should be able to</p>\n<ul>\n<li>get IntelliSense popups when hovering over functions</li>\n<li>have working import maps</li>\n<li>get proper type info and autocompletions when coding</li>\n<li>have correct <code>compilerOptions</code> from your Deno config</li>\n</ul>\n<p>and lots more.</p>\n<p><img src=\"https://johan.im/assets/posts/deno-intellisense.png\" alt=\"IntelliSense documentation popup\"></p>\n<hr>\n<p><strong>Note:</strong> at the time of writing, there's an issue with the <code>deno.suggest.imports.hosts</code> key. If you\ntoggle the LSP log panel (<em>Command palette -&gt; &quot;LSP: Toggle log panel&quot;</em>), you'll see that it says:</p>\n<pre><code>failed to update settings: invalid type: map, expected a boolean\n</code></pre>\n<p>I've filed an <a href=\"https://github.com/sublimelsp/LSP-Deno/issues/10\">issue for LSP-Deno here</a>. I've\nnoticed that this setting interfers with the other settings, so I've removed it for now.</p>\n<h2>Click to go to definition</h2>\n<p>This is a feature I heavily used in VS Code: use the combo of <code>option+click</code> (Mac) to go to the\ndefinition of a variable, function, or type. This uses the LSP, so it'll be &quot;intelligent&quot;.</p>\n<p>Mouse bindings live in this file (create it if it doesn't exist):</p>\n<pre><code>~/Library/Application\\ Support/Sublime\\ Text/Packages/User/Default\\ (OSX).sublime-mousemap\n</code></pre>\n<p>Then add this:</p>\n<pre><code class=\"language-json\">[\n    {\n        &quot;button&quot;: &quot;button1&quot;,\n        &quot;count&quot;: 1,\n        &quot;modifiers&quot;: [\n            &quot;alt&quot;\n        ],\n        &quot;press_command&quot;: &quot;lsp_symbol_definition&quot;\n    }\n]\n</code></pre>\n<p>You can now use <code>alt+click</code> to jump around.</p>\n<h2>Rename symbols</h2>\n<p>Another nifty feature we can use the Language Server's capabilities for is to do smart renames, i.e.\nrename functions and variables and have them be intelligently updated across files.</p>\n<p>In VS Code, I used the key binding <code>cmd+shift+r</code> (Mac).</p>\n<p>Open up Key Bindings (<em>Preferences -&gt; Key Bindings</em>) or:</p>\n<pre><code class=\"language-bash\">subl ~/Library/Application\\ Support/Sublime\\ Text/Packages/User/Default\\ (OSX).sublime-keymap\n</code></pre>\n<p>Then add this:</p>\n<pre><code class=\"language-json\">[\n    {\n        &quot;keys&quot;: [&quot;super+shift+r&quot;],\n        &quot;command&quot;: &quot;lsp_symbol_rename&quot;,\n        &quot;context&quot;: [\n            {\n                &quot;key&quot;: &quot;lsp.session_with_capability&quot;,\n                &quot;operator&quot;: &quot;equal&quot;,\n                &quot;operand&quot;: &quot;renameProvider&quot;\n            }\n        ]\n    }\n]\n</code></pre>\n<h2>Diagnostics panel</h2>\n<p>By default, the LSP package will show a diagnostics panel if there are TypeScript errors or warnings\nin your project. I found this really annoying, so I turned it off with:</p>\n<p><em>Preferences -&gt; Package Settings -&gt; LSP -&gt; Settings</em></p>\n<p>Then add:</p>\n<pre><code class=\"language-json\">{\n    // Open the diagnostics panel automatically on save when diagnostics level is\n    // equal to or less than:\n    // none: 0 (never open the panel automatically)\n    // error: 1\n    // warning: 2\n    // info: 3\n    // hint: 4\n    &quot;show_diagnostics_panel_on_save&quot;: 0 // default is 2, turn off with 0\n}\n</code></pre>\n<p><strong>Tip:</strong> You can still toggle the <em>Diagnostics</em> panel with <code>cmd+alt+m</code> (Mac) or search for it in the\ncommand palette. It'll show any TypeScript errors or warnings in the project.</p>\n<h2>Code formatting</h2>\n<p>Deno comes with a built-in formatter, which the LSP in Sublime can use.</p>\n<p>Either run <code>LSP: Format file</code> from the command palette to format manually, or use format on save.\nThe latter is configured in the LSP settings, <em>but</em> you should probably do it on a project basis.\nThis means adding this to your Sublime project file:</p>\n<pre><code class=\"language-json\">{\n    &quot;settings&quot;: {\n        &quot;lsp_format_on_save&quot;: true\n    }\n}\n</code></pre>\n<p>The exact formatting config lives in your Deno configuration. For me, it's <code>deno.jsonc</code>:</p>\n<pre><code class=\"language-json\">{\n    &quot;fmt&quot;: {\n        &quot;options&quot;: {\n            &quot;useTabs&quot;: false,\n            &quot;lineWidth&quot;: 100,\n            &quot;singleQuote&quot;: true,\n            &quot;indentWidth&quot;: 4\n        }\n    }\n}\n</code></pre>\n<h2>Bonus: JSON schema support for <code>deno.json</code></h2>\n<p>There's no built-in support for autocompletions in <code>deno.{json,jsonc}</code> files. But with our newly\ninstalled LSP-json package, there is a way! Deno publishes its schema for the config file on a URL,\nwhich we can add to &quot;user schemas&quot; in the LSP-json settings.</p>\n<p>Open <code>LSP-json.sublime-settings</code> or run <code>LSP-json Settings</code> in the command palette. Then add this:</p>\n<pre><code class=\"language-json\">{\n    &quot;settings&quot;: {\n        &quot;userSchemas&quot;: [\n            {\n                &quot;fileMatch&quot;: [&quot;deno.json&quot;, &quot;deno.jsonc&quot;],\n                &quot;uri&quot;: &quot;https://deno.land/x/deno@v1.18.2/cli/schemas/config-file.v1.json&quot;\n            }\n        ]\n    }\n}\n</code></pre>\n<p>I guess one has to update the versions in there manually, but the package wouldn't follow the URL\nlinked from Deno's\n<a href=\"https://deno.land/manual/getting_started/configuration_file\">documentation page</a>, probably since it\nredirects:\n<a href=\"https://deno.land/x/deno/cli/schemas/config-file.v1.json\">https://deno.land/x/deno/cli/schemas/config-file.v1.json</a>.</p>\n<hr>\n<p>That's it! <a href=\"https://johan.im/contact\">Let me know</a> if you've got more tricks for working with Deno in Sublime.</p>\n","date_published":"Wed, 16 Feb 2022 00:00:00 GMT"},{"id":"https://johan.im/writings/deno/","url":"https://johan.im/writings/deno/","title":"A whole new world with Deno","content_html":"<p><a href=\"https://deno.land/\">Deno</a> is a new <em>runtime</em> for Javascript. Before, NodeJS used to be the most\npopular way to run Javascript on the server. But no more! Deno has reached stable state (it's on\nversion 1.17 at the time of writing). It runs Typescript natively, supports ES imports (why did I\nfeel I had to specify that as a feature?), and is built with Rust (again! This isn't a feature, but\nit feels good that it's Rust somehow, doesn't it?).</p>\n<p>Until now, I've just read the <a href=\"https://deno.land/manual\">Deno manual</a> and lurked in their\n<a href=\"https://deno.land/std\">standard library</a>. Then I played around with a server + client app for a\ncouple of days, and after that I converted this site to use <a href=\"https://lumeland.github.io/\">lume</a>,\nwhich is a static site generator based on Deno.</p>\n<p>Here are some of my personal favourites in Deno, with some love for lume as an appendix.</p>\n<h1>Web APIs we know and love</h1>\n<p>Deno includes a ton of niceties that just sparks joy for the hardest of the hardcore NodeJS\ndevelopers out there. <code>fetch</code> <em>just works</em> (we've internalised that one needs to <code>npm install</code> some\nexternal library for HTTP requests in NodeJS). Hell, even doing the very browser-y <code>alert</code> and\n<code>confirm</code> in your Deno based CLI script will work on the command line to show a message and prompt\nfor yes/no, respectively. Opinions might differ whether this is good or bad, but personally I\nappreciate not having to pull in a lib or visit StackOverflow each time I need user input.</p>\n<blockquote>\n<p>For APIs where a web standard already exists, like fetch for HTTP requests, Deno uses these rather\nthan inventing a new proprietary API.</p>\n</blockquote>\n<p>The above line from <a href=\"https://deno.land/manual/runtime\">&quot;The Runtime&quot;</a> section of the Manual is the\nred line throughout the Deno API.</p>\n<p>That means, instead of doing</p>\n<pre><code class=\"language-ts\">// Node\nimport request from 'some-random-npm-request-lib';\n\nconst response = await request.get('https://deno.land');\n</code></pre>\n<p>you'd do</p>\n<pre><code class=\"language-ts\">// Deno/browsers\nconst response = await fetch('https://deno.land');\n</code></pre>\n<p>In Deno, you can use a ton of browser-y APIs, such as <code>location</code>, <code>local/sessionStorage</code>,\n<a href=\"https://deno.land/manual@v1.17.3/runtime/web_platform_apis#other-apis\">and more</a>.</p>\n<p>Another example: you can use the same CSS based styling for <code>console</code> calls as you'd do in the\nbrowser:</p>\n<pre><code class=\"language-ts\">// Deno/browsers\nconsole.log(\n    '%cHi there. %cSome background?',\n    'color: red',\n    'background-color: gray',\n);\n</code></pre>\n<p>No need for terminal escape codes or pulling in yet another library.</p>\n<p>I hope it's clear where I'm getting at: there are things included in Deno that you <em>just know\nalready</em> because you've been writing web code for years. It lowers the iteration speed when writing\ncode, as well as lowers the overhead when reading it, when you don't have to refer to third party\ndependencies or in-house modules all the time. To me, this feels much better when writing code in\nDeno.</p>\n<p>The use of third party dependencies have been a debate in Javascript land during the past couple of\nmonths, due to … incidents around security and feelings of the module authors themselves. Surely the\nbest dependency is no dependency, right? Surely a ton of npm modules can be deprecated if only\nNodeJS (or Javascript itself) had a better standard library?</p>\n<p>I hope that we in the future look at &quot;old&quot; code and say: &quot;Oh, did you pull in a dependency for\n<em>that</em>?&quot;.</p>\n<p><strong><em>Update, 2022-02-08:</em></strong> the Deno authors have written a neat\n<a href=\"https://deno.com/blog/every-web-api-in-deno\">blog post</a> detailing all web platform APIs implemented\nin Deno, with examples. You'll get a very fuzzy feeling when reading the list.</p>\n<h1>Typescript as a first class citizen</h1>\n<p>I was in tears (tears of joy, I assure you) when I first read about Typescript support in Deno when\nthe latter was introduced years ago. No need for a build step for <code>.ts</code> and <code>.tsx</code> files, just\n<code>deno run</code> and off you go. I just works.</p>\n<p>One neat API is <a href=\"https://deno.land/manual/typescript/runtime\"><code>Deno.emit</code></a>. With it, you can\nprogrammatically compile and bundle Typescript code to Javascript.</p>\n<p>I've got not much more to say about this than <em>&quot;Finally&quot;</em>.</p>\n<h1>Testing</h1>\n<p>Let's play a game. How many test runners for Javascript code can you think of?</p>\n<p>…</p>\n<p>Okay, tough question, as the correct answer probably is: &quot;The number is approaching <code>Infinity</code>&quot;.</p>\n<p>How many test runners do you <em>need</em>? One. There's one built-in in Deno:</p>\n<pre><code class=\"language-ts\">Deno.test('My test', () =&gt; {\n    // test things\n});\n</code></pre>\n<p>Name the file <code>something.test.ts</code> and run it with:</p>\n<pre><code class=\"language-bash\">deno test something.test.ts\n</code></pre>\n<p>I love this. Standardised, one way of doing things, minimal. No arguing in the team about which is\nthe best test runner this month.</p>\n<p>The <a href=\"https://deno.land/std/testing\"><code>testing</code></a> module from the Deno std lib includes a couple of\nassertions – you probably don't need more than those. (I also see it exports tools for benchmarking\nyour code as well, iihhh!)</p>\n<h1>Distributed dependency management</h1>\n<p>…with no <code>package.json</code>! In Deno, you import external, remote, dependencies with URLs. Again, just\nlike we've done in the browser since the 90s (<code>&lt;script src=&quot;http://cdn.example.com/script.js&gt;</code>\namirite). When Deno first runs your code, it'll fetch the remote script and cache it locally for the\nnext runs. Don't be scared: Deno do support reading and writing a lockfile with options to\n<code>deno run</code>.</p>\n<p>This is how it looks like:</p>\n<pre><code class=\"language-ts\">import dependency from 'https://somesite.com/mod.ts';\n</code></pre>\n<p>(By convention, modules should have a <code>mod.ts</code> which is the entrypoint for consumers. Note that\nthere's no concept of some silly <code>index.js</code> file in Deno land: that's one thing the Node creator\nRyan wanted to get rid of when he created Deno.)</p>\n<p>This is actually fairly liberating once you've sweated out the feelings of chaos in your codebase.\nRemember, this is all source code! You can centralise all these third party imports to a single file\nand re-export them. In fact, that's what\n<a href=\"https://deno.land/manual@v1.18.0/linking_to_external_code#it-seems-unwieldy-to-import-urls-everywhere\">they recommend in the Deno Manual</a>:</p>\n<pre><code class=\"language-ts\">// deps.ts (naming convention!)\nexport * as assert from 'https://deno.land/std@0.122.0/testing/asserts.ts';\n</code></pre>\n<p>&quot;Sooo how do I get my fav npm hosted lib into my Deno code then?&quot;, you ask.</p>\n<ol>\n<li>Check <a href=\"https://deno.land/x\">deno.land/x</a> if the module is hosted there. There are a lot of Deno\nspecific modules.</li>\n<li>Import from any of the services below.</li>\n</ol>\n<p>Services reading from npm:</p>\n<ul>\n<li><a href=\"https://www.skypack.dev/\">Skypack</a></li>\n<li><a href=\"https://esm.sh/\">esm.sh</a></li>\n<li><a href=\"https://unpkg.com/\">unpkg.com</a></li>\n<li><a href=\"https://cdnjs.com/\">cdnjs.com</a></li>\n</ul>\n<p>Skypack and esm.sh will actually bundle code from npm into modern ES module syntax. Both of them are\nDeno friendly.</p>\n<p>The beauty with these is that if one of them is failing, or if you're unhappy with the service, you\ncan just switch out the URL imports in your <code>deps.ts</code>.</p>\n<p>Tip: with Skypack and esm.sh (from what I know) you get Typescript types too. esm.sh will do this\nautomatically, and with Skypack you can append a <code>?dts</code> query parameter to the imported URL. See\ntheir respective config query parameters: it's super cool what they can do these days.</p>\n<p>One thing that tripped me up was that it's not always easy to find a suitable entrypoint file when\nimporting via URLs. Deno friendly modules has a <code>mod.ts</code> in the repo somewhere, but often you have\nto hunt down a file yourself.</p>\n<h2>Import maps</h2>\n<p>I've glossed over the technology that is <a href=\"https://github.com/WICG/import-maps\">Import Maps</a>. In my\nown words, I'd say it's a file where you specify from where the source code's <code>import</code> statements\nshould look for the code to be imported. In a way, it's emulating npm's way of looking in\n<code>node_modules</code>, but this is even more powerful.</p>\n<p>If you were annoyed over importing &quot;raw&quot; URLs in the section above, this will save you!</p>\n<p><strong>Import map</strong></p>\n<pre><code class=\"language-json\">{\n    &quot;imports&quot;: {\n        &quot;react&quot;: &quot;https://esm.sh/react@17.0.2&quot;\n    }\n}\n</code></pre>\n<p><strong>Source code</strong></p>\n<pre><code class=\"language-ts\">import React from 'react';\n</code></pre>\n<p>Remember to specify <code>--import-map</code> for <code>deno run</code>! Nothing in Deno is implicit: it won't pick up the\nimport map by itself.</p>\n<h1>Summary</h1>\n<p>My overall impression of Deno that while it's new technology, it's quite mature and well documented.\nAnd if you've got a hairy question, you can pop into their Discord server and ask there. The <code>std</code>\nmodules are very modern in the way they're written (compared to Node, which <em>just</em> got Promise based\nAPIs…). It's actually fun to write Javascript code again. I'd attribute that to the decrease of\n&quot;Javascript fatigue&quot; in Deno, since there are so many built-in modules you'd previously assume you'd\nneed to get from a third party.</p>\n<p><strong>When</strong> (hehe) you install Deno, be sure to do <code>deno help</code> in a terminal to see the range of nice\nsub commands. <code>deno types</code> and <code>deno doc</code> are favourites of mine. <code>deno compile</code> is also cool if\nyou're writing a script which should be run as a self contained executable, suitable for\ndistribution.</p>\n<h1>Appendix: lume</h1>\n<p><a href=\"https://lumeland.github.io/\">lume</a> is a static site generator, built with Deno. I read through the\ndocumentation and jumped around in the source code for a while before I fell in love and ported\njohanbrook.com to it.</p>\n<p>Lume is a joy to work with. The built-in functionality and plugins fill 95% of my use cases – very\nlittle custom code needed. And <em>if</em> I don't understand the documentation, reading the source code is\nno problem.</p>\n<p>It <em>feels</em> easier to use than other generators I've tried (Jekyll, Middleman, Metalsmith, Eleventy)\nbut yet very powerful. During the porting my code I was not too annoyed during the process:\nsomething that you easily get when trying a brand new site generator. The fact that its written in\nTypescript is <em>so</em> nice, as you get static typing and don't have to guess what objects and\nproperties to read.</p>\n<p>Try it out!</p>\n","date_published":"Wed, 19 Jan 2022 00:00:00 GMT"},{"id":"https://johan.im/writings/ios-homescreen-web-app/","url":"https://johan.im/writings/ios-homescreen-web-app/","title":"Customising an iOS home screen web app in 2021","content_html":"<h2>Background</h2>\n<p>During parental leave, I've started to run. Not away from the baby, for heaven's sakes, but regular\nexercise running. I really prioritised keeping it super straight-forward: I refuse wear any kind of\nwearable, such an Apple Watch or Garmin in order to track heart rate and so on (I won't go into why\nhere, I just don't need another tech device). But. Even I see the need for tracking basic stats,\nlike duration, length of run, and average speed. Those are literally the three things I need.</p>\n<p>Let's see what running apps there are! <em>Opens up App Store.</em> &quot;Strava, yes I've heard about that one.\nRunkeeper… that one I've used before! ( = a lifetime ago)&quot;. I installed Strava because it was at the\ntop, and hell begins. It prompts me for an account, which is fair enough I guess, but it still put\nme off a bit. It's also paid. Monthly subscription. And it shows nagging reminders to upgrade to a\npaid plan <em>everywhere</em>. And it has social features, which I of course don't need. It has so much\n<em>stuff</em> I neither need nor want! As a developer on leave, the only sane thing to do is to write my\nown running app.</p>\n<p>Since I'm not a Swift or Objective-C developer (and have no intentions of becoming one), I need to\ndo it as a web app. Approximately 5 seconds after I decided to develop my own running tracker app I\nrealise I really must ensure that this single API is available in the iOS browser: being able to\n<em>watch</em> the GPS position as it changes with the\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API\">Geolocation API</a>. Thank god,\n<code>Geolocation.watchPosition()</code> exists, and a wave of relief is showering over me. That means I can\nwatch the position, stash away the raw coordinates, and do things with them. Such as converting to\n<a href=\"https://geojson.org/\">GeoJSON</a> in order to calculate the length in kilometers and drawing the route\nin an embedded map from Mapbox.</p>\n<ul>\n<li>You can try the final app here: <a href=\"https://runloop.pages.dev/\">runloop.pages.dev</a>. Be sure to add it\nto your homescreen.</li>\n<li>The source code for my app is over <a href=\"https://github.com/johanbrook/runloop\">at GitHub</a>.</li>\n</ul>\n<h2>Apple documentation feels out of date</h2>\n<p>I start out by going straight into the horse's mouth: the Apple documentation on (mobile) Safari.\nThis should be the truth, and nothing but the truth! I head over to\n<a href=\"https://developer.apple.com/\">developer.apple.com</a> and browse to some &quot;Technologies&quot; page where one\ncan input a &quot;technology&quot;. I put in\n<a href=\"https://developer.apple.com/documentation/technologies?tags=Safari\">&quot;safari&quot;</a>. The search results\nonly yield things that are interesting from a native app perspective, such as embedding web views.</p>\n<p>Okay. I scroll around to the footer, and see\n<a href=\"https://developer.apple.com/safari/\">&quot;Safari and the web&quot;</a>. Score! These are the only interesting\nlinks:</p>\n<p><img src=\"https://johan.im/assets/posts/apple-docs-safari.png\" alt=\"Apple docs\"></p>\n<p>Clicking that &quot;More&quot; link leads me to the\n<a href=\"https://developer.apple.com/library/archive/navigation/index.html?filter=safari\">&quot;Documentation Archive&quot;</a>.\nThat sounds nice. Latest change as of writing is in June 2018. Gulp.</p>\n<p>Unless I'm missing something, there's no official Apple documentation on iOS Safari. Except for\nbrowsing through blog posts over at <a href=\"https://webkit.org/\">WebKit.org</a> and other release notes. Note\nthat I'm talking about proprietary Safari tech – not regular Web APIs you'd find over at MDN.</p>\n<p>My next bet was simply googling around on problems as I encountered them.</p>\n<h2>How to make a web app behave and look nicely on iOS 15 in 2021</h2>\n<p>What follows is a stream of things I encountered while researching how to make a super slick iOS web\napp in 2021. My phone is an iPhone 12 mini, and I'm using iOS 15.2 at the time of writing this post.</p>\n<h3>Adding to home screen – don't forget the icon</h3>\n<p>I knew from before that adding a web page to the iOS home screen grants it special privileges. Like\nnot\n<a href=\"https://webkit.org/blog/10218/full-third-party-cookie-blocking-and-more/\">wiping LocalStorage after just 7 days</a>.\nAlso, there's the UX aspect, which is important: adding to the home screen removes the Safari chrome\n(UI) and runs the web app in a frameless mode. This is nice.</p>\n<p>This hasn't changed since last time I looked, thank god. The option is still there in the Safari UI.\nIt'll add use the <code>&lt;title&gt;</code> from your web page as the app title. You need to supply an icon yourself\n(iOS will pick a fugly screenshot of your app otherwise).</p>\n<p>Put this in your <code>&lt;head&gt;</code>:</p>\n<pre><code class=\"language-html\">&lt;link rel=&quot;apple-touch-icon&quot; href=&quot;apple-touch-icon.png&quot;&gt;\n</code></pre>\n<p>where the <code>href</code> attribute points to a PNG image with the icon file.</p>\n<p>Refer to\n<a href=\"https://developer.apple.com/design/human-interface-guidelines/ios/icons-and-images/app-icon/\">Apple's official guide on icons</a>\nfor sizes, since you can control which icon file that goes with which size, like this:</p>\n<pre><code class=\"language-html\">&lt;link rel=&quot;apple-touch-icon&quot; sizes=&quot;152x152&quot; href=&quot;touch-icon-ipad.png&quot;&gt;\n</code></pre>\n<h3>Viewport settings</h3>\n<p>The single most important thing you'd want to do is to set the viewport width to the width of the\ndevice. This is old school, but important:</p>\n<pre><code class=\"language-html\">&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;\n</code></pre>\n<p>If you feel like disabling the pinch-to-zoom behaviour of web pages, tack on an <code>user-scalable=no</code>:</p>\n<pre><code class=\"language-html\">&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, user-scalable=no&quot; /&gt;\n</code></pre>\n<p>For me, I wanted more native feel, so I disabled zoom. Even though it's a bit user hostile. But the\nuser in this case is me, so I don't care.</p>\n<h3>Frameless mode and <code>manifest.json</code></h3>\n<p>The next most important thing is to tell iOS that we'd like to run the web app in &quot;frameless mode&quot;,\nor &quot;without the browser chrome&quot;. Otherwise your home screen web app icon only leads to a web page,\nand thus merely becomes a shortcut. We want it to feel like an app!</p>\n<pre><code class=\"language-html\">&lt;meta name=&quot;apple-mobile-web-app-capable&quot; content=&quot;yes&quot; /&gt;\n</code></pre>\n<p>This still is the way to tell iOS to hide the address bar and all that.</p>\n<p>But. When I clicked around on internal links in my app, I saw the browser chrome appear for every\nlink click! It would suck if Apple had crippled mobile web apps in this way, but I wasn't too\nsurprised after all – this is Apple.</p>\n<p>I started reading about\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/Manifest\">&quot;Web app manifests&quot;</a>. Those manifests is a\nJSON file which tells the browser more things when it runs the app in &quot;PWA&quot; (Progressive Web App)\nmode. I's mainly about customising presentation, such as titles, icons, splash screens, etc. So I\nsort of wrote it off at first, and also thought Apple wouldn't care about these kinds of valiant\nefforts by the web community.</p>\n<p>But I was wrong. I stuck a simple <code>manifest.json</code> in my root directory and linked it from my HTML:</p>\n<pre><code class=\"language-html\">&lt;link rel=&quot;manifest&quot; href=&quot;/manifest.json&quot; /&gt;\n</code></pre>\n<pre><code class=\"language-json\">{\n    &quot;name&quot;: &quot;Runloop&quot;,\n    &quot;scope&quot;: &quot;/&quot;,\n    &quot;display&quot;: &quot;standalone&quot;\n}\n</code></pre>\n<p>I'm not sure whether it was the <code>scope</code> or <code>display</code> parameter that made the internal links work\nwithout chrome again, but this did the trick! iOS Safari <em>is</em> parsing this file after all. And I\nhave no idea why the <code>apple-mobile-web-app-capable</code> tag won't cut it, but oh well. This feels like\nan extra guard to <em>really</em> tell the system that my app is running standalone without any browser\nchrome (&quot;please&quot;).</p>\n<h3>Using the whole screen on iPhone models with notches</h3>\n<p>My iPhone 12 mini has a notch, and is thus not a perfect rectangular display. We can tell the web\napp to use the whole display with this:</p>\n<pre><code class=\"language-html\">&lt;meta name='viewport' content='initial-scale=1, viewport-fit=cover' /&gt;\n</code></pre>\n<p>That is, adding <code>viewport-fit=cover</code> to the <code>viewport</code> meta tag. Otherwise, Safari will play it safe\nand make sure your app lives within a rectangular area far away from the notch.</p>\n<p>Apple is kind and provides tech for us in order to avoid colliding with the notch and the virtual\nhome button at the bottom of the iPhone screen.\n<a href=\"https://webkit.org/blog/7929/designing-websites-for-iphone-x/\">I recommend reading this article</a>.</p>\n<p>Basically, we've got four <code>env()</code> values to use:</p>\n<pre><code class=\"language-css\">env(safe-area-inset-top)\nenv(safe-area-inset-bottom)\nenv(safe-area-inset-left)\nenv(safe-area-inset-right)\n</code></pre>\n<p><code>env()</code> works where <code>var()</code> works – even inside <code>calc()</code>, which is nice. For instance, this is the\nstyling for my bottom <code>NavBar</code> component:</p>\n<pre><code class=\"language-css\">.NavBar {\n  padding: var(--inset);\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  padding-bottom: calc(env(safe-area-inset-bottom) + 10px);\n  padding-left: max(env(safe-area-inset-left), var(--inset));\n  padding-right: max(env(safe-area-inset-right), var(--inset));\n}\n</code></pre>\n<p><code>--inset</code> is set on <code>:root</code>, and is the &quot;global padding&quot; in my app. As you can see, I use it with\nthe <code>max()</code> function to make the left and right padding be whatever's the max value of the safe area\nand my inset.</p>\n<h3>Styling taps on links and buttons</h3>\n<p>Since the arrival of the first iOS (&quot;iPhone OS&quot;?), it's been tricky to style taps on interactive\nelements. Such as a different background on a button when you tap it. <code>:active</code> and <code>:hover</code> pseudo\nselectors are both weird and strangely enough don't manage to produce that native feel.</p>\n<p>In 2021, turns your all you have to is adding a single no-op touch listener, and then you can use\n<code>:active</code> as it's intended to:</p>\n<pre><code class=\"language-js\">// Adding an empty touch listener will make :active CSS pseudo selector\n// work in order to style taps on elements. Joy.\ndocument.addEventListener('touchstart', (evt) =&gt; {});\n</code></pre>\n<p>Insert that snippet somewhere in your JS, and off you go.</p>\n<h3>Making the app be 100% height and don't show scrollbars</h3>\n<p>You thought this was the kind of stuff you'd stop put up with in 2021? Think again. <code>100vh</code> won't do\nwhat you think it does, and Apple devs think it works &quot;as intended&quot;.\n<a href=\"https://chanind.github.io/javascript/2019/09/28/avoid-100vh-on-mobile-web.html\">Read more here</a> for\na demonstration. I almost can't muster strength to explain it all, but the gist of it is that the\nbrowser chrome in mobile Safari is dynamic in height and take up space. This affects the <code>vh</code> unit\nand produces overflow.</p>\n<p><a href=\"https://www.bram.us/2021/07/08/the-large-small-and-dynamic-viewports/\">Dynamic viewports</a> will fix\nthis. But until then, I went with a boring Javascript fix:</p>\n<pre><code class=\"language-ts\">let lastHeight: number | null = null;\n\nconst setAppHeight = debounce(() =&gt; {\n    const doc = document.documentElement;\n    const height = window.innerHeight;\n\n    if (height != lastHeight) {\n        doc.style.setProperty('--app-height', `${height - MAGIC_NUMBER}px`);\n        lastHeight = height;\n    }\n}, 100);\n\n// This is the magic offset which one can subtract in order to hide scrollbars\n// AT LEAST ON MY PHONE. YMMV.\nconst MAGIC_NUMBER = 3;\n\n/** This is solving the STILL outstanding problem of using\n * height: 100vh on Mobile Safari. The problem is outlined here:\n * https://chanind.github.io/javascript/2019/09/28/avoid-100vh-on-mobile-web.html\n *\n * Instead, we control the height of a CSS variable which is mirroring\n * the window.innerHeight property.\n */\nconst fixMobileHeight = () =&gt; {\n    window.addEventListener('resize', setAppHeight);\n\n    setAppHeight();\n\n    return () =&gt; window.removeEventListener('resize', setAppHeight);\n};\n\n// Util\nconst debounce = (func: (...args: unknown[]) =&gt; unknown, wait: number) =&gt; {\n    let timeout: NodeJS.Timeout;\n\n    return (...args: unknown[]) =&gt; {\n        const later = () =&gt; {\n            clearTimeout(timeout);\n            func(...args);\n        };\n\n        clearTimeout(timeout);\n        timeout = setTimeout(later, wait);\n    };\n};\n\nfixMobileHeight();\n</code></pre>\n<pre><code class=\"language-css\">#app {\n  min-height: var(--app-height);\n}\n</code></pre>\n<p>We use the <code>resize</code> event which fires on <code>window</code> to set a CSS variable, which we can use in our\nstylesheet. It has some guards so that we won't fire it too often.</p>\n<h3>Dark mode</h3>\n<p>Don't forget enabling dark mode so Safari can style native elements:</p>\n<pre><code class=\"language-css\">:root {\n  color-scheme: light dark;\n}\n</code></pre>\n<p>This is controllable from a tag within <code>&lt;head&gt;</code> too (which I guess is faster since the browser\ndoesn't have to download and parse the CSS to decide).</p>\n<h3>Theme colours</h3>\n<p>This is new, and very marketed by Apple dev evangelists: the possibility to set the &quot;theme colour&quot;,\nwhich makes Safari use a configured colour of your choice in the browser chrome. Safari is trying to\nbe smart, and defaults to the <code>background-color</code> on your <code>html</code> or <code>body</code> elements, but sometimes\nyou need to set it on your own:</p>\n<pre><code class=\"language-html\">&lt;meta name=&quot;theme-color&quot; content=&quot;#fff&quot; media=&quot;(prefers-color-scheme: light)&quot; /&gt;\n&lt;meta name=&quot;theme-color&quot; content=&quot;#000&quot; media=&quot;(prefers-color-scheme: dark)&quot; /&gt;\n</code></pre>\n<h3>System colours</h3>\n<p>Speaking of colours: dark mode isn't cool, you know what's cool? System colours (that joke fell…). I\nstumbled upon this blog post:\n<a href=\"https://blog.jim-nielsen.com/2021/css-system-colors/\">&quot;CSS System Colors&quot;</a>. The author emphasised\nnot hard coding any colours for light and dark modes. Instead, he lets the system decide from\nsensible defaults. For a website or app without need for any special branding, this is probably what\nyou want.</p>\n<p>But what do you do when you actually want to <em>use</em> one of these system colours elsewhere in your\nCSS? That's the core question in the linked blog post, I'll let you read it.</p>\n<p><em>tldr</em>: there are &quot;system colors&quot; defined in the\n<a href=\"https://drafts.csswg.org/css-color/#css-system-colors\">CSS spec</a>, which you can use like any other\ncolour:</p>\n<pre><code class=\"language-css\">.dropdown {\n  background-color: Canvas;\n}\n</code></pre>\n<p>Of course, there's a bug (?) in iOS, so <code>Canvas</code> backgrounds don't work properly. The blog post\nsuggests using the <code>-apple-system-control-background</code> value as a hack, and it works. Copied from the\npost:</p>\n<pre><code class=\"language-css\">/* Defaults/fallbacks for 1) */\n:root {\n  --color-bg: #fff;\n  --color-text: #222;\n}\n\n/* 1) For browsers that don’t support `color-scheme` and therefore\n   don't handle system dark mode for you automatically \n   (Firefox), handle it for them. */\n@supports not (color-scheme: light dark) {\n  html {\n    background: var(--color-bg);\n    color: var(--color-text);\n  }\n}\n\n/* 2) For browsers that support automatic dark/light mode\n   As well as system colors, set those */\n@supports (color-scheme: light dark) and (background-color: Canvas) and (color: CanvasText) {\n  :root {\n    --color-bg: Canvas;\n    --color-text: CanvasText;\n  }\n}\n\n/* 3) For Safari on iOS. Hacky, but it works. */\n@supports (background-color: -apple-system-control-background) and (color: text) {\n  :root {\n    --color-bg: -apple-system-control-background;\n    --color-text: text;\n  }\n}\n\nhtml {\n  background-color: var(--color-bg);\n  color: var(--color-text);\n}\n</code></pre>\n<p>This worked for me. Now I can use <code>--color-bg</code> wherever I want to use the (dynamic, non hard coded)\nbackground colour.</p>\n<h3>Disabling selecting text</h3>\n<p>This also goes in the &quot;user hostile&quot; department. Use are your own discretion:</p>\n<pre><code class=\"language-css\">html {\n  -webkit-tap-highlight-color: transparent;\n  -webkit-user-select: none;\n  user-select: none;\n}\n</code></pre>\n<h3>Use an iOS-y font stack</h3>\n<p>I went with this, to get the SF font:</p>\n<pre><code class=\"language-css\">font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell',\n        'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;\n</code></pre>\n<h2>Conclusion</h2>\n<p>After all these fixes, my app finally felt pretty good to use on an iPhone. It looked gorgeous in\ndark mode, the typography was great, it felt snappy navigating around, and not like a wEbSiTe at\nall.</p>\n<p>I'm most impressed over how easy it is to make the <em>styling</em> look nice. Before iOS 7, when we were\nin skeumorphism land, it was a pain to make web apps blend into the system. Now it's just some\ntypography, spacing, and default colours, and we've come a long way. If you just &quot;know&quot; how a\ntypical iOS app looks like – with list views, headings and so on – I bet you'll get something that\nlooks decent in no time thanks to the CSS snippets I've posted throughout the text.</p>\n<p>I was most surprised over the show-chrome-on-link-tap thing in the home screen app. I had no idea\none needed to use a Webmanifest JSON file to get rid of that. I've found <em>very little</em> documentation\non iOS' use of the web manifest file too.</p>\n<h3>Nice Web APIs</h3>\n<p>Overall, Web APIs have gone a long way with I/O: we can now upload, download, and <em>share</em> files in\niOS. I built and export and import feature to try this out, and it worked great on mobile:</p>\n<pre><code class=\"language-ts\">const doImport = async (evt: Event) =&gt; {\n    const { files } = evt.target as HTMLInputElement;\n\n    const file = files[0];\n\n    if (file.type != 'application/json') {\n        alert('Only JSON files, please.');\n        return;\n    }\n\n    try {\n        const json = JSON.parse(await file.text());\n        // do stuff with object\n    } catch (ex) {\n        console.error(ex);\n        alert(`Failed to read &quot;${file.name}&quot;. Reason: ${ex}`);\n    }\n};\n\ndocument.findElementById('import')!.addEventListener('change', doImport);\n</code></pre>\n<pre><code class=\"language-html\">&lt;input type=&quot;file&quot; id=&quot;import&quot; accept=&quot;application/json&quot; /&gt;\n</code></pre>\n<p>Exporting works good with the\n<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share\">Share API</a>:</p>\n<pre><code class=\"language-ts\">const doExport = async () =&gt; {\n    try {\n        // Will show native iOS share pane\n        await navigator.share({\n            title: 'Run data as JSON',\n            files: [fileOf(appConf)],\n        });\n    } catch (ex) {\n        if ((ex as DOMException).name == 'AbortError') return;\n        alert(`Sharing failed. Reason: ${(ex as Error).message || ex}`);\n        console.error(ex);\n    }\n};\n\nconst fileOf = (data: unknown): File =&gt;\n    new File([JSON.stringify(appConf, null, 4)], 'runloop.json', {\n        type: 'application/json',\n    });\n</code></pre>\n<p>The user now gets the choice of saving the file somewhere, or sending it with the native UI\ncontrols.</p>\n<h2>Epilogue</h2>\n<p>The irony is that my running tracker app didn't work <em>at all</em> out in the wild… Turns out that the\nsystem turns off any background geolocation services when the screen is locked – which totally is\nthe case when I'm running. And there's no Geolocation in Service Workers or similar background magic\nplace. Argh.</p>\n<p>See it in action here: <a href=\"https://runloop.pages.dev/\">runloop.pages.dev</a>.</p>\n","date_published":"Tue, 14 Dec 2021 00:00:00 GMT"},{"id":"https://johan.im/writings/better-spaghetti-bolognese/","url":"https://johan.im/writings/better-spaghetti-bolognese/","title":"An Even Better Spaghetti Bolognese","content_html":"<p>This is a continuation (sequel? remix?) on the post\n<a href=\"https://johan.im/writings/my-spaghetti-bolognese\">&quot;My Spaghetti Bolognese&quot;</a>. In that one, I wrote about a spaghetti\nbolognese recipe which I thought I'd, pretentious as I am, perfected over the years.</p>\n<p>We recently spent a month in Florence, Italy, where we stayed with a host family. For one birthday\nparty for their grandchild, the family father had made a ragú sauce served with penne pasta. The\nsauce was amazing: rich, juicy, and smooth. I asked for the recipe, and will present it in this\npost.</p>\n<h2>The ingredients</h2>\n<ul>\n<li>1-2 finely chopped garlic cloves.</li>\n<li>500g of minced pork and beef meat.</li>\n<li>1-2 celeries.</li>\n<li>1-2 carrots.</li>\n<li>1 onion (preferrably red).</li>\n<li>750g passata (tomato sauce). I ended up adding 1200g of passata since I wanted a saucier feeling.</li>\n<li>1 glass red wine.</li>\n<li>Sugar (optional).</li>\n<li>Meat broth (optional).</li>\n<li>Plenty of olive oil.</li>\n<li>Salt and pepper.</li>\n</ul>\n<p>For the celery, carrot, and onion: the individual units aren't as important as the ratio between\nthem. The recipe I received said: &quot;The same amount of celery and onion, a little less carrot&quot;.</p>\n<p>The amount of olive oil is something one needs to freewheel. I usually go with covering the whole\npot with almost one centimeter of oil (depending on the size of pot, of course). There's a lot of\nfat coming from the pork part in the meat, so beware: <em>that</em> much oil might not be required.</p>\n<h2>The steps</h2>\n<ol>\n<li>Fry the garlic in a pot or deep pan with plenty of olive oil. Garlic should be added when the oil\nis hot.</li>\n<li>Add the meat, and brown it well.</li>\n<li>When the meat is well cooked, add a finely chopped mixture of celery, carrots, and onion.</li>\n<li>When the mixture is cooked, add the passata. Add salt to taste, as well as some ground pepper.</li>\n<li>Wait for the sauce to boil, and add a glass of wine. Wait for it to evaporate completely.</li>\n<li>Cook over very low heat for at least 30 minutes. If the sauce is too acidic, add a teaspoon of\nsugar. If it's too dry, add a little meat broth.</li>\n</ol>\n<p>(I've never needed meat broth in this recipe. There's just no way I've managed to get it too dry.)</p>\n<p>You can let it sit on the stove without a lid for a couple of hours if you'd like. Or put it on very\nlow heat in the oven (around 100 degrees celsius in my convection oven seemed fine over 5 hours of\ncooking). I'm not actually sure what the benefits with the oven are – perhaps the sauce becomes\ndifferent if you heat it from all directions? Who knows.</p>\n<p>When serving with pasta, don't forget to add around a deciliter of pasta water to the sauce at the\nend. It &quot;really ties the sauce together&quot;, as they say. Parmesan or pecorino is nice to offer too.</p>\n<p><strong>Done.</strong></p>\n<h2>Differences from the other recipe</h2>\n<ul>\n<li>50/50 pork and beef instead of 100% beef. The 50/50 mix makes for a more fatty and tasty sauce,\nthanks to the pork.</li>\n<li>Cooking the onion, carrots, and celery in the meat instead of sautéing them. This felt kind of\nweird to me first, since <em>all</em> recipes I read say that you should fry the onion, garlic, carrot,\nand celery in the pot before adding the meat. I'm not sure about the difference.s</li>\n<li>Use of more olive oil.</li>\n<li>Use of meat broth (if needed).</li>\n</ul>\n<p>This recipe felt simpler but still as good too, which I think should be the goal in cooking. The\nother recipe has ten steps, this one only has six steps.</p>\n","date_published":"Tue, 02 Nov 2021 00:00:00 GMT"},{"id":"https://johan.im/writings/recently-in-books-ii/","url":"https://johan.im/writings/recently-in-books-ii/","title":"Recently in books II","content_html":"<p>This is a long overdue post on some books I've read since the\n<a href=\"https://johan.im/writings/recently-in-books\">last update</a>.</p>\n<h2>&quot;Ishmael&quot; by Daniel Quinn</h2>\n<p>My father in law borrowed me this one, not without a glimpse in his eye. It's hard to describe this\nnovel. It's not what it seems to be in the first few pages, which is about a man who starts talking\nwith a gorilla via telepathy. The bulk of the novel is the philosophical conversation between the\nodd couple, where the gorilla acts as the teacher for the man, who acts as narrator.</p>\n<p>My immediate thoughts about this book are these:</p>\n<ol>\n<li>It's <em>really</em> &quot;on topic&quot; right now (year 2020).</li>\n<li>It's eye opening, challenging, provoking, and story telling.</li>\n</ol>\n<p>For the first point: one of the book's core themes is around planet Earth – the environment and how\nwe humans are ruining it. Whereas other books in the climate genre is a lot of numbers and <em>facts</em>,\n&quot;Ishmael&quot; tells a different, more philosophical, story.</p>\n<p>The second point: the book does exactly what (I think) a philosophical novel should do. It taught me\nthings and how to see myself, my culture, and whole of humanity and its history in a different\nlight. I knew already that our modern culture – capitalist and infinte-growth aspiring – isn't\nviable and sustainable. &quot;Ishmael&quot; confirms those thoughts by anchoring them in a spiritual and\ncultural arguments, using terms as <em>Myths, Stories, and Cultures</em>.</p>\n<p>The book affected me in the sense of reiterating that <em>Balance is everything</em>. Humans have messed up\nthat ecological balance in nature, by telling ourselves we're <em>above</em> the laws of nature, and that\nwe possess the power of deciding over &quot;who's to die, and who's to survive&quot;.</p>\n<p>If you can bare with the kind of long introductory part, I'd really recommend getting through it.\nPair it up with the popular science piece &quot;Sapiens&quot; for a full picture.</p>\n<h2>&quot;Cosa Nostra&quot; by John Dickie</h2>\n<p>A non-fiction book about the Sicilian mafia - the Cosa Nostra.</p>\n<p>I had a real &quot;mobster Spring&quot; where I went through a couple of mafia movies and books (this and the\nnext one I write about below). Am I getting this old already?! I like good non-fiction books, and\nthis one was good. It's essentially about how the mafia grew from local gangs in Sicily in the\n1800s, into a loose but worldwide organisation in the 1900s.</p>\n<p>It's a fascinating read if you're that kind of person. Note that the author focuses mostly on the\nSicilian mafia, and not the American offspring that was born in the early 1900s. Perfect vacation\npaperback read, I'd say.</p>\n<h2>&quot;The Godfather&quot; by Mario Puzo</h2>\n<p>Here we go. The absolute number one piece of mafia literature.</p>\n<p>I've seen the movie(s) countless of times, but still enjoyed the book <em>a lot</em>. That's because Puzo's\nlanguage and skill in writing a captivating plot is outstanding. Everything is intense: the\ndialogue, the characters, the situations.</p>\n<p>It, naturally, does a better job telling the backstories of the characters of the Corleone crime\nfamily than the movies. I'm usually a sucker for the fates of &quot;anti heroes&quot;, such as Michael\nCorleone: about their early innocence, ascent to something they did not anticipate, and final fall\nfrom their throne (this is not pictured in &quot;The Godfather&quot;).</p>\n<p>In the end, what fascinates me with Puzo's work is his way of creating emotional bonds between the\nreader and the characters (while you <em>know</em> they're bad!) but in an ice cold way describe horrible\nfates and acts.</p>\n<h2>&quot;Herakles&quot; by Theodor Kallifatides</h2>\n<p>The author is born in Greece but now lives and works in Sweden. The book is a fiction novel about\nthe Greek hero Hercules (&quot;Herakles&quot; in Swedish). I think everybody knows the core story, from the\nDisney movie or from the origin myth, in one way or another. This book is more detailed, dramatised\nversion of the original story about the hero's adventures.</p>\n<p>I've always loved reading about religion and myths. I recall revisiting a factbook about Greek\nmythology my parents had when I was little, so all the names are stuck with me.</p>\n<p>The book focuses on Hercules' birth, upbringing, adventures, and death – an all the sorrow and\ntragedies therein. Greek mythology is full of tragedy! So when you read about our hero, there are a\ncouple of moments of &quot;Goddammit Hercules, now you <em>really</em> screwed up!&quot;. And he screwed up <em>a lot</em>.</p>\n<p>I liked the personal tone the author writes in. The style is modern but serious. Howver, it still\ncontains that sterile prose in the way that these old myths should be told in. &quot;Oh, Hercules beat\nsomebody to death with his bare hands. No big deal, carry on&quot;. But &quot;Herakles&quot; manages to go beyond\nthe regular death and violence in the myth, and add some everyday empathy for our hero. And that, I\nappreciate: some nuance.</p>\n<p>In the end, it's a good story.</p>\n<h2>&quot;Normal People&quot; by Sally Rooney</h2>\n<p>A book praised by critics, winner of great awards, made into television series. &quot;Normal People&quot; is\nabout a guy (Connell) and a girl (Marianne) in a high school in Ireland. They develop a non-trivial\nromantic and physical relationship, and we get to follow them over the years they're together and\napart.</p>\n<p>I like the very boiled down stories in these kinds of plots. The variations are usually infinite,\nand the quality of the work is determined by the prose and flow in the text. Sally Rooney writes\nwonderfully. The core plot of &quot;boy and girl like each other but it's complicated&quot; is taken care of\nvery delicately. As mentioned, everything is very boiled down, and the text follows both Connell and\nMarianne in their thoughts. The pacing is good, as a new chapter might bring a jump over a few years\nin their lives.</p>\n<p>The author manages to capture That Feeling that occurs in romantic relationships in the ages 18-30.\nOn the inside, you're ready to explode by a broken heart, but on the outside it's &quot;Oh god, why do\nyou kids make it so complated?! Just talk to her/him!&quot;. Stuff in &quot;Normal People&quot; <em>is</em> complicated.\nRooney brings that forward, drags it out, and makes sure that the characters themselves don't know\nwhat they want over the course of the novel.</p>\n<p>There's also darkness in the shapes of abusive relationships, tragic family history, social class\nissues, depression, jealousy, drugs, and alcohol. The whole buffet of adolescent troubles, that is.\nThe text treats these subjects in a very cold and objective manner. They are slowly appearing\nthroughout the storyline, like bad mold spots in a cheese.</p>\n<p>I enjoyed this book. It doesn't bring anything new to the table, but it doesn't have to. The prose\nand the strong characters in Connell and Marianne do enough.</p>\n<p>(I actually watched the TV series before reading the book, and the former does a pretty good job\ncapturing the bleakness and desperation from the book. The acting and camera in the series are\nterrific.)</p>\n<h2>&quot;About A Boy&quot; by Nick Hornby</h2>\n<p>I think most people have seen the film, but now I got around reading the book.</p>\n<p>It's good. It's fun. It'll entertain you for some days. It's got darkness coupled with absurdity,\nall tied together in weird conversations and thought patterns of the main characters. The\nBritishisms in Nick Hornby's language are everywhere.</p>\n<p>I don't think I have anything more to say.</p>\n<p>(Hugh Grant literally <em>is</em> Will Freeman to me.)</p>\n<h2>&quot;Jag Kan Ha Fel&quot; by Björn Natthiko Lindeblad</h2>\n<p>(This is a Swedish book 🇸🇪.)</p>\n<p>Björn dropped out of a brilliant career in economics in his mid-twenties and became a Buddhist monk\nin the jungles of Thailand. He stayed a monk for 17 years. This book is about his time as a monk,\nand what happened afterwards. Like raisins in the cake, he mixes in quotes, conversations, and\nthoughts from himself and Buddhist friends. To be honest, I came for &quot;the wisdom&quot;, but was touched\nby the author's story.</p>\n<p>Björn received some help in writing the book, and the text is very tender, personal, and humorous.\nBjörn has a lot of humour! This is also my first real look into a Buddhist monastery environment,\nand it's very enlightening (pun intended). Björn's story gave me a human insight into the Buddhist\nmonk lifestyle and daily life. He attended both Western and Thai monasteries while in Thailand, and\nlater moved to British and Swiss monasteries. It was really interesting to hear about the mix of\ndifferent people in the Thai monasteries: they are very diverse. Both culture wise, but also in\npersonalities, as some people really aren't doing the hardcore, stereotypical monk thing. They're\njust there because they had nothing else to do.</p>\n<p>The story is also personal, as it describes how Björn and his family dealt with the passing of his\ndad (by euthanasia). It continues with Björn finding love, and ultimately about his own fate in\ngetting the diagnose of the ALS disease.</p>\n<p>Everything in this book is <em>so</em> human. It touches upon a lot of stages in life, and thanks to that\nconcerns us all. Like a universal book in a very light hearted but well put language. The author\nisn't out for doing some self-help Buddhist thing aimed at Western readers. It's his own life where\nhe shares his thoughts, fears, and experiences. It is what it is.</p>\n<p>(For Swedes, I recommend <a href=\"https://sverigesradio.se/avsnitt/1518766\">Björn's talk in &quot;P1 Sommar&quot;</a>\nfrom June, 2020.)</p>\n","date_published":"Thu, 31 Dec 2020 00:00:00 GMT"},{"id":"https://johan.im/writings/frp-app-arch/","url":"https://johan.im/writings/frp-app-arch/","title":"Building a small, functional reactive app architecture","content_html":"<p>At <a href=\"https://lookback.io/\">Lookback</a>, we've fallen in love with functional reactive programming (FRP)\nwith streams in our frontend apps. Together with the use of Typescript for compile time type safety,\nwe've seen a tremendous bump in overall stability and fewer runtime bugs. Actually, I dare to say\nthat <em>all</em> of our bugs so far have been either logic (programmer) or timing errors.</p>\n<h2>What this text is and what it's not</h2>\n<p>We'll look at how <em>easy</em> it actually is to build these kind of frontend architectures on your own.\nThis architecture is, to be clear, <em>not</em> any new or novel idea at all. As you will read below, it's\nessentially a rip-off of a library called CycleJS, but less general and made to work with React as a\nview before CycleJS had proper React support.</p>\n<p>What we'll go through is how one can reason about state, side effects, and drawing the view with the\ndata structure streams. In the end, we have the complete library.</p>\n<p><strong>I'll assume knowledge about streams in this post.</strong> With &quot;streams&quot;, I don't mean the\n<a href=\"https://nodejs.org/api/stream.html\">NodeJS Stream API</a>, but the functional streams popularised by\nlibraries such as RxJS, BaconJS, and xstream. The xstream library will be used for reactive streams,\nbut the concepts are applicable to any streams implementation with the basic operations. I will also\nuse Typescript features to model the architecture.</p>\n<p>An architecture based on functional reactive stream isn't for all frontend apps. Vanilla React\npaired with the Context API a reducer is probably fine in most cases. We use FRP in our Live player,\nand in our Chrome extension. Both codebases need to handle the complexities of multi-peer\naudio/video streaming, fetching data from a GraphQL API, client state, server state, connection\nproblems, interrupts, problems with the mic and camera, subscribing to server data. Even with\nTypescript, I wouldn't want to model that in a Flux based React application. FRP has helped us\nhandle the data flows in a concise manner across the app, with the help from cozy declarative\nconstructs as <code>map</code>, <code>filter</code>, and so on. It's pretentious to say, but I almost feel &quot;the code\nwrites itself&quot; when building out the streams for the data flows.</p>\n<h2>The code</h2>\n<p><strong>This is not some kind of new framework.</strong> Many others already exist. The repository linked below\nis solely for demonstration, and to hold the final code:</p>\n<p class=\"tc\">\n  <a href=\"https://github.com/lookback/frap\" class=\"btn\">✨ lookback/frap on GitHub</a>\n</p>\n<ul>\n<li><em>frap</em> is for <strong>F</strong>unctional <strong>R</strong>eactive <strong>Ap</strong>plication.</li>\n<li>🔨 ~20 Kb minified.</li>\n<li>📉 Has a single dependency (the <code>xstream</code> library).</li>\n<li>🏄‍♂️ The core API consists of two functions.</li>\n<li>🤝 Agnostic about the view, but assumes a stream based application.</li>\n</ul>\n<h2>Why?</h2>\n<p>For me personally, it was all about the joy of constructing an architecture I could understand the\nsmallest parts of, and then extracting it to make it general.</p>\n<p>It also felt good not using a 3rd party package, except for <code>xstream</code>, to solve a thing.</p>\n<h2>Credits</h2>\n<p>The main brain behind the architecture is my colleague <a href=\"https://twitter.com/algstn\">Martin</a>. He was\nthe drive behind the functional patterns as we pair programmed to build the architecture for\nLookback's Live player. The extraction and generalisation was made by me. As mentioned, the\nextraction and this post serves as a learning experience for myself too.</p>\n<h2>Background</h2>\n<p>We do make use of <a href=\"https://cycle.js.org/\">CycleJS</a> in one of our web clients. CycleJS introduced the\nconcept of cyclical streams and <em>drivers</em> for side effects for us. Go ahead and read about all its\nfeatures on the website. It was a bit daunting for me in the beginning to &quot;think in cyclical\nstreams&quot;, but a few months in I'm happier than ever building a single page client app.</p>\n<p>I recommend reading these texts on streams and reactive programming:</p>\n<ul>\n<li><a href=\"https://cycle.js.org/streams.html\">&quot;Streams&quot; on CycleJS.org</a></li>\n<li><a href=\"https://gist.github.com/staltz/868e7e9bc2a7b8c1f754\">&quot;The introduction to Reactive Programming you've been missing&quot;</a>\nby André Staltz, creator of xstream and CycleJS.</li>\n<li><a href=\"https://futureofcoding.org/papers/comprehensible-frp/comprehensible-frp.pdf\">&quot;Explicitly Comprehensible Functional Reactive Programming (pdf)&quot;</a></li>\n</ul>\n<p>Have a look at the CycleJS documentation and guides. Then let's see why we decided to <em>not</em> go with\nCycleJS for a new single page app.</p>\n<h3>Differences in drawing a DOM</h3>\n<p>Out-of-the-box, CycleJS uses <a href=\"https://github.com/snabbdom/snabbdom\">Snabbdom</a> – a virtual DOM\nlibrary – to build your app's HTML and insert into the browser. CycleJS supports\n<a href=\"https://cycle.js.org/components.html\">components</a>, i.e. reusable functions that emit a DOM and take\nprops.</p>\n<p>A component in CycleJS/Snabbdom might look like this:</p>\n<pre><code class=\"language-typescript\">import xs from 'xstream';\nimport { div, input, span } from '@cycle/dom';\n\nfunction MyComponent(sources) {\n    // Incoming DOM from the outside:\n    const domSource = sources.DOM;\n\n    // Stream of new text values from our &lt;input&gt; element\n    const newValue$ = domSource\n        .select('.input') // The &lt;input&gt; has class=&quot;input&quot;\n        .events('input') // Listen to `input` events\n        .map((ev) =&gt; ev.target.value); // For each input, grab the `value`\n\n    // Build a stream of state, which looks like:\n    //  Stream&lt;{ value: string }&gt;\n    const state$ = newValue$.map((value) =&gt; ({ value })).remember(); // Remember last value\n\n    // Render out the UI from our state using Snabbdom. This is\n    // a virtual DOM implementation, and we build the structure\n    // using Hyperscript.\n    const vdom$ = state$.map((state) =&gt;\n        div([\n            span(state.value),\n            input('.input', {\n                attrs: { type: 'text' },\n            }),\n        ])\n    );\n\n    // Finally, return our DOM to the outside, along with the\n    // values from our &lt;input&gt;\n    return {\n        DOM: vdom$,\n        value: state$.map((state) =&gt; state.value),\n    };\n}\n</code></pre>\n<p>The DOM flows through the component as a <em>stream</em>. Compare this with a React component where you\nreturn the virtual DOM as a lump of JSX:</p>\n<pre><code class=\"language-tsx\">import React, { useState } from 'react';\n\nfunction MyComponent() {\n    const [text, setText] = useState&lt;string&gt;('');\n\n    return (\n        &lt;div&gt;\n            &lt;span&gt;{text}&lt;/span&gt;\n            &lt;input\n                type='text'\n                defaultValue={text}\n                onInput={(evt) =&gt; setText(evt.target.value)}\n            /&gt;\n        &lt;/div&gt;\n    );\n}\n</code></pre>\n<p>The React component <em>probably</em> looks more straight forward to most people than the CycleJS\ncomponent, I imagine. It's because it's <em>imperative</em>. We use <code>setText</code> and perhaps <code>this.setState</code>\nin React components – a concept that doesn't exist in CycleJS's world. In CycleJS, something needs\nto &quot;pull&quot; the values through the streams through the component. Streams are, aptly, flowing through\nthe whole app.</p>\n<h3>Building our own</h3>\n<p>I think the Snabbdom way of building markup is interesting. It encourages me to think about my\nfrontend code as functions even more (JSX sort of hides that away). For a rewrite of our Live\nplayer, we decided we wanted to use React for the view, instead of doing full CycleJS/Snabbdom\nagain. This was before <a href=\"https://github.com/cyclejs/react\">@cycle/react</a> was released, so we set out\nto fully ditch CycleJS for this rewrite and figure out how to make business logic in streams play\nwell with React for the view.</p>\n<p>The choice of React for the view was partly due to some odd quirks in how CycleJS handles DOM\nevents, and partly due to the nice React ecosystem. Typescript and React go perfect together too,\nmaking for robust view components.</p>\n<p>In our new architecture, we wanted to keep these concepts from CycleJS:</p>\n<ul>\n<li>All business logic as reactive streams.</li>\n<li>Handling side effects in Drivers, making for a &quot;pure&quot; main application.</li>\n</ul>\n<p>We wanted to get rid of:</p>\n<ul>\n<li>Replace the DOM-as-a-stream and Snabbdom rendering with React.</li>\n</ul>\n<p>We also wanted to include:</p>\n<ul>\n<li>Storing the whole app state as a central atom and draw the whole user interface based on that. Of\ncourse very common in the React world these days.</li>\n</ul>\n<p>Let's begin!</p>\n<h2>Table of Contents</h2>\n<ol>\n<li>State &amp; data flow</li>\n<li>State updates</li>\n<li>Sending messages</li>\n<li>The view</li>\n<li>Side effects</li>\n</ol>\n<h2>State &amp; data flow</h2>\n<p>How to manage state in frontend applications has turned out to be a hot topic. What is app state\nanyway? It might be:</p>\n<ul>\n<li>An ID string of the currently signed in user.</li>\n<li>An array of blog posts.</li>\n<li>A boolean indicating if a modal is open or not.</li>\n<li>An enum for the current state in a state machine.</li>\n</ul>\n<p>And so on. The basic idea is that we should be able to <strong>draw the whole interface from this state</strong>.\nSometimes, using local state in components is fine. This might be state such as the active tab in a\ntab system, which is very local, and <em>probably</em> doesn't concern any other parts of the system.</p>\n<p>Redux popularized the Flux architecture's idea of state as &quot;single source of truth&quot;. We shouldn't\nscatter the state across DOM nodes, localStorage, the server, and so on. Also Elm and Om are great\ninspiration for state handling in client side apps. I encourage you to read the\n<a href=\"https://redux.js.org/introduction/motivation\">philosophies and principles of Redux</a>.</p>\n<p>A state atom might look like this:</p>\n<pre><code class=\"language-typescript\">const state: State = {\n    name: 'Johan Brook',\n    showModal: true,\n};\n</code></pre>\n<p>From this, we should be able to draw the full app component tree. And if we'd draw it again from the\nsame state, the app's UI can't change fundamentally.</p>\n<hr>\n<p>A core principle of functional programming is immutability – the inability to change a state after\nit's created. We'd like our app state to work the same. Meaning, we can't just &quot;set a property in\nthe state&quot; like it's the Wild West. We need to update properties incrementally and generate a &quot;new&quot;\nstate. For each of these state updates, the view should re-draw.</p>\n<p>In order to update the <code>name</code> in our state, we can design the flow like this:</p>\n<ol>\n<li>Construct your update to the state atom. In this case <code>{ name: 'John Doe' }</code>.</li>\n<li>Send the update as a stream to a function which folds it together with the state stream:</li>\n</ol>\n<pre><code class=\"language-typescript\">const state$ = stateUpdate$.fold(\n    (prev, update) =&gt; ({ ...prev, ...update }),\n    startState,\n);\n</code></pre>\n<p>The xstream function <a href=\"http://staltz.github.io/xstream/#fold\"><code>fold</code></a> is very handy to learn here.\nThat's the amazing function which creates our whole incremental state! The update effectively\nextends the existing state object to form a new one.</p>\n<p>So we've got a <code>state$</code> variable containing the <em>stream of states</em>. It's very important to\ninternalise that the &quot;stream of states&quot; here isn't a continuous stream, but a discrete one. It's a\nlike a string with ants, where each ant is a new state, and they can come in irregular patterns. The\nidea is to let the view listen to this <code>state$</code> stream, which will behave like this:</p>\n<pre><code>stateUpdate$ = ---------- update: { name: 'Johnny Doe' }----\n\nstateUpdate$.fold(..., startState)\n\nstate$ = ---{ name: 'Johan Brook' }--{ name: 'Johnny Doe' }-\n</code></pre>\n<p>For each new element in the resulting <code>state$</code> stream, we'll re-render the whole app (read more\nbelow about how we'll manage the view).</p>\n<p>So what are these state updates? It's ✨<strong>your application</strong> ✨! That's right: all business logic\nwill either result in state updates or side effects (read more about that in the section about\nDrivers below).</p>\n<p>This can be expressed roughly like this (with xstream):</p>\n<pre><code class=\"language-typescript\">import { Stream } from 'xstream';\n\ninterface State {\n    name: string;\n    showModal: boolean;\n}\n\n// Our app just returns a new `name` instantly, but here\n// we would render our entire app as React components or similar.\nconst app = (state$: Stream&lt;State&gt;) =&gt; {\n    return state$.map((state) =&gt; ({\n        name: 'Mary',\n    }));\n};\n\nconst run = (main: Main, startState: State) =&gt; {\n    // Create an incrementally updated stream of state\n    // XXX Fix stateUpdate$\n    const state$ = stateUpdate$.fold(\n        (prev, update) =&gt; ({ ...prev, ...update }),\n        startState,\n    );\n\n    // Main app function, renders UI from state$ stream\n    main(state$);\n};\n\n// Kick off! 🚀\nrun(app, { name: 'Johan', showModal: false });\n</code></pre>\n<p>Sharp eyed readers notice that <code>stateUpdate$</code> is appearing out of nowhere. That's supposed to come\nfrom the app function, right?! Here's what the &quot;cyclical&quot; in CycleJS comes in: we need to cycle back\nthe state updates from our app up to the <code>fold</code> operation. Luckily, the xstream library has an\n<a href=\"http://staltz.github.io/xstream/#imitate\"><code>imitate</code></a> method on a stream which makes it possible to\ncreate a fake stream at the top of a function, run operations on it, and then let it imitate a\n&quot;real&quot; stream further down the file. This allows circular dependency of streams.</p>\n<p>Let's fix our code:</p>\n<pre><code class=\"language-typescript/5,12-17/\">import xs from 'xstream';\n\nconst run = (main: Main, startState: State) =&gt; {\n  // Create &quot;fake&quot;, empty update stream\n  const fakeUpdates$ = xs.create();\n\n  const state$ = fakeUpdates$.fold(\n    (prev, update) =&gt; ({ ...prev, ...update }),\n    startState\n  );\n\n  const appUpdate$ = main(state$);\n\n  // Imitate the real state update stream - results are\n  // cycled back to the .fold operation above!\n  fakeUpdates$.imitate(appUpdate$);\n\n  return state$;\n};\n</code></pre>\n<p>-&gt; <a href=\"http://staltz.github.io/xstream/#create\">Docs on <code>xs.create</code></a></p>\n<p>We've successfully achieved feeding our app with a stream of state, and made the output stream of\nthe app update the state! 🎉 This creates a <code>main</code> function signature of:</p>\n<pre><code class=\"language-typescript\">type Main = (state$: Stream&lt;State&gt;) =&gt; Stream&lt;Partial&lt;State&gt;&gt;;\n</code></pre>\n<p>Thus, state management is ticked off. You just need to provide the <code>main</code> function which is your\nwhole app logic.</p>\n<p>Takeaways:</p>\n<ul>\n<li>We update our state with updates via a stream.</li>\n<li>Our main app function <em>takes a state stream</em> and <em>returns an update stream</em>.</li>\n<li>The state is thus incrementally updated.</li>\n<li>The view is re-rendered each time the state updates.</li>\n</ul>\n<h2>Ch..ch..changes … (to the state)</h2>\n<p>Let's explore the <code>run</code> function from the earlier example. This code below demonstrates how you\nwould use it in an app. The <code>run</code> function is thus an export of our library:</p>\n<pre><code class=\"language-typescript\">// run :: (Main, State) -&gt; Stream&lt;State&gt;\nimport { run } from 'frap';\n\ninterface State {\n    name: string;\n}\n\nconst startState: State = {\n    name: 'Johan',\n};\n\n// Our app's business logic, packaged in a single function.\n// Receives state stream and should return a stream of updates\n// to the state.\n// app :: (Stream&lt;State&gt;) -&gt; Stream&lt;Partial&lt;State&gt;&gt;\nconst app: Main = (state$: Stream&lt;State&gt;) =&gt; {\n    const stateUpdate$ = xs.create();\n\n    return stateUpdate$;\n};\n\n// Kick it off! 🚀\nrun(app, startState);\n</code></pre>\n<p>That <code>app</code> function is basically everything there is to it! (almost… we just need to sort out the\nview rendering and handle side effects). We receive state, do stuff deriving off of it, and return\nour preferred updates.</p>\n<p>An example could be:</p>\n<pre><code class=\"language-typescript/2-5/\">const app: Main = (state$: Stream&lt;State&gt;) =&gt; {\n  const stateUpdate$ = state$.map((state) =&gt; ({\n    name: state.name.toUpperCase(),\n  }));\n\n  return stateUpdate$;\n};\n</code></pre>\n<p>-&gt; <a href=\"http://staltz.github.io/xstream/#map\">Docs on <code>map</code></a></p>\n<p>This little app of ours would instantly update the <code>name</code> property in our state atom to uppercase:</p>\n<pre><code>--- { name: 'Johan' } ---\n  app()\n--- { name: 'JOHAN' } ---\n</code></pre>\n<p>Now, this seems silly and simplistic. I thought so too. &quot;How can I ever achieve complex app logic\nwith this?!&quot;. Turns out you can. By using the stream operators of xstream on your data, you really\n<em>can</em> achieve crazy things. It all adds up. For me, it was all about separating the big state down\ninto small functions taking care of &quot;their&quot; domain, and then merging it all together:</p>\n<pre><code class=\"language-typescript\">// Functions we've written to take care of stuff in our data model.\n// We don't care how they do it – as long as their return a stream\n// of state updates.\nimport { nameUpdate, posts } from './lib';\n\nconst app: Main = (state$: Stream&lt;State&gt;) =&gt; {\n    const nameUpdate$ = nameUpdate(state$);\n    const postsUpdate$ = posts(state$);\n\n    // All derived state updates off of existing state\n    return xs.merge(nameUpdate$, postsUpdate$);\n};\n</code></pre>\n<p>-&gt; <a href=\"http://staltz.github.io/xstream/#merge\">Docs on <code>xs.merge</code></a></p>\n<p>One important aspect here is the <em>cyclical</em> aspect of our app architecture. Notice how the state\nstream is constantly giving us new state as elements in the stream. Our <code>app</code> function is merely a\ntransformer along the way, returning state updates as sinks and receives the new state as source:</p>\n<pre><code>------a---ax---ax------\n  app() # Transforms the source stream\n------ax--ax---axy-----\n</code></pre>\n<p>Once you're used to &quot;thinking in cycles&quot;, it creates quite a nice way of programming even complex\napps, since the pattern is very scalable. You'll be thinking in &quot;inputs and outputs&quot;, and solely how\nyou will transform the inputs to a given output.</p>\n<p>But derived state ain't no fun. In a real app, we've got lots of inputs! Mouse clicks from the user,\nasync calls coming back from web APIs – a myriad of things that should update our state. Let's\ninvestigate the former!</p>\n<h2>Sending -&gt; Messages</h2>\n<p>Any app must deal with user input. Button clicks, text fields, forms, and so on. As our app\narchitecture looks so far, there's only derived state updates. Meaning, we only transform the state\nwe have already.</p>\n<p><strong>We need to construct a way to let the view pass messages to our app function.</strong></p>\n<p>We haven't looked at the view yet, but remember it's <strong>outside</strong> our pure, cozy, functional world\ninside of our app function. In the app function, we solely deal with functional streams which we\napply <code>map</code>, <code>filter</code> and other operations on.</p>\n<p>When I say <em>messages</em>, I refer to something like <em>signals</em> or <em>events</em> that are emitted from the UI\nelement the user interacted with. We need two things in these messages:</p>\n<ol>\n<li>An identifier in order to distinguish between different kinds of messages.</li>\n<li>An optional payload with data attached to the message.</li>\n</ol>\n<p>Let's see how we can get those messages into our app function!</p>\n<p>We've modelled data as streams so far, so why not continue on that track. Imagine a <code>view$</code> stream\nwhich is a stream of <em>all</em> different kinds of messages – user input – coming from the view.</p>\n<p>I imagine this flow being something like this:</p>\n<figure id=\"view-model\">\n  <img width=\"413\" alt=\"Messages flow\" src=\"https://johan.im/assets/posts/frap-messages.png\" />\n  <figcaption>Simplified flow diagram.</figcaption>\n</figure>\n<p>How does a message look like then? Perhaps like this:</p>\n<pre><code class=\"language-typescript\">interface ToggleModal {\n    kind: 'toggle_modal';\n    modalName: 'surveyModal' | 'loginModal';\n    open: boolean;\n}\n\ninterface SetPerson {\n    kind: 'set_person';\n    person: {\n        name: string;\n        age: number;\n    };\n}\n\ntype ViewMsg = ToggleModal | SetPerson;\n</code></pre>\n<p>These resemble &quot;actions&quot; you would send to a reducer when using the Flux architecture.</p>\n<p>The last <code>ViewMsg</code> type forms the union type which our messages stream consists of:\n<code>Stream&lt;ViewMsg&gt;</code>. Let's investigate how this fits into our app architecture.</p>\n<p>We've got our <code>app</code> function which produces state updates and receives state from <code>run</code>. The latter\ncan be modified to accept a stream of view messages:</p>\n<pre><code class=\"language-typescript\">import xs from 'xstream';\n\nconst run = &lt;ViewMsg&gt;(\n    main: Main,\n    view$: Stream&lt;ViewMsg&gt;,\n    startState: State,\n) =&gt; {\n    const fakeUpdates$ = xs.create();\n\n    const state$ = stateUpdate$.fold(\n        (prev, update) =&gt; ({ ...prev, ...update }),\n        startState,\n    );\n\n    const appUpdate$ = main(state$, view$);\n\n    fakeUpdates$.imitate(appUpdate$);\n\n    return state$;\n};\n</code></pre>\n<p>I've introduced a generic type <code>ViewMsg</code> in the <code>run</code> function. Let's start our app:</p>\n<pre><code class=\"language-typescript\">// run :: (Main, Stream&lt;V&gt;, State) -&gt; Stream&lt;State&gt;\nimport { run } from 'frap';\n\nexport interface State {\n    name: string;\n}\n\nexport const startState: State = {\n    name: 'Johan',\n};\n\ninterface SetName {\n    kind: 'set_name';\n    name: string;\n}\n\nexport type ViewMsg = SetName;\n\nconst app: Main = (state$: Stream&lt;State&gt;, view$: Stream&lt;ViewMsg&gt;) =&gt; {\n    const stateUpdate$ = view$\n        // Only filter on the `SetName` type of messages\n        .filter((m): m is SetName =&gt; !!m.kind &amp;&amp; m.kind === 'set_name')\n        // Set a new name by mapping the payload from the message to a state update\n        .map((m) =&gt; ({\n            name: m.name,\n        }));\n\n    return xs.merge(stateUpdate$);\n};\n\n// TODO Build view and construct messages stream\nconst view$ = xs.create&lt;ViewMsg&gt;();\n\n// Kick it off! 🚀\nrun(app, view$, startState);\n</code></pre>\n<p>Now, <em>imagine</em> that the <code>view$</code> stream is working. Imagine that for every time a user is submitting\na form text field with some text, the view will construct the <code>SetName</code> message object and put it on\nthe view stream. This view stream can flow through our app's business logic as a regular function\nparameter, and we can <code>filter</code> to get specific messages and then <code>map</code> them to do state updates.</p>\n<p>This makes the separation between view and business logic pretty clear – which is a good thing! We\ncan test our app in isolation by feeding mocked messages into the view stream and asserting the\nresulting state without having to mount the view. The view's actions don't have to be side effects,\nas it's often regarded to be in other app setups.</p>\n<hr>\n<p>So far, we've stayed inside or pure, functional domain of streams. The next section will go through\nthe elephant in the room.</p>\n<h2>A View to a <s>kill</s> Stream</h2>\n<p>We begin with this simple but beautiful idea:</p>\n<blockquote>\n<p>ui = view(state)</p>\n</blockquote>\n<p><em>The View is a function of state, producing User Interface.</em></p>\n<p>This idea isn't new of course: it exists in various shapes and philosophies, such as MVC, MVVM, MVI,\nand so on. The concept of having a view that listens to state is a baseline in many design patterns.</p>\n<p><strong>Q:</strong> But how do we do this in Frap? Where we have a single stream of state?</p>\n<p><strong>A:</strong> We rely on a virtual DOM!</p>\n<p>This means, we re-render our whole component tree on each new state update. This feels terribly\nexpensive and weird, but we must simply rely on that our virtual DOM implementation will calculate\nthe smallest diff in the real DOM and apply that. The whole design idea behind React is built on\nthis principle: to rely on the virtual DOM.</p>\n<p>As you saw above in the code samples at the top, UI components in CycleJS use streams as first class\ncitizens. The components are really just functions which accepts input streams and return output\nstreams. A common lingo in the streams world is <em>Sources</em> and <em>Sinks</em> to signify the input and\noutputs. Thanks to this property of CycleJS, components can receive a stream of values (&quot;props&quot; in\nReact world) and return a stream of virtual DOM nodes and a stream of new values, emitted from the\ncomponent. React works differently. React components <em>must</em> return JSX (or a virtual DOM node,\nhowever you choose to write it). So we just can't make React components return a stream of JSX and\nexpect things to work, of course.</p>\n<p>Have a look at the <a href=\"https://johan.im/writings/frp-app-arch/#view-model\">view figure</a> again. We see that the view should accept a\nstate stream and &quot;return&quot; a messages stream (I say &quot;return&quot; within quotes since it's not really\ngonna return the stream).</p>\n<p>But how do we draw a whole React app from a stream? We can't return a stream of virtual DOM nodes\nhere?</p>\n<p><strong>We must open up the state stream somehow and let it drive the rendering of the top level\ncomponent.</strong></p>\n<p>(This means the React app will re-render on each state update. <em>Again, this is fine</em>. Does the app\nfeel slow? Profile with React's dev tools, as\n<a href=\"https://twitter.com/ryanflorence/status/1126734015950536706\">this tweet</a> advises).</p>\n<p>In most stream libraries, there's a method called <code>subscribe</code> which you can use on a stream. In\nxstream, it adds a listener on a stream and returns a subscription that can be used to remove that\nlistener (read the <a href=\"http://staltz.github.io/xstream/#subscribe\">docs</a>). We can use that to subscribe\nto state updates, and then unsubscribe when our app unmounts.</p>\n<p>In the <code>next</code> callback of <code>subscribe</code>, we'll receive each new element in the stream (we can also\ncatch errors in <code>error</code>). We use <code>next</code> to set the state of the React component at top level. From\nthen on, we'll let React figure out how to draw the DOM based on that very state. For each new state\nupdate, <code>next</code> will be called, and React will re-render the tree. Incremental, immutable state.</p>\n<p>Here's the function signature of <code>run</code>:</p>\n<pre><code class=\"language-typescript\">type Run = (Main, view$: Stream&lt;ViewMsg&gt;, startState: State) =&gt; Stream&lt;State&gt;;\n</code></pre>\n<p>Before, we've just called <code>run</code> for funsies without really thinking too much about where and how\nwe'll handle it's output stream. I can reveal to you now that the function should ideally be called\nwhen your top level React component mounts.</p>\n<pre><code class=\"language-tsx\">import React from 'react';\nimport { Stream, Subscription } from 'xstream';\nimport { run } from 'frap';\n\n// Imported from our main file\nimport { app, startState, State, ViewMsg } from './main.ts';\n\n/** The state of our React component */\ninterface AppState {\n    state$: Stream&lt;State&gt;;\n    /** This holds our &quot;real&quot; app state – ready to render! */\n    appState: State;\n}\n\ntype Send = (event: ViewMsg) =&gt; void;\n\nclass App extends React.Component&lt;any, AppState&gt; {\n    /** Instance variable holding the subscription to the state stream. */\n    sub: Subscription;\n\n    /** Instance function used to drive messages into the view stream. */\n    send: Send | null = null;\n\n    constructor(props) {\n        super(props);\n\n        // Stream of input from the views.\n        const view$ = xs.create&lt;ViewMsg&gt;();\n\n        // Create our &quot;send&quot; function which will drive messages on to\n        // the view stream above.\n        this.send = (v: ViewMsg) =&gt; {\n            view$.shamefullySendNext(v);\n        };\n\n        // Kick everything off! 🚀\n        const state$ = run(app, view$, startState);\n\n        // Attach on component's local state so we an access it\n        // in life cycle methods\n        this.state = {\n            state$,\n            appState: startState,\n        };\n    }\n\n    componentDidMount(): void {\n        // Start subscribing to incoming state and set the local\n        // state of our React component. Will trigger re-render.\n        this.sub = this.state.state$.subscribe({\n            next: (appState) =&gt; {\n                this.setState({ appState });\n            },\n            error: (err) =&gt; {\n                console.error(err);\n            },\n        });\n    }\n\n    componentWillUnmount(): void {\n        // Unsubscribe from state subscription:\n        this.sub.unsubscribe();\n    }\n\n    render(): React.ReactNode {\n        const { appState } = this.state;\n\n        // Render the 'name' state and a button to change it.\n        return (\n            &lt;div&gt;\n                &lt;h1&gt;Hi {appState.name}!&lt;/h1&gt;\n\n                &lt;button\n                    onClick={() =&gt;\n                        this.send({\n                            kind: 'set_name',\n                            name: 'Johnny Doe',\n                        })}\n                &gt;\n                    Set another name\n                &lt;/button&gt;\n            &lt;/div&gt;\n        );\n    }\n}\n</code></pre>\n<p>(The class approach is a bit verbose, but React Hooks is still a new concept which is outside the\nscope of this post. Here's a\n<a href=\"https://gist.github.com/brookback/d98efdfb4a3087dbba767910f2eec2f3\">GitHub Gist</a> including a Hooks\nversion).</p>\n<p>Notice how we:</p>\n<ol>\n<li>Create a <code>view$</code> stream in the constructor and pass it to <code>run</code>.</li>\n<li>Create a <code>send</code> function on the app component which can be used from view event handlers to send\nmessages.</li>\n<li>Subscribe to state updates when mounted.</li>\n<li>Render the state in <code>render()</code>.</li>\n</ol>\n<p>The main fishy thing here might be the <code>shamefullySendNext</code> method in <code>send</code>. As from the\n<a href=\"http://staltz.github.io/xstream/#shamefullySendNext\">docs</a>, this method forces a new value to be\nemitted to the stream. This is the one of the two &quot;bridges&quot; between our functional app world and the\nimperative view (the <code>subscribe()</code> call being the other one).</p>\n<p>Phew. Lots of code and concepts. In this section, we've:</p>\n<ul>\n<li>seen how to add the view layer (here React) to our app architecture.</li>\n<li>how to pass actual messages from the view.</li>\n<li>render a React component from our state.</li>\n</ul>\n<p>There's one thing missing still. Where are all the async API calls, browser API functions, and\nlogging utilities?</p>\n<p>Yes: where are the <em>side effects</em>?</p>\n<h2>Side effects 💀</h2>\n<p>In any non-trivial application, there <em>will</em> be side effects. Side effects in this case refer to\nthings similar to:</p>\n<ul>\n<li>Fetching JSON from an API server</li>\n<li>Using Chrome's media APIs to gain access to the web camera</li>\n</ul>\n<p>The common denominator is that drivers include <em>imperative code</em>. Code that isn't functional\nstreams. Code that affect the outside world. Code that is non-pure.</p>\n<p>I recommend reading the <em>Drivers</em> section on <a href=\"https://cycle.js.org/drivers.html\">CycleJS's page</a>,\nsince we stole the concept of Drivers from there. There are many good examples there as well.</p>\n<p>Once you've done that, return back here.</p>\n<hr>\n<p>We're gonna use the exact same concept of drivers in Frap. Drivers receive <em>Sinks</em> and return\n<em>Sources</em>. This is in contrast to our main app function, which receives <em>Sources</em> and returns\n<em>Sinks</em>.</p>\n<p>The flow diagram thus becomes:</p>\n<figure id=\"view-model\">\n  <img width=\"624\" alt=\"Driver flow\" src=\"https://johan.im/assets/posts/frap-driver-flow.png\" />\n  <figcaption>App architecture with drivers and view.</figcaption>\n</figure>\n<p>Let's nail down our Sources and Sinks here.</p>\n<ul>\n<li><strong>To our <code>app</code> function,</strong> Sources are all input sources it needs to do its job. View messages,\ndriver input, the state stream. Sinks are output instructions to drivers and state updates.</li>\n<li><strong>To the drivers,</strong> Sources are the output instructions (as a stream) from <code>app()</code>. Sinks can be\nanything.</li>\n</ul>\n<p>The <code>run()</code> function from Frap takes care of glueing all of this together.</p>\n<p>We communicate with the drivers with a single <em>out</em> stream with messages. A driver can thus look\nlike:</p>\n<p><strong>Driver</strong></p>\n<pre><code class=\"language-typescript\">// ConsoleLogDriver.ts\nimport { Stream } from 'xstream';\n\ninterface DoLog {\n    kind: 'do_log';\n    label: string;\n    args?: any[];\n}\n\nexport type ConsoleOut = DoLog;\n\n/** A logging driver that consumes log messages and\n * only performs writes to the console.\n */\nconst ConsoleLogDriver = (out$: Stream&lt;ConsoleOut&gt;) =&gt; {\n    out$.filter((m): m is DoLog =&gt; !!m.kind &amp;&amp; m.kind === 'do_log').addListener(\n        (m) =&gt; console.log(m.label, ...m.args),\n    );\n};\n\nexport default ConsoleLogDriver;\n</code></pre>\n<p>As you see, a driver is 🌈Just A Function 🌈.</p>\n<p>This particular example of a driver only consumes sinks but doesn't return any sources back to our\n<code>app()</code> function.</p>\n<p>How do we hook up this driver? We need to modify the <code>run</code> function!</p>\n<p><strong>Run</strong></p>\n<pre><code class=\"language-typescript\">import xs from 'xstream';\n\ninterface Sources&lt;V&gt; {\n  view$: Stream&lt;V&gt;;\n  drivers?: {\n    [key: string]: (s: Stream&lt;any&gt;) =&gt; void | Stream&lt;any&gt;;\n  };\n}\n\nconst run = &lt;V&gt;(main: Main, sources: Sources, startState: State) =&gt; {\n  const { view$, drivers } = sources;\n\n  const fakeUpdates$ = xs.create();\n  const fakeDriverOuts = createFakeDriverOut(drivers);\n\n  const state$ = stateUpdate$.fold((prev, update) =&gt;\n    ({ ...prev, ...update }), startState);\n\n  // The sources to our app: state, messages, and driver input\n  const mainSources = {\n    state$,\n    view$,\n    ...callDrivers(drivers, fakeDriverOuts),\n  }\n\n  const { stateUpdate$, ...driverSinks } = main(mainSources);\n\n  fakeUpdates$.imitate(stateUpdate$);\n\n  for (const name in fakeDriverOuts) {\n    const fake$ = fakeDriverOuts[name];\n    const driverOut$ = driverSinks[name];\n\n    fake$.imitate(driverOut$));\n  }\n\n  return state$;\n};\n</code></pre>\n<p>This might look a bit hairy. I've left out the implementation of two functions here:</p>\n<ul>\n<li><code>createFakeDriverOut</code>. Similarily to the state updates, we need to have a cyclic relationship\nbetween the drivers' sinks and sources and the main app function. In this function, we create a\nfake stream for each driver specified.</li>\n<li><code>callDrivers</code>. We call all the driver functions with the fake outputs and feed the drivers'\nreturned output as sources to our main app function.</li>\n</ul>\n<p><strong>Main app</strong></p>\n<pre><code class=\"language-typescript\">// main.ts\nimport { run } from 'frap';\nimport { ConsoleOut } from './ConsoleLogDriver.ts';\n\nexport interface State {\n  name: string;\n}\n\nexport const startState: State = {\n  name: 'Johan',\n};\n\ninterface SetName {\n  kind: 'set_name';\n  name: string;\n}\n\nexport type ViewMsg = SetName;\n\ninterface MainSources {\n  view$: Stream&lt;ViewMsg&gt;;\n  state$: Stream&lt;State&gt;;\n}\n\ninterface MainSinks {\n  stateUpdate$: Stream&lt;Partial&lt;State&gt;&gt;;\n  console: Stream&lt;ConsoleOut&gt;;\n}\n\nconst app: Main = (sources: MainSources): MainSinks =&gt; {\n\n  // Access driver sources with:\n  //   sources.myDriver.*\n\n  const stateUpdate$ = /* updates to state */;\n\n  // Send log message to log driver every second:\n  const logDriverOut$ = xs\n    .periodic(1000)\n    .mapTo({\n      kind: 'do_log',\n      label: 'Hello!',\n    }):\n\n  // Return sinks\n  return {\n    // State updates as usual\n    stateUpdate$,\n    // Output instructions to the console driver. The key\n    // needs to match the name of the driver specified in\n    // the `drivers` argument to `run` below.\n    console: logDriverOut$,\n  };\n};\n</code></pre>\n<p><strong>View</strong></p>\n<pre><code class=\"language-typescript\">import ConsoleLogDriver from './ConsoleLogDriver.ts';\n\n// In the react view, run our app:\nrun(\n    app,\n    {\n        view$,\n        drivers: {\n            // ... with the console log driver function\n            console: ConsoleLogDriver,\n        },\n    },\n    startState,\n);\n</code></pre>\n<hr>\n<p>That's it! Now we can handle all side effects in their special drivers, where they can do all kinds\nof reads and writes with the external world, and safely pass back their results as sources (&quot;input&quot;)\nto our app.</p>\n<h2>Parting words</h2>\n<p>What I love about this architecture we've just built are these things:</p>\n<ul>\n<li>Reasoning in reactive streams! 😍 Forget about mutability and writing imperative code. Say hello\nto declarative code and &quot;tight&quot; business logic.</li>\n<li>How well it goes along with React's virtual DOM nature.</li>\n<li>How the architecture is flexible enough to allow for all varieties of organising your app, still\nbeing strict with what types you pass around.</li>\n<li>How well it scales. Almost every new feature you'll add to your app will be written in the same\nstyle.</li>\n<li>How safe I feel when everything from the library layer (Frap) to the view layer (React) is handled\nwith a type system (Typescript).</li>\n</ul>\n<p>Here's the complete library code:</p>\n<p class=\"tc\">\n  <a href=\"https://github.com/lookback/frap\" class=\"btn\">lookback/frap</a>\n</p>\n<p>A huge shoutout to the creators of CycleJS. We've been inspired by them in just about everything.\nThanks for popularising the ideas of cyclical data flows!</p>\n<p class=\"tc\">\n  <strong>Thank you so much for reading ✨</strong>\n</p>\n","date_published":"Fri, 01 May 2020 00:00:00 GMT"},{"id":"https://johan.im/writings/git-guidelines/","url":"https://johan.im/writings/git-guidelines/","title":"Recent improvements in our git discipline","content_html":"<p>The git history of a repository a few years in or with more than one collaborator will look like\nthick weed unless you take care of it. During last Autumn in <a href=\"http://lookback.io/\">Lookback</a>, the\nengineering team noticed that we needed to take care of some weeds.</p>\n<p>Not only in our committing code culture, but also in the land of code reviews and Pull Requests at\nGitHub.</p>\n<p>Here are some of the principles and guidelines we worked out.</p>\n<h1>Empathy for others and your future self</h1>\n<p>We say:</p>\n<blockquote>\n<p>&quot;Please have empathy for your coworkers when committing code. Be considerate of them as well as\nyour future self&quot;.</p>\n</blockquote>\n<p>When working in a long living code base with lots of complex and moving parts, bugs can surface\nweeks or months after you wrote the code. Guess what system helps you go back in time and find\nexactly what, when, and who changed a line of code?! git can! Guess what doesn't help git help you?\nThese things:</p>\n<ul>\n<li>Unclear commit messages.</li>\n<li>Incoherent and too large commits.</li>\n<li>Not easily revertable commits (connected with the above).</li>\n<li>Merge commits.</li>\n</ul>\n<p>Failure to avoid these things will bite you when debugging something in the future.</p>\n<p>For us, we didn't enforce or point these things out in code reviews either. One person could file a\nPull Request 10+ commits, where some of them wouldn't even be related to the PR itself. It was hard\nto give good feedback on a commit which said <code>fix some things in logging</code>: what did you fix? Why?</p>\n<p>&quot;You've got to give love to receive love&quot;. Meaning, &quot;you've got to give your co-workers good PRs in\norder to receive good feedback&quot;. A related joke is the old &quot;20 commit PR? LGTM. One commit? A\nnovella of feedback&quot;.</p>\n<p>We decided to reboot our engineering culture around clean commits and PRs. What follows are some of\nthe guidelines we drafted for working with code.</p>\n<hr>\n<h1>1. Committing code</h1>\n<p>Make each commit <strong>atomical</strong>. That is, make it include only the relevant code for your intended\nchange. There's a lot to read about this subject on the web.</p>\n<p>When submitting a patch for code review, consider grouping together similar commits with\n<code>git rebase</code>(&quot;squashing&quot;) to keep commit count down (<em>without</em> breaking the rule about atomical\ncommits above!).</p>\n<p>The <code>master</code> branch's history should ideally be a long string of commits. We should avoid merge\ncommits by rebasing in <code>master</code> into your feature branch before merging back.</p>\n<h2>Commit messages</h2>\n<ul>\n<li>Try to focus on the <em>why</em> in commit messages. Not necessarily <em>what</em>. Think about how this commit\nwill be read when doing a <code>git blame</code> half a year later. The reader is probably interested in\n<em>why</em> this change happened.</li>\n<li>Capturing the <em>why</em> context is super important, since it's probably tricky to recover later. Save\nyourself some future slack and capture the why <em>now</em>.</li>\n<li>Adding any references (external stories, cards, etc) is appreciated.</li>\n</ul>\n<p><a href=\"https://chris.beams.io/posts/git-commit/\">&quot;How to Write a Git Commit Message&quot;</a> includes some no\nbrainer guidelines for good commit messages.</p>\n<h1>2. Submitting Pull Requests</h1>\n<p><strong>Have mercy for your coworkers.</strong> Don't dump an unstructured, large PR on them with &quot;Review\nthis!!&quot;. Be considerate of their time and energy when submitting, as it might be very hard for them\nto get into the context you've been into the last couple of days while working on the code.</p>\n<p>Make all PRs minimal, concise, and relevant. Don't include non-trivial refactors of modules in a PR\nthat's really supposed to do something else.</p>\n<p>Avoid long living branches. By making small, incremental changes, we avoid messy merge conflicts and\nbest of all: we avoid risky deploys. It's easier to reason about small patches, and potentially\nrolling them back, than huge blobs of &quot;fix everything&quot; PRs.</p>\n<p>Make sure your PR is rebased on <code>master</code> when submitting it. That removes the need for merge commits\nwhen merging back to <code>master</code>.</p>\n<p>When your PR is ready for review (implies that you also think it's ready for merge), <strong>you must make\nsure it's neat and tidy</strong>.</p>\n<ul>\n<li>Squash any similar commits together.</li>\n<li>Look at each commit and see if it makes sense: does it have a nice message? Is the code changes\nrelevant and atomical? If a coworker does a <code>git log</code> in two months, will they be able to\nunderstand this change?</li>\n</ul>\n<p>After receiving a code review with change requests, always try to squash those changes together with\nthe initial commits made when first submitting the PR. It's okay if you have lots of smaller commits\nin your feature branch <em>while working</em> with the code. But once it's ready for review and later merge\ninto <code>master</code>, the final PR <em>must</em> be in a concise, minimal state.</p>\n<p>The code reviewer may reject your PR if it's:</p>\n<ul>\n<li>Too large (&quot;please break into separate PRs&quot;).</li>\n<li>Unstructured/needs squashing (&quot;please restructure this PR&quot;, &quot;please redo your commit history&quot;).</li>\n</ul>\n<p>This does <strong><em>not</em></strong> mean &quot;you suck&quot;. It's a signal that you can learn how to avoid this the next\ntime, as well as avoding wasting your coworkers' time. We aim to learn and become a better developer\n(and co-developer!) with code reviews, since it's so easy to do your own thing when you've been down\nin a code cave for a couple of days.</p>\n<h1>3. Tools &amp; patterns</h1>\n<p>When rebasing your branch – either to rebase in <code>master</code> or rewrite history – the branch will be\ndiverging from the remote, if you've pushed it already. So you need to force push next time\n(<code>git push -f</code>).</p>\n<h2>Commit message templates</h2>\n<p>I just learned about this a couple of months ago: git supports <strong>message templates.</strong> Every time\nyou're committing something from an external editor (not from the command line), you can use a\npre-written template. The template I stole from the post linked below reminds me of the &quot;Because&quot;.\nWhy are you even doing this commit? Any business purpose, or is it tech?</p>\n<pre><code>[one line-summary of changes]\n\nBecause:\n- [relevant context]\n- [why you decided to change things]\n- [reason you're doing it now]\n\nThis commit:\n- [does X]\n- [does Y]\n- [does Z]\n</code></pre>\n<p><a href=\"https://thoughtbot.com/blog/better-commit-messages-with-a-gitmessage-template\">Read more about setting this template up</a>.</p>\n<h2>Rebasing</h2>\n<p>See this guide from the git docs:\n<a href=\"https://git-scm.com/book/en/v2/Git-Branching-Rebasing\">&quot;Rebasing&quot;</a>.</p>\n<p>For instance:</p>\n<pre><code class=\"language-bash\">git checkout my-feature-branch\n# ...do work\n# ...changes have been made in remote master\n# fetch/pull latest master\ngit rebase master\n</code></pre>\n<p>This will re-apply your commits in the feature branch on top of what's in <code>master</code> , to make it\nappear as your branch is branched off of latest commit in <code>master</code>.</p>\n<p>💡<strong>Tip:</strong> use <code>git fetch origin master:master</code> from your feature branch to fetch latest <code>master</code>\nwithout leaving your branch.</p>\n<p>There's a ton of magic things one can do with <code>rebase</code>, please consult the internet or ask coworkers\nabout rebasing strategies.</p>\n<ul>\n<li><strong>Do</strong> rebase <code>master</code> into your feature branch when there are upstream changes in <code>master</code>.</li>\n<li><strong>Don't</strong> use <code>git merge</code> when including changes from <code>master</code> to your feature branch.</li>\n</ul>\n<h2>Conflicts</h2>\n<p>At some point, there will be conflicts when rebasing. You'll be able to solve them in the same way\nas when manually solving conflicts when doing <code>git merge</code>. This is all described in the terminal\nwhen there's a conflict. In a nutshell</p>\n<pre><code class=\"language-bash\"># Find conflicts in code:\ngit status\n# ..Fix them :)\n# Mark as resolved:\ngit add &lt;file&gt;\n# Continue rebasing\ngit rebase --continue\n</code></pre>\n<h2>Force pushing to collaborative branches</h2>\n<p>Rewriting history requires you to force push the PR branch. I.e. you need to push with <code>git push -f</code></p>\n<p>The problem with force pushing is that anyone collaborating on the branch will not be able to just\n<code>git pull</code>. However, git introduced a switch on <code>pull</code> which fixes this:</p>\n<pre><code class=\"language-bash\">git pull --rebase\n</code></pre>\n<p>This is essentially a</p>\n<pre><code class=\"language-bash\">git fetch origin\ngit rebase origin/&lt;your-branch&gt;\n</code></pre>\n<h2>Squashing commits together</h2>\n<p>This is nice for when you've done a lot of small, work preserving commits (WIPs or just to not lose\nthem) that need to be &quot;beautified&quot; before submitting for review.</p>\n<p>See this guide from the git docs:\n<a href=\"https://git-scm.com/book/en/v2/Git-Tools-Rewriting-History\">&quot;Rewriting History&quot;</a>.</p>\n<p>In a nutshell:</p>\n<pre><code class=\"language-bash\"># -i is for &quot;interactive&quot;\n# git rebase -i &lt;git reference&gt;\n# HEAD~&lt;number of commits to include in rebase&gt;\ngit rebase -i HEAD~5\n# or\ngit rebase -i git-hash^ # ^ is targetting the parent commit\n</code></pre>\n<p>An editor will open with your included commits listed. There'll be a legend below them describing\nhow to rewrite history. You can drop commits (<code>d</code>), squash together commits (<code>s</code>), and more. You'll\nbe able to rewrite the commits messages too.</p>\n<h1>Aftermath</h1>\n<p>After we introduced some baselines in how we commit and share code, I personally felt much more\nmotivated to keep things neat and tidy (aka.\n<a href=\"https://en.wikipedia.org/wiki/Broken_windows_theory\">&quot;Broken window syndrome&quot;</a>). Git isn't just a\ntool to transport code from your laptop to a server: it's a super cool tool created to help us\ncollaborate better, <em>and</em> to fix stuff when things go bad (which <em>will</em> happen sometime).</p>\n<p>I found myself actually enjoying writing extended paragraphs in my commit messages. It brought back\nsome memories in doing <a href=\"https://en.wikipedia.org/wiki/Literate_programming\">literate programming</a> in\nCoffeeScript for university lab assignments. The shorter the commit diff, the longer my commit\nmessage would be – a funny inverse proportional property!</p>\n<p>It also touches me every time I go back and see somebody had put in some effort in the commit\nmessage, and documented the process, the Why, and the outcome. It's like a time machine in your\ncolleagues' minds, and also in their personal development to become better programmers.</p>\n","date_published":"Sun, 23 Feb 2020 00:00:00 GMT"}]}