<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Writings of Johan Brook</title>
  <subtitle>I&#39;m a thirty-something designer and developer based in Sweden. I work with the best people in a company called Lookback, where I help interfaces come to life. I&#39;m coding &amp; designering and I like working with product, user experience, interface design, and other things too.</subtitle>
  <link href="https://johan.im/feed.xml" rel="self"/>
  <link href="https://johan.im/writings"/>
  
  <updated>2022-12-30T10:20:00Z</updated>
  <id>https://johan.im/writings</id>
  <author>
    <name>Johan Brook</name>
    <email>webmaster@johan.im</email>
  </author>
  
  <entry>
    <title>Mastodon</title>
    <link href="https://johan.im/writings/mastodon/" />
    <updated>2022-12-30T10:20:00Z</updated>
    <id>https://johan.im/writings/mastodon/</id>
    <content type="html">&lt;p&gt;During November this year, Elon Musk took over as acting CEO of Twitter. It was a horrible event: it felt like the end of the world, and ideological users left or set up alternative social media accounts for themselves. It became totally normal to tweet your contact details with &amp;quot;Find me at X&amp;quot; (as I&#39;ve would go through all those tweets and follow people on Instagram/Tumblr/what-have-you) like the service would shut down at any given time.&lt;/p&gt;
&lt;p&gt;Now, the (Twitter) apocalypse didn&#39;t come. It might still do, because Elon either kicked or caused thousands of employees to leave. But I think a non-trivial blow was caused against the OG social media giant, since people like me actually got off of their asses and created Mastodon accounts. I recommend skimming through the &lt;a href=&quot;https://en.wikipedia.org/wiki/Mastodon_(social_network)&quot;&gt;Wikipedia page for Mastodon&lt;/a&gt; (huh, it was started as recently as 2016, I didn&#39;t know that).&lt;/p&gt;
&lt;p&gt;I&#39;ve loved Twitter from all the way since I joined in 2008. I recall my &amp;quot;final exam&amp;quot; project in high school was a Twitter client built in Java and Swing. Twitter has enriched my digital life with knowledge, joy, random banter, news, and true sense of &amp;quot;we&amp;quot; during major events. Sentimentally, like a big ol&#39; family. However, I&#39;m totally aware of the problems of the platform when it comes to harassment and the likes. Also, I&#39;ve heard the product itself (the web UI and mobile apps) isn&#39;t among people&#39;s favourite things to interact with. Non-linear timeline, suggestions, seeing tweets from people you don&#39;t follow, ads, etc. etc. I&#39;ve had non of that, since I&#39;ve used the &lt;a href=&quot;https://tapbots.com/&quot;&gt;Tweetbot clients for Mac and iOS&lt;/a&gt; for years. That&#39;s how I&#39;ve kept sane during all this time. I urge you to try out a 3rd party client too.&lt;/p&gt;
&lt;p&gt;Speaking of 3rd party clients leads me into this interesting topic: openness and ownership. At certain points in time, Twitter took measures in severely limiting their 3rd party APIs so that app developers couldn&#39;t provide all the features you&#39;d get with Twitter&#39;s own apps. This sucks for us users, obviously, but from a bUsIneSs pErSpEctIvE it makes sense: Twitter is a public company with obligations to their shareholders. I get that. (Even though they still don&#39;t do well financially.) In Mastodon world (&amp;quot;the fediverse&amp;quot; – Federated Universe), this could never happen, because there&#39;s not a single entity in control over the APIs. For an &amp;quot;internet enthusiast&amp;quot; as myself, steeped in 90s/00s open software culture and with a gradual dissatisfaction with centralised companies in Silicon Valley owning my shit, Mastodon is really lovely.&lt;/p&gt;
&lt;p&gt;Mastodon is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;open source, so you can fork the source code and run it on your on server&lt;/li&gt;
&lt;li&gt;maintained by a German non-profit (not an American organisation for once! *tears of joy)&lt;/li&gt;
&lt;li&gt;ad-free, backed by supporters&lt;/li&gt;
&lt;li&gt;Supporting W3C&#39;s &lt;a href=&quot;https://en.wikipedia.org/wiki/ActivityPub&quot;&gt;ActivityPub&lt;/a&gt; protocol for talking with other services&lt;/li&gt;
&lt;li&gt;decentralised, anybody can boot up their own Mastodon instance and connect to the &amp;quot;federation&amp;quot;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The last point is of course not something regular users will do. This quote comes to mind:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;People don’t want to run their own servers, and never will.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://moxie.org/2022/01/07/web3-first-impressions.html&quot;&gt;Moxie Marlinspike&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This is just an implementation detail, but I like that you &lt;em&gt;can&lt;/em&gt; do this. But I won&#39;t. Instead, I trust the instance I&#39;m registered to at the moment. But if I wanted to, I could just take my stuff and migrate to another instance. This is really important, since it lowers the anxiety of picking an instance when you sign up (they should front this more in the onboarding).&lt;/p&gt;
&lt;p&gt;The &amp;quot;how to pick an instance&amp;quot; part of Mastodon is probably their biggest UX challenge at the moment. I&#39;m at &lt;a href=&quot;https://hachyderm.io/about&quot;&gt;Hachyderm&lt;/a&gt;, which is run by a great engineer at GitHub. The instance is well maintained and has sane server rules. How did I find it? Via &lt;a href=&quot;https://hachyderm.io/@mislav&quot;&gt;@mislav&lt;/a&gt; on Twitter, in his &lt;a href=&quot;https://twitter.com/mislav/status/1592905424214274049&quot;&gt;good intro thread&lt;/a&gt; to Mastodon.&lt;/p&gt;
&lt;p&gt;I&#39;m kind of torn on the subject of &amp;quot;Twitter vs Mastodon&amp;quot;. One one hand, I love the hacker ethics of Mastodon. On the other hand, I love the original attitudes of Twitter and &lt;em&gt;my&lt;/em&gt; timeline. I don&#39;t want Twitter to fail per se, but at the same time, I&#39;m happy that Mastodon got an influx of users during the Elon Musk takeover. But the takeover was, to me, completely unnecessary. They did not have to sell to Musk. Now, a month later, a &lt;em&gt;bunch&lt;/em&gt; of great engineers – some of the best in the world – have left the company. Twitter may have suffered from the ordinary big-co Silicon Valley bullshit when it comes to policies, investors, management, and so on, but I&#39;ve heard their engineering team is really, really great. So I&#39;m sad for them having to leave their work and code due to the rich asshole barging in.&lt;/p&gt;
&lt;p&gt;Now when the dust has settled a bit after the Twitter doomsday frenzy, I appreciate Mastodon &lt;em&gt;a lot&lt;/em&gt;. It&#39;s so cosy checking out my timeline there, since it feels like Twitter felt in the beginning, before the harsh reality of profit making got on them. The hacker feel of the system also brings out nostalgia. Even though I&#39;ve been guarded from most of Twitter&#39;s bad product decisions thanks to the aforementioned choice of 3rd party clients, the feel of Mastodon is something special. Maybe it&#39;s just a feel of starting over. But it creates a fuzzy feeling knowing that the project is based on attitudes and philosophies I can get behind. Does it have the same reach and scale as Twitter? Of course not, that&#39;s not the goal. Most Twitter users whose tweets I enjoy the most are on Mastodon anyway. Is it annoying checking two apps? A bit, yes, but the content also vary in that Mastodon posts (&amp;quot;toots&amp;quot;) feels more well written and have higher quality.&lt;/p&gt;
&lt;p&gt;Mastodon certainly isn&#39;t perfect. It surely has or will have its problems and scandals or whatnot. We&#39;ll see. For now though, I&#39;m just happy to have discovered a new project and technology I like for myself.&lt;/p&gt;
&lt;p&gt;Now I&#39;m just waiting for Tapbot&#39;s &lt;a href=&quot;https://hachyderm.io/@ivory@tapbots.social&quot;&gt;Ivory&lt;/a&gt; client to land…&lt;/p&gt;
&lt;p&gt;(I&#39;m &lt;a href=&quot;https://hachyderm.io/@brookie&quot;&gt;@brookie@johan.im&lt;/a&gt; on Mastodon by the way!)&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>My favourite software</title>
    <link href="https://johan.im/writings/my-favourite-software/" />
    <updated>2022-02-23T00:00:00Z</updated>
    <id>https://johan.im/writings/my-favourite-software/</id>
    <content type="html">&lt;h2&gt;1. Typescript&lt;/h2&gt;
&lt;p&gt;I started programming in Java and PHP. Those two worlds were vastly different. PHP stood for
freedom, fun, and anything-is-possible. Java was rigid, hard, and verbose – much because of the need
for &lt;em&gt;types&lt;/em&gt; everywhere. However, when I got the Java code to compile, it was &lt;em&gt;usually&lt;/em&gt; okay in
runtime (as okay it can be for a 15 year old). Java was heavily used in university, and I grew to
hate it even more. The interpreted languages like PHP, Ruby, and Javascript felt much nicer.&lt;/p&gt;
&lt;p&gt;Fast forward to around 2018, and I got the chance to play around with Typescript (and GraphQL) at
work. This was a turning point in my journey as programmer: the types actually helped me. The type
system – although not as &amp;quot;correct&amp;quot; as in Haskell et al – was expressive, flexible, and quite easy to
understand. And the language itself resembled Javascript so much I didn&#39;t think about it.&lt;/p&gt;
&lt;p&gt;What I love about Typescript is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the no-nonsense setup:&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;npm i --save-dev typescript
touch script.ts
npx tsc script.ts
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;the backwards compatibility with Javascript: one can gradually add types if that suits the
project.&lt;/li&gt;
&lt;li&gt;I&#39;m not annoyed over any particular syntax of the language.&lt;/li&gt;
&lt;li&gt;that it&#39;s actively maintained, and the community is growing and full of tools.&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;p&gt;Typescript is probably the single piece of software that has made me write better code over the last
few years. I need less automatic tests, less or no linting. It has opened a new world (of types) to
me, and has made me never wanting to go back.&lt;/p&gt;
&lt;h2&gt;2. Deno&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://deno.land/&quot;&gt;Deno&lt;/a&gt; is what NodeJS was supposed to be. I think. It&#39;s a new Javascript runtime
which does a lot of things right. Peruse the Manual and if you&#39;ve written a bit of NodeJS, you&#39;ll
probably find yourself nod along as you read through the Deno docs.&lt;/p&gt;
&lt;p&gt;There are a lot of built-in things, and the ecosystem is spreading. Typescript is a first class
citizen. Testing, formatting, and linting are included. Web APIs are available on the server.&lt;/p&gt;
&lt;p&gt;Deno fixes so many things in Node which I&#39;d either get annoyed with or work around.&lt;/p&gt;
&lt;h2&gt;3. cUrl&lt;/h2&gt;
&lt;p&gt;The &lt;code&gt;curl&lt;/code&gt; command just works. There are wrappers and replacements which are &amp;quot;simpler&amp;quot; and more
intuitive. But this is one of these cases where I think it&#39;s good to learn the low level tools,
since &lt;code&gt;curl&lt;/code&gt; is available on a &lt;em&gt;lot&lt;/em&gt; of machines.&lt;/p&gt;
&lt;p&gt;I for one appreciate elegant CLI tools which doesn&#39;t make me figure out their fantasy world of
options and arguments. But &lt;code&gt;curl&lt;/code&gt; is such a fundamental way to interact with remote data (I use it
for HTTP 100% of the cases).&lt;/p&gt;
&lt;h2&gt;4. Lume&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://lumeland.github.io/&quot;&gt;Lume&lt;/a&gt; is a static site generator (using Deno and Typescript). I
recently moved to it from Eleventy, and before that from Jekyll -&amp;gt; Wintersmith -&amp;gt; Metalsmith. Lume
is the first one which is close to 100% intuitive, and the first one that I&#39;m not annoyed over when
using. I&#39;ve read some of the Lume source code, and it&#39;s lovely: succinct and readable.&lt;/p&gt;
&lt;p&gt;Lume does what it does, and does it really well.&lt;/p&gt;
&lt;h2&gt;5. Numi&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://numi.app/&quot;&gt;Numi&lt;/a&gt; is a calculator app, like Soulver, which I use a couple of times per day.
I&#39;ve bound it to be visible when I press &lt;code&gt;cmd+shift+x&lt;/code&gt; for quick calculations. I use it for
everything from credit card bills to protein intake calculations. It&#39;s declarative in the sense that
it &amp;quot;does what I think it does&amp;quot;. If I type &lt;code&gt;5% of 100g&lt;/code&gt; it&#39;ll output &lt;code&gt;5 g&lt;/code&gt;. It has
&lt;a href=&quot;https://github.com/nikolaeu/numi/wiki/Documentation&quot;&gt;nice documentation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Numi doesn&#39;t just to maths: it can deal with unit, timezone, and currency conversions too, and many
other things.&lt;/p&gt;
&lt;p&gt;This tech isn&#39;t novel, but Numi pulls it off in a minimal packaging, and I love it.&lt;/p&gt;
&lt;h2&gt;6. Tweetbot&lt;/h2&gt;
&lt;p&gt;I honestly don&#39;t understand why people are using the regular Twitter.com or Twitter clients for
iOS/Android. People complain daily about &amp;quot;The Algorithm&amp;quot;, non-chronological timelines, ads, etc.
etc. Just start using a 3rd party client already!&lt;/p&gt;
&lt;p&gt;I&#39;ve used a ton of clients since I joined Twitter. Many of them are now dead because of Twitter&#39;s
big purge (they killed a lot of API functionality and tweaked some legal agreement I think). But
&lt;a href=&quot;https://tapbots.com/tweetbot/&quot;&gt;Tweetbot&lt;/a&gt; is still standing, and are actively pushing new features.
I&#39;m a happy subscriber.&lt;/p&gt;
&lt;p&gt;The team has always produced super slick designs, and their work is still cool in a world which
doesn&#39;t really do skeumorphism any longer.&lt;/p&gt;
&lt;p&gt;Tweetbot for Mac and iOS have all the features I need. It makes intelligent use of gestures on
respective platform, and I can customise things. No ads. No weird sorting or algorithm. It&#39;s
literally how Twitter used to be.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Setting up Sublime Text for Deno</title>
    <link href="https://johan.im/writings/sublime-text-deno/" />
    <updated>2022-02-16T00:00:00Z</updated>
    <id>https://johan.im/writings/sublime-text-deno/</id>
    <content type="html">&lt;p&gt;I&#39;ve recently switched back to Sublime Text as main editor, as described in a recent
&lt;a href=&quot;https://johan.im/mind/#202202080950&quot;&gt;/mind post&lt;/a&gt;. As a test to get a feel for the ecosystem, I&#39;ve set out on a
journey to make it more ergonomic to develop &lt;a href=&quot;https://deno.land/&quot;&gt;Deno&lt;/a&gt; code. &amp;quot;Ergonomic&amp;quot; as in
&amp;quot;actually use Typescript features and not show any red compile errors for Deno specific code&amp;quot;. Also,
I want to try to have Sublime support
&lt;a href=&quot;https://deno.land/manual/linking_to_external_code/import_maps&quot;&gt;import maps&lt;/a&gt;,
&lt;a href=&quot;https://deno.land/manual/getting_started/configuration_file&quot;&gt;the Deno config file&lt;/a&gt;, and format on
save.&lt;/p&gt;
&lt;h1&gt;Install necessary packages&lt;/h1&gt;
&lt;p&gt;(I assume you have &lt;a href=&quot;https://packagecontrol.io/installation&quot;&gt;Package Control up and running&lt;/a&gt;.)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Required:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://packagecontrol.io/packages/LSP&quot;&gt;LSP&lt;/a&gt;. Client implementation of the Language Server
Protocol for Sublime Text. This is a base package, which is used by other language specific
packages. There are packages for Typescript, CSS, Deno, JSON, Lua, Vue, etc. etc.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://packagecontrol.io/packages/LSP-Deno&quot;&gt;LSP-Deno&lt;/a&gt;. Convenience package for starting the Deno
LSP server. This enables Deno features in Sublime.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Optional:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://packagecontrol.io/packages/LSP-json&quot;&gt;LSP-json&lt;/a&gt;. Schema validation/completions for your
JSON and Sublime files. This is for making JSON files more &amp;quot;VS Code like&amp;quot; in the way that keys in
various settings files can be autocompleted and validated. Handy but in no way required.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Sublime project configuration&lt;/h2&gt;
&lt;p&gt;First of all, we need a place where we can instruct Sublime (and installed packages) where to look
for custom Deno settings. That is, settings that describe paths to files, and lint and format
config. Essentially holding the values described in
&lt;a href=&quot;https://deno.land/manual/getting_started/configuration_file&quot;&gt;&amp;quot;Configuration file&amp;quot;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;These will go into a &lt;code&gt;xxx.sublime-project&lt;/code&gt; file, where &lt;code&gt;xxx&lt;/code&gt; is the name of your project (anything).
Create one if you haven&#39;t.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;(Sublime has this concept of &amp;quot;projects&amp;quot; I don&#39;t really like. One has to go to &lt;em&gt;Window -&amp;gt; Open
project…&lt;/em&gt; in order for the editor to actually load the project config file, &lt;em&gt;or&lt;/em&gt; use
&lt;code&gt;subl --project path/to/project.sublime-project&lt;/code&gt;. It&#39;s not loaded when the editor is brought up via
&lt;code&gt;subl .&lt;/code&gt; from the command line. This feels lame. Sort of
&lt;a href=&quot;https://github.com/sublimehq/sublime_text/issues/828&quot;&gt;tracked here&lt;/a&gt;.)&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;This is a sample &lt;code&gt;xxx.sublime-project&lt;/code&gt; for Deno:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
	&amp;quot;settings&amp;quot;: {
		&amp;quot;LSP&amp;quot;: {
			&amp;quot;LSP-typescript&amp;quot;: {
				&amp;quot;enabled&amp;quot;: false
			},
			&amp;quot;Deno&amp;quot;: {
				&amp;quot;enabled&amp;quot;: true,
				&amp;quot;settings&amp;quot;: {
					&amp;quot;deno.config&amp;quot;: &amp;quot;./deno.jsonc&amp;quot;,
					&amp;quot;deno.unstable&amp;quot;: true,
					&amp;quot;deno.importMap&amp;quot;: &amp;quot;./import_map.json&amp;quot;,
					&amp;quot;deno.suggest.imports.hosts&amp;quot;: {
						&amp;quot;https://deno.land&amp;quot;: true,
						&amp;quot;https://some-other-cdn.com&amp;quot;: true
					}
				}
			}
		}
	}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;All &lt;code&gt;deno.*&lt;/code&gt; settings are documented
&lt;a href=&quot;https://github.com/sublimelsp/LSP-Deno/blob/main/LSP-Deno.sublime-settings&quot;&gt;here, with defaults&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Line by line:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;LSP-typescript&lt;/code&gt;. Let&#39;s be really sure to disable the TypeScript Language Server, since that&#39;ll
interfere with &lt;code&gt;.ts&lt;/code&gt; files with Deno calls.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;deno.config&lt;/code&gt;: Path to the Deno
&lt;a href=&quot;https://deno.land/manual/getting_started/configuration_file&quot;&gt;configuration file&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;deno.unstable&lt;/code&gt;: Enable unstable features or not.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;deno.importMap&lt;/code&gt;: Path to an &lt;a href=&quot;https://deno.land/manual/npm_nodejs/import_maps&quot;&gt;import map&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;deno.suggest.imports.hosts&lt;/code&gt;: Hosts that will appear as suggestions when importing.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;(As mentioned above, the LSP-json package really helps you with the autocomplete here. I found it
tricky to figure out the exact structure of these settings.)&lt;/p&gt;
&lt;p&gt;For me, there&#39;s no need to do further tweaks in most Deno projects.&lt;/p&gt;
&lt;p&gt;Now, Sublime should be able to pick up your import map, as well as your Deno configuration.&lt;/p&gt;
&lt;p&gt;If configured correctly, you should be able to&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;get IntelliSense popups when hovering over functions&lt;/li&gt;
&lt;li&gt;have working import maps&lt;/li&gt;
&lt;li&gt;get proper type info and autocompletions when coding&lt;/li&gt;
&lt;li&gt;have correct &lt;code&gt;compilerOptions&lt;/code&gt; from your Deno config&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;and lots more.&lt;/p&gt;
&lt;p&gt;![IntelliSense documentation popup]({{ &amp;quot;deno-intellisense.png&amp;quot; | postAssetUrl }})&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; at the time of writing, there&#39;s an issue with the &lt;code&gt;deno.suggest.imports.hosts&lt;/code&gt; key. If you
toggle the LSP log panel (&lt;em&gt;Command palette -&amp;gt; &amp;quot;LSP: Toggle log panel&amp;quot;&lt;/em&gt;), you&#39;ll see that it says:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;failed to update settings: invalid type: map, expected a boolean
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I&#39;ve filed an &lt;a href=&quot;https://github.com/sublimelsp/LSP-Deno/issues/10&quot;&gt;issue for LSP-Deno here&lt;/a&gt;. I&#39;ve
noticed that this setting interfers with the other settings, so I&#39;ve removed it for now.&lt;/p&gt;
&lt;h2&gt;Click to go to definition&lt;/h2&gt;
&lt;p&gt;This is a feature I heavily used in VS Code: use the combo of &lt;code&gt;option+click&lt;/code&gt; (Mac) to go to the
definition of a variable, function, or type. This uses the LSP, so it&#39;ll be &amp;quot;intelligent&amp;quot;.&lt;/p&gt;
&lt;p&gt;Mouse bindings live in this file (create it if it doesn&#39;t exist):&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;~/Library/Application\ Support/Sublime\ Text/Packages/User/Default\ (OSX).sublime-mousemap
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then add this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;[
	{
		&amp;quot;button&amp;quot;: &amp;quot;button1&amp;quot;,
		&amp;quot;count&amp;quot;: 1,
		&amp;quot;modifiers&amp;quot;: [
			&amp;quot;alt&amp;quot;
		],
		&amp;quot;press_command&amp;quot;: &amp;quot;lsp_symbol_definition&amp;quot;
	}
]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can now use &lt;code&gt;alt+click&lt;/code&gt; to jump around.&lt;/p&gt;
&lt;h2&gt;Rename symbols&lt;/h2&gt;
&lt;p&gt;Another nifty feature we can use the Language Server&#39;s capabilities for is to do smart renames, i.e.
rename functions and variables and have them be intelligently updated across files.&lt;/p&gt;
&lt;p&gt;In VS Code, I used the key binding &lt;code&gt;cmd+shift+r&lt;/code&gt; (Mac).&lt;/p&gt;
&lt;p&gt;Open up Key Bindings (&lt;em&gt;Preferences -&amp;gt; Key Bindings&lt;/em&gt;) or:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;subl ~/Library/Application\ Support/Sublime\ Text/Packages/User/Default\ (OSX).sublime-keymap
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then add this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;[
	{
		&amp;quot;keys&amp;quot;: [&amp;quot;super+shift+r&amp;quot;],
		&amp;quot;command&amp;quot;: &amp;quot;lsp_symbol_rename&amp;quot;,
		&amp;quot;context&amp;quot;: [
			{
				&amp;quot;key&amp;quot;: &amp;quot;lsp.session_with_capability&amp;quot;,
				&amp;quot;operator&amp;quot;: &amp;quot;equal&amp;quot;,
				&amp;quot;operand&amp;quot;: &amp;quot;renameProvider&amp;quot;
			}
		]
	}
]
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Diagnostics panel&lt;/h2&gt;
&lt;p&gt;By default, the LSP package will show a diagnostics panel if there are TypeScript errors or warnings
in your project. I found this really annoying, so I turned it off with:&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Preferences -&amp;gt; Package Settings -&amp;gt; LSP -&amp;gt; Settings&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Then add:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
	// Open the diagnostics panel automatically on save when diagnostics level is
	// equal to or less than:
	// none: 0 (never open the panel automatically)
	// error: 1
	// warning: 2
	// info: 3
	// hint: 4
	&amp;quot;show_diagnostics_panel_on_save&amp;quot;: 0 // default is 2, turn off with 0
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Tip:&lt;/strong&gt; You can still toggle the &lt;em&gt;Diagnostics&lt;/em&gt; panel with &lt;code&gt;cmd+alt+m&lt;/code&gt; (Mac) or search for it in the
command palette. It&#39;ll show any TypeScript errors or warnings in the project.&lt;/p&gt;
&lt;h2&gt;Code formatting&lt;/h2&gt;
&lt;p&gt;Deno comes with a built-in formatter, which the LSP in Sublime can use.&lt;/p&gt;
&lt;p&gt;Either run &lt;code&gt;LSP: Format file&lt;/code&gt; from the command palette to format manually, or use format on save.
The latter is configured in the LSP settings, &lt;em&gt;but&lt;/em&gt; you should probably do it on a project basis.
This means adding this to your Sublime project file:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
	&amp;quot;settings&amp;quot;: {
		&amp;quot;lsp_format_on_save&amp;quot;: true
	}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The exact formatting config lives in your Deno configuration. For me, it&#39;s &lt;code&gt;deno.jsonc&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
	&amp;quot;fmt&amp;quot;: {
		&amp;quot;options&amp;quot;: {
			&amp;quot;useTabs&amp;quot;: false,
			&amp;quot;lineWidth&amp;quot;: 100,
			&amp;quot;singleQuote&amp;quot;: true,
			&amp;quot;indentWidth&amp;quot;: 4
		}
	}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Bonus: JSON schema support for &lt;code&gt;deno.json&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;There&#39;s no built-in support for autocompletions in &lt;code&gt;deno.{json,jsonc}&lt;/code&gt; files. But with our newly
installed LSP-json package, there is a way! Deno publishes its schema for the config file on a URL,
which we can add to &amp;quot;user schemas&amp;quot; in the LSP-json settings.&lt;/p&gt;
&lt;p&gt;Open &lt;code&gt;LSP-json.sublime-settings&lt;/code&gt; or run &lt;code&gt;LSP-json Settings&lt;/code&gt; in the command palette. Then add this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
	&amp;quot;settings&amp;quot;: {
		&amp;quot;userSchemas&amp;quot;: [
			{
				&amp;quot;fileMatch&amp;quot;: [&amp;quot;deno.json&amp;quot;, &amp;quot;deno.jsonc&amp;quot;],
				&amp;quot;uri&amp;quot;: &amp;quot;https://deno.land/x/deno@v1.18.2/cli/schemas/config-file.v1.json&amp;quot;
			}
		]
	}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I guess one has to update the versions in there manually, but the package wouldn&#39;t follow the URL
linked from Deno&#39;s
&lt;a href=&quot;https://deno.land/manual/getting_started/configuration_file&quot;&gt;documentation page&lt;/a&gt;, probably since it
redirects:
&lt;a href=&quot;https://deno.land/x/deno/cli/schemas/config-file.v1.json&quot;&gt;https://deno.land/x/deno/cli/schemas/config-file.v1.json&lt;/a&gt;.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;That&#39;s it! &lt;a href=&quot;https://johan.im/contact&quot;&gt;Let me know&lt;/a&gt; if you&#39;ve got more tricks for working with Deno in Sublime.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>A whole new world with Deno</title>
    <link href="https://johan.im/writings/deno/" />
    <updated>2022-01-19T00:00:00Z</updated>
    <id>https://johan.im/writings/deno/</id>
    <content type="html">&lt;p&gt;&lt;a href=&quot;https://deno.land/&quot;&gt;Deno&lt;/a&gt; is a new &lt;em&gt;runtime&lt;/em&gt; for Javascript. Before, NodeJS used to be the most
popular way to run Javascript on the server. But no more! Deno has reached stable state (it&#39;s on
version 1.17 at the time of writing). It runs Typescript natively, supports ES imports (why did I
feel I had to specify that as a feature?), and is built with Rust (again! This isn&#39;t a feature, but
it feels good that it&#39;s Rust somehow, doesn&#39;t it?).&lt;/p&gt;
&lt;p&gt;Until now, I&#39;ve just read the &lt;a href=&quot;https://deno.land/manual&quot;&gt;Deno manual&lt;/a&gt; and lurked in their
&lt;a href=&quot;https://deno.land/std&quot;&gt;standard library&lt;/a&gt;. Then I played around with a server + client app for a
couple of days, and after that I converted this site to use &lt;a href=&quot;https://lumeland.github.io/&quot;&gt;lume&lt;/a&gt;,
which is a static site generator based on Deno.&lt;/p&gt;
&lt;p&gt;Here are some of my personal favourites in Deno, with some love for lume as an appendix.&lt;/p&gt;
&lt;h1&gt;Web APIs we know and love&lt;/h1&gt;
&lt;p&gt;Deno includes a ton of niceties that just sparks joy for the hardest of the hardcore NodeJS
developers out there. &lt;code&gt;fetch&lt;/code&gt; &lt;em&gt;just works&lt;/em&gt; (we&#39;ve internalised that one needs to &lt;code&gt;npm install&lt;/code&gt; some
external library for HTTP requests in NodeJS). Hell, even doing the very browser-y &lt;code&gt;alert&lt;/code&gt; and
&lt;code&gt;confirm&lt;/code&gt; in your Deno based CLI script will work on the command line to show a message and prompt
for yes/no, respectively. Opinions might differ whether this is good or bad, but personally I
appreciate not having to pull in a lib or visit StackOverflow each time I need user input.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;For APIs where a web standard already exists, like fetch for HTTP requests, Deno uses these rather
than inventing a new proprietary API.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The above line from &lt;a href=&quot;https://deno.land/manual/runtime&quot;&gt;&amp;quot;The Runtime&amp;quot;&lt;/a&gt; section of the Manual is the
red line throughout the Deno API.&lt;/p&gt;
&lt;p&gt;That means, instead of doing&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;// Node
import request from &#39;some-random-npm-request-lib&#39;;

const response = await request.get(&#39;https://deno.land&#39;);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;you&#39;d do&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;// Deno/browsers
const response = await fetch(&#39;https://deno.land&#39;);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In Deno, you can use a ton of browser-y APIs, such as &lt;code&gt;location&lt;/code&gt;, &lt;code&gt;local/sessionStorage&lt;/code&gt;,
&lt;a href=&quot;https://deno.land/manual@v1.17.3/runtime/web_platform_apis#other-apis&quot;&gt;and more&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Another example: you can use the same CSS based styling for &lt;code&gt;console&lt;/code&gt; calls as you&#39;d do in the
browser:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;// Deno/browsers
console.log(
	&#39;%cHi there. %cSome background?&#39;,
	&#39;color: red&#39;,
	&#39;background-color: gray&#39;,
);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;No need for terminal escape codes or pulling in yet another library.&lt;/p&gt;
&lt;p&gt;I hope it&#39;s clear where I&#39;m getting at: there are things included in Deno that you &lt;em&gt;just know
already&lt;/em&gt; because you&#39;ve been writing web code for years. It lowers the iteration speed when writing
code, as well as lowers the overhead when reading it, when you don&#39;t have to refer to third party
dependencies or in-house modules all the time. To me, this feels much better when writing code in
Deno.&lt;/p&gt;
&lt;p&gt;The use of third party dependencies have been a debate in Javascript land during the past couple of
months, due to … incidents around security and feelings of the module authors themselves. Surely the
best dependency is no dependency, right? Surely a ton of npm modules can be deprecated if only
NodeJS (or Javascript itself) had a better standard library?&lt;/p&gt;
&lt;p&gt;I hope that we in the future look at &amp;quot;old&amp;quot; code and say: &amp;quot;Oh, did you pull in a dependency for
&lt;em&gt;that&lt;/em&gt;?&amp;quot;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;Update, 2022-02-08:&lt;/em&gt;&lt;/strong&gt; the Deno authors have written a neat
&lt;a href=&quot;https://deno.com/blog/every-web-api-in-deno&quot;&gt;blog post&lt;/a&gt; detailing all web platform APIs implemented
in Deno, with examples. You&#39;ll get a very fuzzy feeling when reading the list.&lt;/p&gt;
&lt;h1&gt;Typescript as a first class citizen&lt;/h1&gt;
&lt;p&gt;I was in tears (tears of joy, I assure you) when I first read about Typescript support in Deno when
the latter was introduced years ago. No need for a build step for &lt;code&gt;.ts&lt;/code&gt; and &lt;code&gt;.tsx&lt;/code&gt; files, just
&lt;code&gt;deno run&lt;/code&gt; and off you go. I just works.&lt;/p&gt;
&lt;p&gt;One neat API is &lt;a href=&quot;https://deno.land/manual/typescript/runtime&quot;&gt;&lt;code&gt;Deno.emit&lt;/code&gt;&lt;/a&gt;. With it, you can
programmatically compile and bundle Typescript code to Javascript.&lt;/p&gt;
&lt;p&gt;I&#39;ve got not much more to say about this than &lt;em&gt;&amp;quot;Finally&amp;quot;&lt;/em&gt;.&lt;/p&gt;
&lt;h1&gt;Testing&lt;/h1&gt;
&lt;p&gt;Let&#39;s play a game. How many test runners for Javascript code can you think of?&lt;/p&gt;
&lt;p&gt;…&lt;/p&gt;
&lt;p&gt;Okay, tough question, as the correct answer probably is: &amp;quot;The number is approaching &lt;code&gt;Infinity&lt;/code&gt;&amp;quot;.&lt;/p&gt;
&lt;p&gt;How many test runners do you &lt;em&gt;need&lt;/em&gt;? One. There&#39;s one built-in in Deno:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;Deno.test(&#39;My test&#39;, () =&amp;gt; {
	// test things
});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Name the file &lt;code&gt;something.test.ts&lt;/code&gt; and run it with:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;deno test something.test.ts
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I love this. Standardised, one way of doing things, minimal. No arguing in the team about which is
the best test runner this month.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&quot;https://deno.land/std/testing&quot;&gt;&lt;code&gt;testing&lt;/code&gt;&lt;/a&gt; module from the Deno std lib includes a couple of
assertions – you probably don&#39;t need more than those. (I also see it exports tools for benchmarking
your code as well, iihhh!)&lt;/p&gt;
&lt;h1&gt;Distributed dependency management&lt;/h1&gt;
&lt;p&gt;…with no &lt;code&gt;package.json&lt;/code&gt;! In Deno, you import external, remote, dependencies with URLs. Again, just
like we&#39;ve done in the browser since the 90s (&lt;code&gt;&amp;lt;script src=&amp;quot;http://cdn.example.com/script.js&amp;gt;&lt;/code&gt;
amirite). When Deno first runs your code, it&#39;ll fetch the remote script and cache it locally for the
next runs. Don&#39;t be scared: Deno do support reading and writing a lockfile with options to
&lt;code&gt;deno run&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;This is how it looks like:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;import dependency from &#39;https://somesite.com/mod.ts&#39;;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;(By convention, modules should have a &lt;code&gt;mod.ts&lt;/code&gt; which is the entrypoint for consumers. Note that
there&#39;s no concept of some silly &lt;code&gt;index.js&lt;/code&gt; file in Deno land: that&#39;s one thing the Node creator
Ryan wanted to get rid of when he created Deno.)&lt;/p&gt;
&lt;p&gt;This is actually fairly liberating once you&#39;ve sweated out the feelings of chaos in your codebase.
Remember, this is all source code! You can centralise all these third party imports to a single file
and re-export them. In fact, that&#39;s what
&lt;a href=&quot;https://deno.land/manual@v1.18.0/linking_to_external_code#it-seems-unwieldy-to-import-urls-everywhere&quot;&gt;they recommend in the Deno Manual&lt;/a&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;// deps.ts (naming convention!)
export * as assert from &#39;https://deno.land/std@0.122.0/testing/asserts.ts&#39;;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&amp;quot;Sooo how do I get my fav npm hosted lib into my Deno code then?&amp;quot;, you ask.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Check &lt;a href=&quot;https://deno.land/x&quot;&gt;deno.land/x&lt;/a&gt; if the module is hosted there. There are a lot of Deno
specific modules.&lt;/li&gt;
&lt;li&gt;Import from any of the services below.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Services reading from npm:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.skypack.dev/&quot;&gt;Skypack&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://esm.sh/&quot;&gt;esm.sh&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://unpkg.com/&quot;&gt;unpkg.com&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://cdnjs.com/&quot;&gt;cdnjs.com&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Skypack and esm.sh will actually bundle code from npm into modern ES module syntax. Both of them are
Deno friendly.&lt;/p&gt;
&lt;p&gt;The beauty with these is that if one of them is failing, or if you&#39;re unhappy with the service, you
can just switch out the URL imports in your &lt;code&gt;deps.ts&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Tip: with Skypack and esm.sh (from what I know) you get Typescript types too. esm.sh will do this
automatically, and with Skypack you can append a &lt;code&gt;?dts&lt;/code&gt; query parameter to the imported URL. See
their respective config query parameters: it&#39;s super cool what they can do these days.&lt;/p&gt;
&lt;p&gt;One thing that tripped me up was that it&#39;s not always easy to find a suitable entrypoint file when
importing via URLs. Deno friendly modules has a &lt;code&gt;mod.ts&lt;/code&gt; in the repo somewhere, but often you have
to hunt down a file yourself.&lt;/p&gt;
&lt;h2&gt;Import maps&lt;/h2&gt;
&lt;p&gt;I&#39;ve glossed over the technology that is &lt;a href=&quot;https://github.com/WICG/import-maps&quot;&gt;Import Maps&lt;/a&gt;. In my
own words, I&#39;d say it&#39;s a file where you specify from where the source code&#39;s &lt;code&gt;import&lt;/code&gt; statements
should look for the code to be imported. In a way, it&#39;s emulating npm&#39;s way of looking in
&lt;code&gt;node_modules&lt;/code&gt;, but this is even more powerful.&lt;/p&gt;
&lt;p&gt;If you were annoyed over importing &amp;quot;raw&amp;quot; URLs in the section above, this will save you!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Import map&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
	&amp;quot;imports&amp;quot;: {
		&amp;quot;react&amp;quot;: &amp;quot;https://esm.sh/react@17.0.2&amp;quot;
	}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Source code&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;import React from &#39;react&#39;;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Remember to specify &lt;code&gt;--import-map&lt;/code&gt; for &lt;code&gt;deno run&lt;/code&gt;! Nothing in Deno is implicit: it won&#39;t pick up the
import map by itself.&lt;/p&gt;
&lt;h1&gt;Summary&lt;/h1&gt;
&lt;p&gt;My overall impression of Deno that while it&#39;s new technology, it&#39;s quite mature and well documented.
And if you&#39;ve got a hairy question, you can pop into their Discord server and ask there. The &lt;code&gt;std&lt;/code&gt;
modules are very modern in the way they&#39;re written (compared to Node, which &lt;em&gt;just&lt;/em&gt; got Promise based
APIs…). It&#39;s actually fun to write Javascript code again. I&#39;d attribute that to the decrease of
&amp;quot;Javascript fatigue&amp;quot; in Deno, since there are so many built-in modules you&#39;d previously assume you&#39;d
need to get from a third party.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;When&lt;/strong&gt; (hehe) you install Deno, be sure to do &lt;code&gt;deno help&lt;/code&gt; in a terminal to see the range of nice
sub commands. &lt;code&gt;deno types&lt;/code&gt; and &lt;code&gt;deno doc&lt;/code&gt; are favourites of mine. &lt;code&gt;deno compile&lt;/code&gt; is also cool if
you&#39;re writing a script which should be run as a self contained executable, suitable for
distribution.&lt;/p&gt;
&lt;h1&gt;Appendix: lume&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://lumeland.github.io/&quot;&gt;lume&lt;/a&gt; is a static site generator, built with Deno. I read through the
documentation and jumped around in the source code for a while before I fell in love and ported
johanbrook.com to it.&lt;/p&gt;
&lt;p&gt;Lume is a joy to work with. The built-in functionality and plugins fill 95% of my use cases – very
little custom code needed. And &lt;em&gt;if&lt;/em&gt; I don&#39;t understand the documentation, reading the source code is
no problem.&lt;/p&gt;
&lt;p&gt;It &lt;em&gt;feels&lt;/em&gt; easier to use than other generators I&#39;ve tried (Jekyll, Middleman, Metalsmith, Eleventy)
but yet very powerful. During the porting my code I was not too annoyed during the process:
something that you easily get when trying a brand new site generator. The fact that its written in
Typescript is &lt;em&gt;so&lt;/em&gt; nice, as you get static typing and don&#39;t have to guess what objects and
properties to read.&lt;/p&gt;
&lt;p&gt;Try it out!&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Customising an iOS home screen web app in 2021</title>
    <link href="https://johan.im/writings/ios-homescreen-web-app/" />
    <updated>2021-12-14T00:00:00Z</updated>
    <id>https://johan.im/writings/ios-homescreen-web-app/</id>
    <content type="html">&lt;h2&gt;Background&lt;/h2&gt;
&lt;p&gt;During parental leave, I&#39;ve started to run. Not away from the baby, for heaven&#39;s sakes, but regular
exercise running. I really prioritised keeping it super straight-forward: I refuse wear any kind of
wearable, such an Apple Watch or Garmin in order to track heart rate and so on (I won&#39;t go into why
here, I just don&#39;t need another tech device). But. Even I see the need for tracking basic stats,
like duration, length of run, and average speed. Those are literally the three things I need.&lt;/p&gt;
&lt;p&gt;Let&#39;s see what running apps there are! &lt;em&gt;Opens up App Store.&lt;/em&gt; &amp;quot;Strava, yes I&#39;ve heard about that one.
Runkeeper… that one I&#39;ve used before! ( = a lifetime ago)&amp;quot;. I installed Strava because it was at the
top, and hell begins. It prompts me for an account, which is fair enough I guess, but it still put
me off a bit. It&#39;s also paid. Monthly subscription. And it shows nagging reminders to upgrade to a
paid plan &lt;em&gt;everywhere&lt;/em&gt;. And it has social features, which I of course don&#39;t need. It has so much
&lt;em&gt;stuff&lt;/em&gt; I neither need nor want! As a developer on leave, the only sane thing to do is to write my
own running app.&lt;/p&gt;
&lt;p&gt;Since I&#39;m not a Swift or Objective-C developer (and have no intentions of becoming one), I need to
do it as a web app. Approximately 5 seconds after I decided to develop my own running tracker app I
realise I really must ensure that this single API is available in the iOS browser: being able to
&lt;em&gt;watch&lt;/em&gt; the GPS position as it changes with the
&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API&quot;&gt;Geolocation API&lt;/a&gt;. Thank god,
&lt;code&gt;Geolocation.watchPosition()&lt;/code&gt; exists, and a wave of relief is showering over me. That means I can
watch the position, stash away the raw coordinates, and do things with them. Such as converting to
&lt;a href=&quot;https://geojson.org/&quot;&gt;GeoJSON&lt;/a&gt; in order to calculate the length in kilometers and drawing the route
in an embedded map from Mapbox.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;You can try the final app here: &lt;a href=&quot;https://runloop.pages.dev/&quot;&gt;runloop.pages.dev&lt;/a&gt;. Be sure to add it
to your homescreen.&lt;/li&gt;
&lt;li&gt;The source code for my app is over &lt;a href=&quot;https://github.com/johanbrook/runloop&quot;&gt;at GitHub&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Apple documentation feels out of date&lt;/h2&gt;
&lt;p&gt;I start out by going straight into the horse&#39;s mouth: the Apple documentation on (mobile) Safari.
This should be the truth, and nothing but the truth! I head over to
&lt;a href=&quot;https://developer.apple.com/&quot;&gt;developer.apple.com&lt;/a&gt; and browse to some &amp;quot;Technologies&amp;quot; page where one
can input a &amp;quot;technology&amp;quot;. I put in
&lt;a href=&quot;https://developer.apple.com/documentation/technologies?tags=Safari&quot;&gt;&amp;quot;safari&amp;quot;&lt;/a&gt;. The search results
only yield things that are interesting from a native app perspective, such as embedding web views.&lt;/p&gt;
&lt;p&gt;Okay. I scroll around to the footer, and see
&lt;a href=&quot;https://developer.apple.com/safari/&quot;&gt;&amp;quot;Safari and the web&amp;quot;&lt;/a&gt;. Score! These are the only interesting
links:&lt;/p&gt;
&lt;p&gt;![Apple docs]({{ &amp;quot;apple-docs-safari.png&amp;quot; | postAssetUrl }})&lt;/p&gt;
&lt;p&gt;Clicking that &amp;quot;More&amp;quot; link leads me to the
&lt;a href=&quot;https://developer.apple.com/library/archive/navigation/index.html?filter=safari&quot;&gt;&amp;quot;Documentation Archive&amp;quot;&lt;/a&gt;.
That sounds nice. Latest change as of writing is in June 2018. Gulp.&lt;/p&gt;
&lt;p&gt;Unless I&#39;m missing something, there&#39;s no official Apple documentation on iOS Safari. Except for
browsing through blog posts over at &lt;a href=&quot;https://webkit.org/&quot;&gt;WebKit.org&lt;/a&gt; and other release notes. Note
that I&#39;m talking about proprietary Safari tech – not regular Web APIs you&#39;d find over at MDN.&lt;/p&gt;
&lt;p&gt;My next bet was simply googling around on problems as I encountered them.&lt;/p&gt;
&lt;h2&gt;How to make a web app behave and look nicely on iOS 15 in 2021&lt;/h2&gt;
&lt;p&gt;What follows is a stream of things I encountered while researching how to make a super slick iOS web
app in 2021. My phone is an iPhone 12 mini, and I&#39;m using iOS 15.2 at the time of writing this post.&lt;/p&gt;
&lt;h3&gt;Adding to home screen – don&#39;t forget the icon&lt;/h3&gt;
&lt;p&gt;I knew from before that adding a web page to the iOS home screen grants it special privileges. Like
not
&lt;a href=&quot;https://webkit.org/blog/10218/full-third-party-cookie-blocking-and-more/&quot;&gt;wiping LocalStorage after just 7 days&lt;/a&gt;.
Also, there&#39;s the UX aspect, which is important: adding to the home screen removes the Safari chrome
(UI) and runs the web app in a frameless mode. This is nice.&lt;/p&gt;
&lt;p&gt;This hasn&#39;t changed since last time I looked, thank god. The option is still there in the Safari UI.
It&#39;ll add use the &lt;code&gt;&amp;lt;title&amp;gt;&lt;/code&gt; from your web page as the app title. You need to supply an icon yourself
(iOS will pick a fugly screenshot of your app otherwise).&lt;/p&gt;
&lt;p&gt;Put this in your &lt;code&gt;&amp;lt;head&amp;gt;&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;link rel=&amp;quot;apple-touch-icon&amp;quot; href=&amp;quot;apple-touch-icon.png&amp;quot;&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;where the &lt;code&gt;href&lt;/code&gt; attribute points to a PNG image with the icon file.&lt;/p&gt;
&lt;p&gt;Refer to
&lt;a href=&quot;https://developer.apple.com/design/human-interface-guidelines/ios/icons-and-images/app-icon/&quot;&gt;Apple&#39;s official guide on icons&lt;/a&gt;
for sizes, since you can control which icon file that goes with which size, like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;link rel=&amp;quot;apple-touch-icon&amp;quot; sizes=&amp;quot;152x152&amp;quot; href=&amp;quot;touch-icon-ipad.png&amp;quot;&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;Viewport settings&lt;/h3&gt;
&lt;p&gt;The single most important thing you&#39;d want to do is to set the viewport width to the width of the
device. This is old school, but important:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;meta name=&amp;quot;viewport&amp;quot; content=&amp;quot;width=device-width, initial-scale=1.0&amp;quot; /&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If you feel like disabling the pinch-to-zoom behaviour of web pages, tack on an &lt;code&gt;user-scalable=no&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;meta name=&amp;quot;viewport&amp;quot; content=&amp;quot;width=device-width, initial-scale=1.0, user-scalable=no&amp;quot; /&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For me, I wanted more native feel, so I disabled zoom. Even though it&#39;s a bit user hostile. But the
user in this case is me, so I don&#39;t care.&lt;/p&gt;
&lt;h3&gt;Frameless mode and &lt;code&gt;manifest.json&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;The next most important thing is to tell iOS that we&#39;d like to run the web app in &amp;quot;frameless mode&amp;quot;,
or &amp;quot;without the browser chrome&amp;quot;. Otherwise your home screen web app icon only leads to a web page,
and thus merely becomes a shortcut. We want it to feel like an app!&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;meta name=&amp;quot;apple-mobile-web-app-capable&amp;quot; content=&amp;quot;yes&amp;quot; /&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This still is the way to tell iOS to hide the address bar and all that.&lt;/p&gt;
&lt;p&gt;But. When I clicked around on internal links in my app, I saw the browser chrome appear for every
link click! It would suck if Apple had crippled mobile web apps in this way, but I wasn&#39;t too
surprised after all – this is Apple.&lt;/p&gt;
&lt;p&gt;I started reading about
&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/Manifest&quot;&gt;&amp;quot;Web app manifests&amp;quot;&lt;/a&gt;. Those manifests is a
JSON file which tells the browser more things when it runs the app in &amp;quot;PWA&amp;quot; (Progressive Web App)
mode. I&#39;s mainly about customising presentation, such as titles, icons, splash screens, etc. So I
sort of wrote it off at first, and also thought Apple wouldn&#39;t care about these kinds of valiant
efforts by the web community.&lt;/p&gt;
&lt;p&gt;But I was wrong. I stuck a simple &lt;code&gt;manifest.json&lt;/code&gt; in my root directory and linked it from my HTML:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;link rel=&amp;quot;manifest&amp;quot; href=&amp;quot;/manifest.json&amp;quot; /&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&quot;language-json&quot;&gt;{
	&amp;quot;name&amp;quot;: &amp;quot;Runloop&amp;quot;,
	&amp;quot;scope&amp;quot;: &amp;quot;/&amp;quot;,
	&amp;quot;display&amp;quot;: &amp;quot;standalone&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I&#39;m not sure whether it was the &lt;code&gt;scope&lt;/code&gt; or &lt;code&gt;display&lt;/code&gt; parameter that made the internal links work
without chrome again, but this did the trick! iOS Safari &lt;em&gt;is&lt;/em&gt; parsing this file after all. And I
have no idea why the &lt;code&gt;apple-mobile-web-app-capable&lt;/code&gt; tag won&#39;t cut it, but oh well. This feels like
an extra guard to &lt;em&gt;really&lt;/em&gt; tell the system that my app is running standalone without any browser
chrome (&amp;quot;please&amp;quot;).&lt;/p&gt;
&lt;h3&gt;Using the whole screen on iPhone models with notches&lt;/h3&gt;
&lt;p&gt;My iPhone 12 mini has a notch, and is thus not a perfect rectangular display. We can tell the web
app to use the whole display with this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;meta name=&#39;viewport&#39; content=&#39;initial-scale=1, viewport-fit=cover&#39; /&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;That is, adding &lt;code&gt;viewport-fit=cover&lt;/code&gt; to the &lt;code&gt;viewport&lt;/code&gt; meta tag. Otherwise, Safari will play it safe
and make sure your app lives within a rectangular area far away from the notch.&lt;/p&gt;
&lt;p&gt;Apple is kind and provides tech for us in order to avoid colliding with the notch and the virtual
home button at the bottom of the iPhone screen.
&lt;a href=&quot;https://webkit.org/blog/7929/designing-websites-for-iphone-x/&quot;&gt;I recommend reading this article&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Basically, we&#39;ve got four &lt;code&gt;env()&lt;/code&gt; values to use:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-css&quot;&gt;env(safe-area-inset-top)
env(safe-area-inset-bottom)
env(safe-area-inset-left)
env(safe-area-inset-right)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;env()&lt;/code&gt; works where &lt;code&gt;var()&lt;/code&gt; works – even inside &lt;code&gt;calc()&lt;/code&gt;, which is nice. For instance, this is the
styling for my bottom &lt;code&gt;NavBar&lt;/code&gt; component:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-css&quot;&gt;.NavBar {
  padding: var(--inset);
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
  padding-left: max(env(safe-area-inset-left), var(--inset));
  padding-right: max(env(safe-area-inset-right), var(--inset));
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;--inset&lt;/code&gt; is set on &lt;code&gt;:root&lt;/code&gt;, and is the &amp;quot;global padding&amp;quot; in my app. As you can see, I use it with
the &lt;code&gt;max()&lt;/code&gt; function to make the left and right padding be whatever&#39;s the max value of the safe area
and my inset.&lt;/p&gt;
&lt;h3&gt;Styling taps on links and buttons&lt;/h3&gt;
&lt;p&gt;Since the arrival of the first iOS (&amp;quot;iPhone OS&amp;quot;?), it&#39;s been tricky to style taps on interactive
elements. Such as a different background on a button when you tap it. &lt;code&gt;:active&lt;/code&gt; and &lt;code&gt;:hover&lt;/code&gt; pseudo
selectors are both weird and strangely enough don&#39;t manage to produce that native feel.&lt;/p&gt;
&lt;p&gt;In 2021, turns your all you have to is adding a single no-op touch listener, and then you can use
&lt;code&gt;:active&lt;/code&gt; as it&#39;s intended to:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-js&quot;&gt;// Adding an empty touch listener will make :active CSS pseudo selector
// work in order to style taps on elements. Joy.
document.addEventListener(&#39;touchstart&#39;, (evt) =&amp;gt; {});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Insert that snippet somewhere in your JS, and off you go.&lt;/p&gt;
&lt;h3&gt;Making the app be 100% height and don&#39;t show scrollbars&lt;/h3&gt;
&lt;p&gt;You thought this was the kind of stuff you&#39;d stop put up with in 2021? Think again. &lt;code&gt;100vh&lt;/code&gt; won&#39;t do
what you think it does, and Apple devs think it works &amp;quot;as intended&amp;quot;.
&lt;a href=&quot;https://chanind.github.io/javascript/2019/09/28/avoid-100vh-on-mobile-web.html&quot;&gt;Read more here&lt;/a&gt; for
a demonstration. I almost can&#39;t muster strength to explain it all, but the gist of it is that the
browser chrome in mobile Safari is dynamic in height and take up space. This affects the &lt;code&gt;vh&lt;/code&gt; unit
and produces overflow.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.bram.us/2021/07/08/the-large-small-and-dynamic-viewports/&quot;&gt;Dynamic viewports&lt;/a&gt; will fix
this. But until then, I went with a boring Javascript fix:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;let lastHeight: number | null = null;

const setAppHeight = debounce(() =&amp;gt; {
	const doc = document.documentElement;
	const height = window.innerHeight;

	if (height != lastHeight) {
		doc.style.setProperty(&#39;--app-height&#39;, `${height - MAGIC_NUMBER}px`);
		lastHeight = height;
	}
}, 100);

// This is the magic offset which one can subtract in order to hide scrollbars
// AT LEAST ON MY PHONE. YMMV.
const MAGIC_NUMBER = 3;

/** This is solving the STILL outstanding problem of using
 * height: 100vh on Mobile Safari. The problem is outlined here:
 * https://chanind.github.io/javascript/2019/09/28/avoid-100vh-on-mobile-web.html
 *
 * Instead, we control the height of a CSS variable which is mirroring
 * the window.innerHeight property.
 */
const fixMobileHeight = () =&amp;gt; {
	window.addEventListener(&#39;resize&#39;, setAppHeight);

	setAppHeight();

	return () =&amp;gt; window.removeEventListener(&#39;resize&#39;, setAppHeight);
};

// Util
const debounce = (func: (...args: unknown[]) =&amp;gt; unknown, wait: number) =&amp;gt; {
	let timeout: NodeJS.Timeout;

	return (...args: unknown[]) =&amp;gt; {
		const later = () =&amp;gt; {
			clearTimeout(timeout);
			func(...args);
		};

		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
	};
};

fixMobileHeight();
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&quot;language-css&quot;&gt;#app {
  min-height: var(--app-height);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We use the &lt;code&gt;resize&lt;/code&gt; event which fires on &lt;code&gt;window&lt;/code&gt; to set a CSS variable, which we can use in our
stylesheet. It has some guards so that we won&#39;t fire it too often.&lt;/p&gt;
&lt;h3&gt;Dark mode&lt;/h3&gt;
&lt;p&gt;Don&#39;t forget enabling dark mode so Safari can style native elements:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-css&quot;&gt;:root {
  color-scheme: light dark;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This is controllable from a tag within &lt;code&gt;&amp;lt;head&amp;gt;&lt;/code&gt; too (which I guess is faster since the browser
doesn&#39;t have to download and parse the CSS to decide).&lt;/p&gt;
&lt;h3&gt;Theme colours&lt;/h3&gt;
&lt;p&gt;This is new, and very marketed by Apple dev evangelists: the possibility to set the &amp;quot;theme colour&amp;quot;,
which makes Safari use a configured colour of your choice in the browser chrome. Safari is trying to
be smart, and defaults to the &lt;code&gt;background-color&lt;/code&gt; on your &lt;code&gt;html&lt;/code&gt; or &lt;code&gt;body&lt;/code&gt; elements, but sometimes
you need to set it on your own:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;meta name=&amp;quot;theme-color&amp;quot; content=&amp;quot;#fff&amp;quot; media=&amp;quot;(prefers-color-scheme: light)&amp;quot; /&amp;gt;
&amp;lt;meta name=&amp;quot;theme-color&amp;quot; content=&amp;quot;#000&amp;quot; media=&amp;quot;(prefers-color-scheme: dark)&amp;quot; /&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;System colours&lt;/h3&gt;
&lt;p&gt;Speaking of colours: dark mode isn&#39;t cool, you know what&#39;s cool? System colours (that joke fell…). I
stumbled upon this blog post:
&lt;a href=&quot;https://blog.jim-nielsen.com/2021/css-system-colors/&quot;&gt;&amp;quot;CSS System Colors&amp;quot;&lt;/a&gt;. The author emphasised
not hard coding any colours for light and dark modes. Instead, he lets the system decide from
sensible defaults. For a website or app without need for any special branding, this is probably what
you want.&lt;/p&gt;
&lt;p&gt;But what do you do when you actually want to &lt;em&gt;use&lt;/em&gt; one of these system colours elsewhere in your
CSS? That&#39;s the core question in the linked blog post, I&#39;ll let you read it.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;tldr&lt;/em&gt;: there are &amp;quot;system colors&amp;quot; defined in the
&lt;a href=&quot;https://drafts.csswg.org/css-color/#css-system-colors&quot;&gt;CSS spec&lt;/a&gt;, which you can use like any other
colour:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-css&quot;&gt;.dropdown {
  background-color: Canvas;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Of course, there&#39;s a bug (?) in iOS, so &lt;code&gt;Canvas&lt;/code&gt; backgrounds don&#39;t work properly. The blog post
suggests using the &lt;code&gt;-apple-system-control-background&lt;/code&gt; value as a hack, and it works. Copied from the
post:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-css&quot;&gt;/* Defaults/fallbacks for 1) */
:root {
  --color-bg: #fff;
  --color-text: #222;
}

/* 1) For browsers that don’t support `color-scheme` and therefore
   don&#39;t handle system dark mode for you automatically 
   (Firefox), handle it for them. */
@supports not (color-scheme: light dark) {
  html {
    background: var(--color-bg);
    color: var(--color-text);
  }
}

/* 2) For browsers that support automatic dark/light mode
   As well as system colors, set those */
@supports (color-scheme: light dark) and (background-color: Canvas) and (color: CanvasText) {
  :root {
    --color-bg: Canvas;
    --color-text: CanvasText;
  }
}

/* 3) For Safari on iOS. Hacky, but it works. */
@supports (background-color: -apple-system-control-background) and (color: text) {
  :root {
    --color-bg: -apple-system-control-background;
    --color-text: text;
  }
}

html {
  background-color: var(--color-bg);
  color: var(--color-text);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This worked for me. Now I can use &lt;code&gt;--color-bg&lt;/code&gt; wherever I want to use the (dynamic, non hard coded)
background colour.&lt;/p&gt;
&lt;h3&gt;Disabling selecting text&lt;/h3&gt;
&lt;p&gt;This also goes in the &amp;quot;user hostile&amp;quot; department. Use are your own discretion:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-css&quot;&gt;html {
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;Use an iOS-y font stack&lt;/h3&gt;
&lt;p&gt;I went with this, to get the SF font:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-css&quot;&gt;font-family: -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, &#39;Roboto&#39;, &#39;Oxygen&#39;, &#39;Ubuntu&#39;, &#39;Cantarell&#39;,
        &#39;Fira Sans&#39;, &#39;Droid Sans&#39;, &#39;Helvetica Neue&#39;, sans-serif;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;After all these fixes, my app finally felt pretty good to use on an iPhone. It looked gorgeous in
dark mode, the typography was great, it felt snappy navigating around, and not like a wEbSiTe at
all.&lt;/p&gt;
&lt;p&gt;I&#39;m most impressed over how easy it is to make the &lt;em&gt;styling&lt;/em&gt; look nice. Before iOS 7, when we were
in skeumorphism land, it was a pain to make web apps blend into the system. Now it&#39;s just some
typography, spacing, and default colours, and we&#39;ve come a long way. If you just &amp;quot;know&amp;quot; how a
typical iOS app looks like – with list views, headings and so on – I bet you&#39;ll get something that
looks decent in no time thanks to the CSS snippets I&#39;ve posted throughout the text.&lt;/p&gt;
&lt;p&gt;I was most surprised over the show-chrome-on-link-tap thing in the home screen app. I had no idea
one needed to use a Webmanifest JSON file to get rid of that. I&#39;ve found &lt;em&gt;very little&lt;/em&gt; documentation
on iOS&#39; use of the web manifest file too.&lt;/p&gt;
&lt;h3&gt;Nice Web APIs&lt;/h3&gt;
&lt;p&gt;Overall, Web APIs have gone a long way with I/O: we can now upload, download, and &lt;em&gt;share&lt;/em&gt; files in
iOS. I built and export and import feature to try this out, and it worked great on mobile:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;const doImport = async (evt: Event) =&amp;gt; {
	const { files } = evt.target as HTMLInputElement;

	const file = files[0];

	if (file.type != &#39;application/json&#39;) {
		alert(&#39;Only JSON files, please.&#39;);
		return;
	}

	try {
		const json = JSON.parse(await file.text());
		// do stuff with object
	} catch (ex) {
		console.error(ex);
		alert(`Failed to read &amp;quot;${file.name}&amp;quot;. Reason: ${ex}`);
	}
};

document.findElementById(&#39;import&#39;)!.addEventListener(&#39;change&#39;, doImport);
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&amp;lt;input type=&amp;quot;file&amp;quot; id=&amp;quot;import&amp;quot; accept=&amp;quot;application/json&amp;quot; /&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Exporting works good with the
&lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share&quot;&gt;Share API&lt;/a&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-ts&quot;&gt;const doExport = async () =&amp;gt; {
	try {
		// Will show native iOS share pane
		await navigator.share({
			title: &#39;Run data as JSON&#39;,
			files: [fileOf(appConf)],
		});
	} catch (ex) {
		if ((ex as DOMException).name == &#39;AbortError&#39;) return;
		alert(`Sharing failed. Reason: ${(ex as Error).message || ex}`);
		console.error(ex);
	}
};

const fileOf = (data: unknown): File =&amp;gt;
	new File([JSON.stringify(appConf, null, 4)], &#39;runloop.json&#39;, {
		type: &#39;application/json&#39;,
	});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The user now gets the choice of saving the file somewhere, or sending it with the native UI
controls.&lt;/p&gt;
&lt;h2&gt;Epilogue&lt;/h2&gt;
&lt;p&gt;The irony is that my running tracker app didn&#39;t work &lt;em&gt;at all&lt;/em&gt; out in the wild… Turns out that the
system turns off any background geolocation services when the screen is locked – which totally is
the case when I&#39;m running. And there&#39;s no Geolocation in Service Workers or similar background magic
place. Argh.&lt;/p&gt;
&lt;p&gt;See it in action here: &lt;a href=&quot;https://runloop.pages.dev/&quot;&gt;runloop.pages.dev&lt;/a&gt;.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>An Even Better Spaghetti Bolognese</title>
    <link href="https://johan.im/writings/better-spaghetti-bolognese/" />
    <updated>2021-11-02T00:00:00Z</updated>
    <id>https://johan.im/writings/better-spaghetti-bolognese/</id>
    <content type="html">&lt;p&gt;This is a continuation (sequel? remix?) on the post
&lt;a href=&quot;https://johan.im/writings/my-spaghetti-bolognese&quot;&gt;&amp;quot;My Spaghetti Bolognese&amp;quot;&lt;/a&gt;. In that one, I wrote about a spaghetti
bolognese recipe which I thought I&#39;d, pretentious as I am, perfected over the years.&lt;/p&gt;
&lt;p&gt;We recently spent a month in Florence, Italy, where we stayed with a host family. For one birthday
party for their grandchild, the family father had made a ragú sauce served with penne pasta. The
sauce was amazing: rich, juicy, and smooth. I asked for the recipe, and will present it in this
post.&lt;/p&gt;
&lt;h2&gt;The ingredients&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;1-2 finely chopped garlic cloves.&lt;/li&gt;
&lt;li&gt;500g of minced pork and beef meat.&lt;/li&gt;
&lt;li&gt;1-2 celeries.&lt;/li&gt;
&lt;li&gt;1-2 carrots.&lt;/li&gt;
&lt;li&gt;1 onion (preferrably red).&lt;/li&gt;
&lt;li&gt;750g passata (tomato sauce). I ended up adding 1200g of passata since I wanted a saucier feeling.&lt;/li&gt;
&lt;li&gt;1 glass red wine.&lt;/li&gt;
&lt;li&gt;Sugar (optional).&lt;/li&gt;
&lt;li&gt;Meat broth (optional).&lt;/li&gt;
&lt;li&gt;Plenty of olive oil.&lt;/li&gt;
&lt;li&gt;Salt and pepper.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For the celery, carrot, and onion: the individual units aren&#39;t as important as the ratio between
them. The recipe I received said: &amp;quot;The same amount of celery and onion, a little less carrot&amp;quot;.&lt;/p&gt;
&lt;p&gt;The amount of olive oil is something one needs to freewheel. I usually go with covering the whole
pot with almost one centimeter of oil (depending on the size of pot, of course). There&#39;s a lot of
fat coming from the pork part in the meat, so beware: &lt;em&gt;that&lt;/em&gt; much oil might not be required.&lt;/p&gt;
&lt;h2&gt;The steps&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Fry the garlic in a pot or deep pan with plenty of olive oil. Garlic should be added when the oil
is hot.&lt;/li&gt;
&lt;li&gt;Add the meat, and brown it well.&lt;/li&gt;
&lt;li&gt;When the meat is well cooked, add a finely chopped mixture of celery, carrots, and onion.&lt;/li&gt;
&lt;li&gt;When the mixture is cooked, add the passata. Add salt to taste, as well as some ground pepper.&lt;/li&gt;
&lt;li&gt;Wait for the sauce to boil, and add a glass of wine. Wait for it to evaporate completely.&lt;/li&gt;
&lt;li&gt;Cook over very low heat for at least 30 minutes. If the sauce is too acidic, add a teaspoon of
sugar. If it&#39;s too dry, add a little meat broth.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;(I&#39;ve never needed meat broth in this recipe. There&#39;s just no way I&#39;ve managed to get it too dry.)&lt;/p&gt;
&lt;p&gt;You can let it sit on the stove without a lid for a couple of hours if you&#39;d like. Or put it on very
low heat in the oven (around 100 degrees celsius in my convection oven seemed fine over 5 hours of
cooking). I&#39;m not actually sure what the benefits with the oven are – perhaps the sauce becomes
different if you heat it from all directions? Who knows.&lt;/p&gt;
&lt;p&gt;When serving with pasta, don&#39;t forget to add around a deciliter of pasta water to the sauce at the
end. It &amp;quot;really ties the sauce together&amp;quot;, as they say. Parmesan or pecorino is nice to offer too.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Done.&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;Differences from the other recipe&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;50/50 pork and beef instead of 100% beef. The 50/50 mix makes for a more fatty and tasty sauce,
thanks to the pork.&lt;/li&gt;
&lt;li&gt;Cooking the onion, carrots, and celery in the meat instead of sautéing them. This felt kind of
weird to me first, since &lt;em&gt;all&lt;/em&gt; recipes I read say that you should fry the onion, garlic, carrot,
and celery in the pot before adding the meat. I&#39;m not sure about the difference.s&lt;/li&gt;
&lt;li&gt;Use of more olive oil.&lt;/li&gt;
&lt;li&gt;Use of meat broth (if needed).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This recipe felt simpler but still as good too, which I think should be the goal in cooking. The
other recipe has ten steps, this one only has six steps.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Recently in books II</title>
    <link href="https://johan.im/writings/recently-in-books-ii/" />
    <updated>2020-12-31T00:00:00Z</updated>
    <id>https://johan.im/writings/recently-in-books-ii/</id>
    <content type="html">&lt;p&gt;This is a long overdue post on some books I&#39;ve read since the
&lt;a href=&quot;https://johan.im/writings/recently-in-books&quot;&gt;last update&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;&amp;quot;Ishmael&amp;quot; by Daniel Quinn&lt;/h2&gt;
&lt;p&gt;My father in law borrowed me this one, not without a glimpse in his eye. It&#39;s hard to describe this
novel. It&#39;s not what it seems to be in the first few pages, which is about a man who starts talking
with a gorilla via telepathy. The bulk of the novel is the philosophical conversation between the
odd couple, where the gorilla acts as the teacher for the man, who acts as narrator.&lt;/p&gt;
&lt;p&gt;My immediate thoughts about this book are these:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;It&#39;s &lt;em&gt;really&lt;/em&gt; &amp;quot;on topic&amp;quot; right now (year 2020).&lt;/li&gt;
&lt;li&gt;It&#39;s eye opening, challenging, provoking, and story telling.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;For the first point: one of the book&#39;s core themes is around planet Earth – the environment and how
we humans are ruining it. Whereas other books in the climate genre is a lot of numbers and &lt;em&gt;facts&lt;/em&gt;,
&amp;quot;Ishmael&amp;quot; tells a different, more philosophical, story.&lt;/p&gt;
&lt;p&gt;The second point: the book does exactly what (I think) a philosophical novel should do. It taught me
things and how to see myself, my culture, and whole of humanity and its history in a different
light. I knew already that our modern culture – capitalist and infinte-growth aspiring – isn&#39;t
viable and sustainable. &amp;quot;Ishmael&amp;quot; confirms those thoughts by anchoring them in a spiritual and
cultural arguments, using terms as &lt;em&gt;Myths, Stories, and Cultures&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;The book affected me in the sense of reiterating that &lt;em&gt;Balance is everything&lt;/em&gt;. Humans have messed up
that ecological balance in nature, by telling ourselves we&#39;re &lt;em&gt;above&lt;/em&gt; the laws of nature, and that
we possess the power of deciding over &amp;quot;who&#39;s to die, and who&#39;s to survive&amp;quot;.&lt;/p&gt;
&lt;p&gt;If you can bare with the kind of long introductory part, I&#39;d really recommend getting through it.
Pair it up with the popular science piece &amp;quot;Sapiens&amp;quot; for a full picture.&lt;/p&gt;
&lt;h2&gt;&amp;quot;Cosa Nostra&amp;quot; by John Dickie&lt;/h2&gt;
&lt;p&gt;A non-fiction book about the Sicilian mafia - the Cosa Nostra.&lt;/p&gt;
&lt;p&gt;I had a real &amp;quot;mobster Spring&amp;quot; where I went through a couple of mafia movies and books (this and the
next one I write about below). Am I getting this old already?! I like good non-fiction books, and
this one was good. It&#39;s essentially about how the mafia grew from local gangs in Sicily in the
1800s, into a loose but worldwide organisation in the 1900s.&lt;/p&gt;
&lt;p&gt;It&#39;s a fascinating read if you&#39;re that kind of person. Note that the author focuses mostly on the
Sicilian mafia, and not the American offspring that was born in the early 1900s. Perfect vacation
paperback read, I&#39;d say.&lt;/p&gt;
&lt;h2&gt;&amp;quot;The Godfather&amp;quot; by Mario Puzo&lt;/h2&gt;
&lt;p&gt;Here we go. The absolute number one piece of mafia literature.&lt;/p&gt;
&lt;p&gt;I&#39;ve seen the movie(s) countless of times, but still enjoyed the book &lt;em&gt;a lot&lt;/em&gt;. That&#39;s because Puzo&#39;s
language and skill in writing a captivating plot is outstanding. Everything is intense: the
dialogue, the characters, the situations.&lt;/p&gt;
&lt;p&gt;It, naturally, does a better job telling the backstories of the characters of the Corleone crime
family than the movies. I&#39;m usually a sucker for the fates of &amp;quot;anti heroes&amp;quot;, such as Michael
Corleone: about their early innocence, ascent to something they did not anticipate, and final fall
from their throne (this is not pictured in &amp;quot;The Godfather&amp;quot;).&lt;/p&gt;
&lt;p&gt;In the end, what fascinates me with Puzo&#39;s work is his way of creating emotional bonds between the
reader and the characters (while you &lt;em&gt;know&lt;/em&gt; they&#39;re bad!) but in an ice cold way describe horrible
fates and acts.&lt;/p&gt;
&lt;h2&gt;&amp;quot;Herakles&amp;quot; by Theodor Kallifatides&lt;/h2&gt;
&lt;p&gt;The author is born in Greece but now lives and works in Sweden. The book is a fiction novel about
the Greek hero Hercules (&amp;quot;Herakles&amp;quot; in Swedish). I think everybody knows the core story, from the
Disney movie or from the origin myth, in one way or another. This book is more detailed, dramatised
version of the original story about the hero&#39;s adventures.&lt;/p&gt;
&lt;p&gt;I&#39;ve always loved reading about religion and myths. I recall revisiting a factbook about Greek
mythology my parents had when I was little, so all the names are stuck with me.&lt;/p&gt;
&lt;p&gt;The book focuses on Hercules&#39; birth, upbringing, adventures, and death – an all the sorrow and
tragedies therein. Greek mythology is full of tragedy! So when you read about our hero, there are a
couple of moments of &amp;quot;Goddammit Hercules, now you &lt;em&gt;really&lt;/em&gt; screwed up!&amp;quot;. And he screwed up &lt;em&gt;a lot&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;I liked the personal tone the author writes in. The style is modern but serious. Howver, it still
contains that sterile prose in the way that these old myths should be told in. &amp;quot;Oh, Hercules beat
somebody to death with his bare hands. No big deal, carry on&amp;quot;. But &amp;quot;Herakles&amp;quot; manages to go beyond
the regular death and violence in the myth, and add some everyday empathy for our hero. And that, I
appreciate: some nuance.&lt;/p&gt;
&lt;p&gt;In the end, it&#39;s a good story.&lt;/p&gt;
&lt;h2&gt;&amp;quot;Normal People&amp;quot; by Sally Rooney&lt;/h2&gt;
&lt;p&gt;A book praised by critics, winner of great awards, made into television series. &amp;quot;Normal People&amp;quot; is
about a guy (Connell) and a girl (Marianne) in a high school in Ireland. They develop a non-trivial
romantic and physical relationship, and we get to follow them over the years they&#39;re together and
apart.&lt;/p&gt;
&lt;p&gt;I like the very boiled down stories in these kinds of plots. The variations are usually infinite,
and the quality of the work is determined by the prose and flow in the text. Sally Rooney writes
wonderfully. The core plot of &amp;quot;boy and girl like each other but it&#39;s complicated&amp;quot; is taken care of
very delicately. As mentioned, everything is very boiled down, and the text follows both Connell and
Marianne in their thoughts. The pacing is good, as a new chapter might bring a jump over a few years
in their lives.&lt;/p&gt;
&lt;p&gt;The author manages to capture That Feeling that occurs in romantic relationships in the ages 18-30.
On the inside, you&#39;re ready to explode by a broken heart, but on the outside it&#39;s &amp;quot;Oh god, why do
you kids make it so complated?! Just talk to her/him!&amp;quot;. Stuff in &amp;quot;Normal People&amp;quot; &lt;em&gt;is&lt;/em&gt; complicated.
Rooney brings that forward, drags it out, and makes sure that the characters themselves don&#39;t know
what they want over the course of the novel.&lt;/p&gt;
&lt;p&gt;There&#39;s also darkness in the shapes of abusive relationships, tragic family history, social class
issues, depression, jealousy, drugs, and alcohol. The whole buffet of adolescent troubles, that is.
The text treats these subjects in a very cold and objective manner. They are slowly appearing
throughout the storyline, like bad mold spots in a cheese.&lt;/p&gt;
&lt;p&gt;I enjoyed this book. It doesn&#39;t bring anything new to the table, but it doesn&#39;t have to. The prose
and the strong characters in Connell and Marianne do enough.&lt;/p&gt;
&lt;p&gt;(I actually watched the TV series before reading the book, and the former does a pretty good job
capturing the bleakness and desperation from the book. The acting and camera in the series are
terrific.)&lt;/p&gt;
&lt;h2&gt;&amp;quot;About A Boy&amp;quot; by Nick Hornby&lt;/h2&gt;
&lt;p&gt;I think most people have seen the film, but now I got around reading the book.&lt;/p&gt;
&lt;p&gt;It&#39;s good. It&#39;s fun. It&#39;ll entertain you for some days. It&#39;s got darkness coupled with absurdity,
all tied together in weird conversations and thought patterns of the main characters. The
Britishisms in Nick Hornby&#39;s language are everywhere.&lt;/p&gt;
&lt;p&gt;I don&#39;t think I have anything more to say.&lt;/p&gt;
&lt;p&gt;(Hugh Grant literally &lt;em&gt;is&lt;/em&gt; Will Freeman to me.)&lt;/p&gt;
&lt;h2&gt;&amp;quot;Jag Kan Ha Fel&amp;quot; by Björn Natthiko Lindeblad&lt;/h2&gt;
&lt;p&gt;(This is a Swedish book 🇸🇪.)&lt;/p&gt;
&lt;p&gt;Björn dropped out of a brilliant career in economics in his mid-twenties and became a Buddhist monk
in the jungles of Thailand. He stayed a monk for 17 years. This book is about his time as a monk,
and what happened afterwards. Like raisins in the cake, he mixes in quotes, conversations, and
thoughts from himself and Buddhist friends. To be honest, I came for &amp;quot;the wisdom&amp;quot;, but was touched
by the author&#39;s story.&lt;/p&gt;
&lt;p&gt;Björn received some help in writing the book, and the text is very tender, personal, and humorous.
Björn has a lot of humour! This is also my first real look into a Buddhist monastery environment,
and it&#39;s very enlightening (pun intended). Björn&#39;s story gave me a human insight into the Buddhist
monk lifestyle and daily life. He attended both Western and Thai monasteries while in Thailand, and
later moved to British and Swiss monasteries. It was really interesting to hear about the mix of
different people in the Thai monasteries: they are very diverse. Both culture wise, but also in
personalities, as some people really aren&#39;t doing the hardcore, stereotypical monk thing. They&#39;re
just there because they had nothing else to do.&lt;/p&gt;
&lt;p&gt;The story is also personal, as it describes how Björn and his family dealt with the passing of his
dad (by euthanasia). It continues with Björn finding love, and ultimately about his own fate in
getting the diagnose of the ALS disease.&lt;/p&gt;
&lt;p&gt;Everything in this book is &lt;em&gt;so&lt;/em&gt; human. It touches upon a lot of stages in life, and thanks to that
concerns us all. Like a universal book in a very light hearted but well put language. The author
isn&#39;t out for doing some self-help Buddhist thing aimed at Western readers. It&#39;s his own life where
he shares his thoughts, fears, and experiences. It is what it is.&lt;/p&gt;
&lt;p&gt;(For Swedes, I recommend &lt;a href=&quot;https://sverigesradio.se/avsnitt/1518766&quot;&gt;Björn&#39;s talk in &amp;quot;P1 Sommar&amp;quot;&lt;/a&gt;
from June, 2020.)&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Building a small, functional reactive app architecture</title>
    <link href="https://johan.im/writings/frp-app-arch/" />
    <updated>2020-05-01T00:00:00Z</updated>
    <id>https://johan.im/writings/frp-app-arch/</id>
    <content type="html">&lt;p&gt;At &lt;a href=&quot;https://lookback.io/&quot;&gt;Lookback&lt;/a&gt;, we&#39;ve fallen in love with functional reactive programming (FRP)
with streams in our frontend apps. Together with the use of Typescript for compile time type safety,
we&#39;ve seen a tremendous bump in overall stability and fewer runtime bugs. Actually, I dare to say
that &lt;em&gt;all&lt;/em&gt; of our bugs so far have been either logic (programmer) or timing errors.&lt;/p&gt;
&lt;h2&gt;What this text is and what it&#39;s not&lt;/h2&gt;
&lt;p&gt;We&#39;ll look at how &lt;em&gt;easy&lt;/em&gt; it actually is to build these kind of frontend architectures on your own.
This architecture is, to be clear, &lt;em&gt;not&lt;/em&gt; any new or novel idea at all. As you will read below, it&#39;s
essentially a rip-off of a library called CycleJS, but less general and made to work with React as a
view before CycleJS had proper React support.&lt;/p&gt;
&lt;p&gt;What we&#39;ll go through is how one can reason about state, side effects, and drawing the view with the
data structure streams. In the end, we have the complete library.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I&#39;ll assume knowledge about streams in this post.&lt;/strong&gt; With &amp;quot;streams&amp;quot;, I don&#39;t mean the
&lt;a href=&quot;https://nodejs.org/api/stream.html&quot;&gt;NodeJS Stream API&lt;/a&gt;, but the functional streams popularised by
libraries such as RxJS, BaconJS, and xstream. The xstream library will be used for reactive streams,
but the concepts are applicable to any streams implementation with the basic operations. I will also
use Typescript features to model the architecture.&lt;/p&gt;
&lt;p&gt;An architecture based on functional reactive stream isn&#39;t for all frontend apps. Vanilla React
paired with the Context API a reducer is probably fine in most cases. We use FRP in our Live player,
and in our Chrome extension. Both codebases need to handle the complexities of multi-peer
audio/video streaming, fetching data from a GraphQL API, client state, server state, connection
problems, interrupts, problems with the mic and camera, subscribing to server data. Even with
Typescript, I wouldn&#39;t want to model that in a Flux based React application. FRP has helped us
handle the data flows in a concise manner across the app, with the help from cozy declarative
constructs as &lt;code&gt;map&lt;/code&gt;, &lt;code&gt;filter&lt;/code&gt;, and so on. It&#39;s pretentious to say, but I almost feel &amp;quot;the code
writes itself&amp;quot; when building out the streams for the data flows.&lt;/p&gt;
&lt;h2&gt;The code&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;This is not some kind of new framework.&lt;/strong&gt; Many others already exist. The repository linked below
is solely for demonstration, and to hold the final code:&lt;/p&gt;
&lt;p class=&quot;tc&quot;&gt;
  &lt;a href=&quot;https://github.com/lookback/frap&quot; class=&quot;btn&quot;&gt;✨ lookback/frap on GitHub&lt;/a&gt;
&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;frap&lt;/em&gt; is for &lt;strong&gt;F&lt;/strong&gt;unctional &lt;strong&gt;R&lt;/strong&gt;eactive &lt;strong&gt;Ap&lt;/strong&gt;plication.&lt;/li&gt;
&lt;li&gt;🔨 ~20 Kb minified.&lt;/li&gt;
&lt;li&gt;📉 Has a single dependency (the &lt;code&gt;xstream&lt;/code&gt; library).&lt;/li&gt;
&lt;li&gt;🏄‍♂️ The core API consists of two functions.&lt;/li&gt;
&lt;li&gt;🤝 Agnostic about the view, but assumes a stream based application.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Why?&lt;/h2&gt;
&lt;p&gt;For me personally, it was all about the joy of constructing an architecture I could understand the
smallest parts of, and then extracting it to make it general.&lt;/p&gt;
&lt;p&gt;It also felt good not using a 3rd party package, except for &lt;code&gt;xstream&lt;/code&gt;, to solve a thing.&lt;/p&gt;
&lt;h2&gt;Credits&lt;/h2&gt;
&lt;p&gt;The main brain behind the architecture is my colleague &lt;a href=&quot;https://twitter.com/algstn&quot;&gt;Martin&lt;/a&gt;. He was
the drive behind the functional patterns as we pair programmed to build the architecture for
Lookback&#39;s Live player. The extraction and generalisation was made by me. As mentioned, the
extraction and this post serves as a learning experience for myself too.&lt;/p&gt;
&lt;h2&gt;Background&lt;/h2&gt;
&lt;p&gt;We do make use of &lt;a href=&quot;https://cycle.js.org/&quot;&gt;CycleJS&lt;/a&gt; in one of our web clients. CycleJS introduced the
concept of cyclical streams and &lt;em&gt;drivers&lt;/em&gt; for side effects for us. Go ahead and read about all its
features on the website. It was a bit daunting for me in the beginning to &amp;quot;think in cyclical
streams&amp;quot;, but a few months in I&#39;m happier than ever building a single page client app.&lt;/p&gt;
&lt;p&gt;I recommend reading these texts on streams and reactive programming:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://cycle.js.org/streams.html&quot;&gt;&amp;quot;Streams&amp;quot; on CycleJS.org&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://gist.github.com/staltz/868e7e9bc2a7b8c1f754&quot;&gt;&amp;quot;The introduction to Reactive Programming you&#39;ve been missing&amp;quot;&lt;/a&gt;
by André Staltz, creator of xstream and CycleJS.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://futureofcoding.org/papers/comprehensible-frp/comprehensible-frp.pdf&quot;&gt;&amp;quot;Explicitly Comprehensible Functional Reactive Programming (pdf)&amp;quot;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Have a look at the CycleJS documentation and guides. Then let&#39;s see why we decided to &lt;em&gt;not&lt;/em&gt; go with
CycleJS for a new single page app.&lt;/p&gt;
&lt;h3&gt;Differences in drawing a DOM&lt;/h3&gt;
&lt;p&gt;Out-of-the-box, CycleJS uses &lt;a href=&quot;https://github.com/snabbdom/snabbdom&quot;&gt;Snabbdom&lt;/a&gt; – a virtual DOM
library – to build your app&#39;s HTML and insert into the browser. CycleJS supports
&lt;a href=&quot;https://cycle.js.org/components.html&quot;&gt;components&lt;/a&gt;, i.e. reusable functions that emit a DOM and take
props.&lt;/p&gt;
&lt;p&gt;A component in CycleJS/Snabbdom might look like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;import xs from &#39;xstream&#39;;
import { div, input, span } from &#39;@cycle/dom&#39;;

function MyComponent(sources) {
	// Incoming DOM from the outside:
	const domSource = sources.DOM;

	// Stream of new text values from our &amp;lt;input&amp;gt; element
	const newValue$ = domSource
		.select(&#39;.input&#39;) // The &amp;lt;input&amp;gt; has class=&amp;quot;input&amp;quot;
		.events(&#39;input&#39;) // Listen to `input` events
		.map((ev) =&amp;gt; ev.target.value); // For each input, grab the `value`

	// Build a stream of state, which looks like:
	//  Stream&amp;lt;{ value: string }&amp;gt;
	const state$ = newValue$.map((value) =&amp;gt; ({ value })).remember(); // Remember last value

	// Render out the UI from our state using Snabbdom. This is
	// a virtual DOM implementation, and we build the structure
	// using Hyperscript.
	const vdom$ = state$.map((state) =&amp;gt;
		div([
			span(state.value),
			input(&#39;.input&#39;, {
				attrs: { type: &#39;text&#39; },
			}),
		])
	);

	// Finally, return our DOM to the outside, along with the
	// values from our &amp;lt;input&amp;gt;
	return {
		DOM: vdom$,
		value: state$.map((state) =&amp;gt; state.value),
	};
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The DOM flows through the component as a &lt;em&gt;stream&lt;/em&gt;. Compare this with a React component where you
return the virtual DOM as a lump of JSX:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-tsx&quot;&gt;import React, { useState } from &#39;react&#39;;

function MyComponent() {
	const [text, setText] = useState&amp;lt;string&amp;gt;(&#39;&#39;);

	return (
		&amp;lt;div&amp;gt;
			&amp;lt;span&amp;gt;{text}&amp;lt;/span&amp;gt;
			&amp;lt;input
				type=&#39;text&#39;
				defaultValue={text}
				onInput={(evt) =&amp;gt; setText(evt.target.value)}
			/&amp;gt;
		&amp;lt;/div&amp;gt;
	);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The React component &lt;em&gt;probably&lt;/em&gt; looks more straight forward to most people than the CycleJS
component, I imagine. It&#39;s because it&#39;s &lt;em&gt;imperative&lt;/em&gt;. We use &lt;code&gt;setText&lt;/code&gt; and perhaps &lt;code&gt;this.setState&lt;/code&gt;
in React components – a concept that doesn&#39;t exist in CycleJS&#39;s world. In CycleJS, something needs
to &amp;quot;pull&amp;quot; the values through the streams through the component. Streams are, aptly, flowing through
the whole app.&lt;/p&gt;
&lt;h3&gt;Building our own&lt;/h3&gt;
&lt;p&gt;I think the Snabbdom way of building markup is interesting. It encourages me to think about my
frontend code as functions even more (JSX sort of hides that away). For a rewrite of our Live
player, we decided we wanted to use React for the view, instead of doing full CycleJS/Snabbdom
again. This was before &lt;a href=&quot;https://github.com/cyclejs/react&quot;&gt;@cycle/react&lt;/a&gt; was released, so we set out
to fully ditch CycleJS for this rewrite and figure out how to make business logic in streams play
well with React for the view.&lt;/p&gt;
&lt;p&gt;The choice of React for the view was partly due to some odd quirks in how CycleJS handles DOM
events, and partly due to the nice React ecosystem. Typescript and React go perfect together too,
making for robust view components.&lt;/p&gt;
&lt;p&gt;In our new architecture, we wanted to keep these concepts from CycleJS:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;All business logic as reactive streams.&lt;/li&gt;
&lt;li&gt;Handling side effects in Drivers, making for a &amp;quot;pure&amp;quot; main application.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We wanted to get rid of:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Replace the DOM-as-a-stream and Snabbdom rendering with React.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We also wanted to include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Storing the whole app state as a central atom and draw the whole user interface based on that. Of
course very common in the React world these days.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let&#39;s begin!&lt;/p&gt;
&lt;h2&gt;Table of Contents&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;State &amp;amp; data flow&lt;/li&gt;
&lt;li&gt;State updates&lt;/li&gt;
&lt;li&gt;Sending messages&lt;/li&gt;
&lt;li&gt;The view&lt;/li&gt;
&lt;li&gt;Side effects&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;State &amp;amp; data flow&lt;/h2&gt;
&lt;p&gt;How to manage state in frontend applications has turned out to be a hot topic. What is app state
anyway? It might be:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;An ID string of the currently signed in user.&lt;/li&gt;
&lt;li&gt;An array of blog posts.&lt;/li&gt;
&lt;li&gt;A boolean indicating if a modal is open or not.&lt;/li&gt;
&lt;li&gt;An enum for the current state in a state machine.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And so on. The basic idea is that we should be able to &lt;strong&gt;draw the whole interface from this state&lt;/strong&gt;.
Sometimes, using local state in components is fine. This might be state such as the active tab in a
tab system, which is very local, and &lt;em&gt;probably&lt;/em&gt; doesn&#39;t concern any other parts of the system.&lt;/p&gt;
&lt;p&gt;Redux popularized the Flux architecture&#39;s idea of state as &amp;quot;single source of truth&amp;quot;. We shouldn&#39;t
scatter the state across DOM nodes, localStorage, the server, and so on. Also Elm and Om are great
inspiration for state handling in client side apps. I encourage you to read the
&lt;a href=&quot;https://redux.js.org/introduction/motivation&quot;&gt;philosophies and principles of Redux&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;A state atom might look like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;const state: State = {
	name: &#39;Johan Brook&#39;,
	showModal: true,
};
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;From this, we should be able to draw the full app component tree. And if we&#39;d draw it again from the
same state, the app&#39;s UI can&#39;t change fundamentally.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;A core principle of functional programming is immutability – the inability to change a state after
it&#39;s created. We&#39;d like our app state to work the same. Meaning, we can&#39;t just &amp;quot;set a property in
the state&amp;quot; like it&#39;s the Wild West. We need to update properties incrementally and generate a &amp;quot;new&amp;quot;
state. For each of these state updates, the view should re-draw.&lt;/p&gt;
&lt;p&gt;In order to update the &lt;code&gt;name&lt;/code&gt; in our state, we can design the flow like this:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Construct your update to the state atom. In this case &lt;code&gt;{ name: &#39;John Doe&#39; }&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Send the update as a stream to a function which folds it together with the state stream:&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;const state$ = stateUpdate$.fold(
	(prev, update) =&amp;gt; ({ ...prev, ...update }),
	startState,
);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The xstream function &lt;a href=&quot;http://staltz.github.io/xstream/#fold&quot;&gt;&lt;code&gt;fold&lt;/code&gt;&lt;/a&gt; is very handy to learn here.
That&#39;s the amazing function which creates our whole incremental state! The update effectively
extends the existing state object to form a new one.&lt;/p&gt;
&lt;p&gt;So we&#39;ve got a &lt;code&gt;state$&lt;/code&gt; variable containing the &lt;em&gt;stream of states&lt;/em&gt;. It&#39;s very important to
internalise that the &amp;quot;stream of states&amp;quot; here isn&#39;t a continuous stream, but a discrete one. It&#39;s a
like a string with ants, where each ant is a new state, and they can come in irregular patterns. The
idea is to let the view listen to this &lt;code&gt;state$&lt;/code&gt; stream, which will behave like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;stateUpdate$ = ---------- update: { name: &#39;Johnny Doe&#39; }----

stateUpdate$.fold(..., startState)

state$ = ---{ name: &#39;Johan Brook&#39; }--{ name: &#39;Johnny Doe&#39; }-
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For each new element in the resulting &lt;code&gt;state$&lt;/code&gt; stream, we&#39;ll re-render the whole app (read more
below about how we&#39;ll manage the view).&lt;/p&gt;
&lt;p&gt;So what are these state updates? It&#39;s ✨&lt;strong&gt;your application&lt;/strong&gt; ✨! That&#39;s right: all business logic will
either result in state updates or side effects (read more about that in the section about Drivers
below).&lt;/p&gt;
&lt;p&gt;This can be expressed roughly like this (with xstream):&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;import { Stream } from &#39;xstream&#39;;

interface State {
	name: string;
	showModal: boolean;
}

// Our app just returns a new `name` instantly, but here
// we would render our entire app as React components or similar.
const app = (state$: Stream&amp;lt;State&amp;gt;) =&amp;gt; {
	return state$.map((state) =&amp;gt; ({
		name: &#39;Mary&#39;,
	}));
};

const run = (main: Main, startState: State) =&amp;gt; {
	// Create an incrementally updated stream of state
	// XXX Fix stateUpdate$
	const state$ = stateUpdate$.fold(
		(prev, update) =&amp;gt; ({ ...prev, ...update }),
		startState,
	);

	// Main app function, renders UI from state$ stream
	main(state$);
};

// Kick off! 🚀
run(app, { name: &#39;Johan&#39;, showModal: false });
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Sharp eyed readers notice that &lt;code&gt;stateUpdate$&lt;/code&gt; is appearing out of nowhere. That&#39;s supposed to come
from the app function, right?! Here&#39;s what the &amp;quot;cyclical&amp;quot; in CycleJS comes in: we need to cycle back
the state updates from our app up to the &lt;code&gt;fold&lt;/code&gt; operation. Luckily, the xstream library has an
&lt;a href=&quot;http://staltz.github.io/xstream/#imitate&quot;&gt;&lt;code&gt;imitate&lt;/code&gt;&lt;/a&gt; method on a stream which makes it possible to
create a fake stream at the top of a function, run operations on it, and then let it imitate a
&amp;quot;real&amp;quot; stream further down the file. This allows circular dependency of streams.&lt;/p&gt;
&lt;p&gt;Let&#39;s fix our code:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript/5,12-17/&quot;&gt;import xs from &#39;xstream&#39;;

const run = (main: Main, startState: State) =&amp;gt; {
  // Create &amp;quot;fake&amp;quot;, empty update stream
  const fakeUpdates$ = xs.create();

  const state$ = fakeUpdates$.fold(
    (prev, update) =&amp;gt; ({ ...prev, ...update }),
    startState
  );

  const appUpdate$ = main(state$);

  // Imitate the real state update stream - results are
  // cycled back to the .fold operation above!
  fakeUpdates$.imitate(appUpdate$);

  return state$;
};
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;-&amp;gt; &lt;a href=&quot;http://staltz.github.io/xstream/#create&quot;&gt;Docs on &lt;code&gt;xs.create&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;We&#39;ve successfully achieved feeding our app with a stream of state, and made the output stream of
the app update the state! 🎉 This creates a &lt;code&gt;main&lt;/code&gt; function signature of:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;type Main = (state$: Stream&amp;lt;State&amp;gt;) =&amp;gt; Stream&amp;lt;Partial&amp;lt;State&amp;gt;&amp;gt;;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Thus, state management is ticked off. You just need to provide the &lt;code&gt;main&lt;/code&gt; function which is your
whole app logic.&lt;/p&gt;
&lt;p&gt;Takeaways:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;We update our state with updates via a stream.&lt;/li&gt;
&lt;li&gt;Our main app function &lt;em&gt;takes a state stream&lt;/em&gt; and &lt;em&gt;returns an update stream&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;The state is thus incrementally updated.&lt;/li&gt;
&lt;li&gt;The view is re-rendered each time the state updates.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Ch..ch..changes … (to the state)&lt;/h2&gt;
&lt;p&gt;Let&#39;s explore the &lt;code&gt;run&lt;/code&gt; function from the earlier example. This code below demonstrates how you
would use it in an app. The &lt;code&gt;run&lt;/code&gt; function is thus an export of our library:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;// run :: (Main, State) -&amp;gt; Stream&amp;lt;State&amp;gt;
import { run } from &#39;frap&#39;;

interface State {
	name: string;
}

const startState: State = {
	name: &#39;Johan&#39;,
};

// Our app&#39;s business logic, packaged in a single function.
// Receives state stream and should return a stream of updates
// to the state.
// app :: (Stream&amp;lt;State&amp;gt;) -&amp;gt; Stream&amp;lt;Partial&amp;lt;State&amp;gt;&amp;gt;
const app: Main = (state$: Stream&amp;lt;State&amp;gt;) =&amp;gt; {
	const stateUpdate$ = xs.create();

	return stateUpdate$;
};

// Kick it off! 🚀
run(app, startState);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;That &lt;code&gt;app&lt;/code&gt; function is basically everything there is to it! (almost… we just need to sort out the
view rendering and handle side effects). We receive state, do stuff deriving off of it, and return
our preferred updates.&lt;/p&gt;
&lt;p&gt;An example could be:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript/2-5/&quot;&gt;const app: Main = (state$: Stream&amp;lt;State&amp;gt;) =&amp;gt; {
  const stateUpdate$ = state$.map((state) =&amp;gt; ({
    name: state.name.toUpperCase(),
  }));

  return stateUpdate$;
};
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;-&amp;gt; &lt;a href=&quot;http://staltz.github.io/xstream/#map&quot;&gt;Docs on &lt;code&gt;map&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This little app of ours would instantly update the &lt;code&gt;name&lt;/code&gt; property in our state atom to uppercase:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;--- { name: &#39;Johan&#39; } ---
  app()
--- { name: &#39;JOHAN&#39; } ---
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, this seems silly and simplistic. I thought so too. &amp;quot;How can I ever achieve complex app logic
with this?!&amp;quot;. Turns out you can. By using the stream operators of xstream on your data, you really
&lt;em&gt;can&lt;/em&gt; achieve crazy things. It all adds up. For me, it was all about separating the big state down
into small functions taking care of &amp;quot;their&amp;quot; domain, and then merging it all together:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;// Functions we&#39;ve written to take care of stuff in our data model.
// We don&#39;t care how they do it – as long as their return a stream
// of state updates.
import { nameUpdate, posts } from &#39;./lib&#39;;

const app: Main = (state$: Stream&amp;lt;State&amp;gt;) =&amp;gt; {
	const nameUpdate$ = nameUpdate(state$);
	const postsUpdate$ = posts(state$);

	// All derived state updates off of existing state
	return xs.merge(nameUpdate$, postsUpdate$);
};
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;-&amp;gt; &lt;a href=&quot;http://staltz.github.io/xstream/#merge&quot;&gt;Docs on &lt;code&gt;xs.merge&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;One important aspect here is the &lt;em&gt;cyclical&lt;/em&gt; aspect of our app architecture. Notice how the state
stream is constantly giving us new state as elements in the stream. Our &lt;code&gt;app&lt;/code&gt; function is merely a
transformer along the way, returning state updates as sinks and receives the new state as source:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;------a---ax---ax------
  app() # Transforms the source stream
------ax--ax---axy-----
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Once you&#39;re used to &amp;quot;thinking in cycles&amp;quot;, it creates quite a nice way of programming even complex
apps, since the pattern is very scalable. You&#39;ll be thinking in &amp;quot;inputs and outputs&amp;quot;, and solely how
you will transform the inputs to a given output.&lt;/p&gt;
&lt;p&gt;But derived state ain&#39;t no fun. In a real app, we&#39;ve got lots of inputs! Mouse clicks from the user,
async calls coming back from web APIs – a myriad of things that should update our state. Let&#39;s
investigate the former!&lt;/p&gt;
&lt;h2&gt;Sending -&amp;gt; Messages&lt;/h2&gt;
&lt;p&gt;Any app must deal with user input. Button clicks, text fields, forms, and so on. As our app
architecture looks so far, there&#39;s only derived state updates. Meaning, we only transform the state
we have already.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;We need to construct a way to let the view pass messages to our app function.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;We haven&#39;t looked at the view yet, but remember it&#39;s &lt;strong&gt;outside&lt;/strong&gt; our pure, cozy, functional world
inside of our app function. In the app function, we solely deal with functional streams which we
apply &lt;code&gt;map&lt;/code&gt;, &lt;code&gt;filter&lt;/code&gt; and other operations on.&lt;/p&gt;
&lt;p&gt;When I say &lt;em&gt;messages&lt;/em&gt;, I refer to something like &lt;em&gt;signals&lt;/em&gt; or &lt;em&gt;events&lt;/em&gt; that are emitted from the UI
element the user interacted with. We need two things in these messages:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;An identifier in order to distinguish between different kinds of messages.&lt;/li&gt;
&lt;li&gt;An optional payload with data attached to the message.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Let&#39;s see how we can get those messages into our app function!&lt;/p&gt;
&lt;p&gt;We&#39;ve modelled data as streams so far, so why not continue on that track. Imagine a &lt;code&gt;view$&lt;/code&gt; stream
which is a stream of &lt;em&gt;all&lt;/em&gt; different kinds of messages – user input – coming from the view.&lt;/p&gt;
&lt;p&gt;I imagine this flow being something like this:&lt;/p&gt;
&lt;figure id=&quot;view-model&quot;&gt;
  &lt;img width=&quot;413&quot; alt=&quot;Messages flow&quot; src=&quot;https://johan.im/{{ &#39;frap-messages.png&#39; | postAssetUrl }}&quot; /&gt;
  &lt;figcaption&gt;Simplified flow diagram.&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;How does a message look like then? Perhaps like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;interface ToggleModal {
	kind: &#39;toggle_modal&#39;;
	modalName: &#39;surveyModal&#39; | &#39;loginModal&#39;;
	open: boolean;
}

interface SetPerson {
	kind: &#39;set_person&#39;;
	person: {
		name: string;
		age: number;
	};
}

type ViewMsg = ToggleModal | SetPerson;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;These resemble &amp;quot;actions&amp;quot; you would send to a reducer when using the Flux architecture.&lt;/p&gt;
&lt;p&gt;The last &lt;code&gt;ViewMsg&lt;/code&gt; type forms the union type which our messages stream consists of:
&lt;code&gt;Stream&amp;lt;ViewMsg&amp;gt;&lt;/code&gt;. Let&#39;s investigate how this fits into our app architecture.&lt;/p&gt;
&lt;p&gt;We&#39;ve got our &lt;code&gt;app&lt;/code&gt; function which produces state updates and receives state from &lt;code&gt;run&lt;/code&gt;. The latter
can be modified to accept a stream of view messages:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;import xs from &#39;xstream&#39;;

const run = &amp;lt;ViewMsg&amp;gt;(
	main: Main,
	view$: Stream&amp;lt;ViewMsg&amp;gt;,
	startState: State,
) =&amp;gt; {
	const fakeUpdates$ = xs.create();

	const state$ = stateUpdate$.fold(
		(prev, update) =&amp;gt; ({ ...prev, ...update }),
		startState,
	);

	const appUpdate$ = main(state$, view$);

	fakeUpdates$.imitate(appUpdate$);

	return state$;
};
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I&#39;ve introduced a generic type &lt;code&gt;ViewMsg&lt;/code&gt; in the &lt;code&gt;run&lt;/code&gt; function. Let&#39;s start our app:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;// run :: (Main, Stream&amp;lt;V&amp;gt;, State) -&amp;gt; Stream&amp;lt;State&amp;gt;
import { run } from &#39;frap&#39;;

export interface State {
	name: string;
}

export const startState: State = {
	name: &#39;Johan&#39;,
};

interface SetName {
	kind: &#39;set_name&#39;;
	name: string;
}

export type ViewMsg = SetName;

const app: Main = (state$: Stream&amp;lt;State&amp;gt;, view$: Stream&amp;lt;ViewMsg&amp;gt;) =&amp;gt; {
	const stateUpdate$ = view$
		// Only filter on the `SetName` type of messages
		.filter((m): m is SetName =&amp;gt; !!m.kind &amp;amp;&amp;amp; m.kind === &#39;set_name&#39;)
		// Set a new name by mapping the payload from the message to a state update
		.map((m) =&amp;gt; ({
			name: m.name,
		}));

	return xs.merge(stateUpdate$);
};

// TODO Build view and construct messages stream
const view$ = xs.create&amp;lt;ViewMsg&amp;gt;();

// Kick it off! 🚀
run(app, view$, startState);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, &lt;em&gt;imagine&lt;/em&gt; that the &lt;code&gt;view$&lt;/code&gt; stream is working. Imagine that for every time a user is submitting
a form text field with some text, the view will construct the &lt;code&gt;SetName&lt;/code&gt; message object and put it on
the view stream. This view stream can flow through our app&#39;s business logic as a regular function
parameter, and we can &lt;code&gt;filter&lt;/code&gt; to get specific messages and then &lt;code&gt;map&lt;/code&gt; them to do state updates.&lt;/p&gt;
&lt;p&gt;This makes the separation between view and business logic pretty clear – which is a good thing! We
can test our app in isolation by feeding mocked messages into the view stream and asserting the
resulting state without having to mount the view. The view&#39;s actions don&#39;t have to be side effects,
as it&#39;s often regarded to be in other app setups.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;So far, we&#39;ve stayed inside or pure, functional domain of streams. The next section will go through
the elephant in the room.&lt;/p&gt;
&lt;h2&gt;A View to a &lt;s&gt;kill&lt;/s&gt; Stream&lt;/h2&gt;
&lt;p&gt;We begin with this simple but beautiful idea:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ui = view(state)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;em&gt;The View is a function of state, producing User Interface.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;This idea isn&#39;t new of course: it exists in various shapes and philosophies, such as MVC, MVVM, MVI,
and so on. The concept of having a view that listens to state is a baseline in many design patterns.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Q:&lt;/strong&gt; But how do we do this in Frap? Where we have a single stream of state?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;A:&lt;/strong&gt; We rely on a virtual DOM!&lt;/p&gt;
&lt;p&gt;This means, we re-render our whole component tree on each new state update. This feels terribly
expensive and weird, but we must simply rely on that our virtual DOM implementation will calculate
the smallest diff in the real DOM and apply that. The whole design idea behind React is built on
this principle: to rely on the virtual DOM.&lt;/p&gt;
&lt;p&gt;As you saw above in the code samples at the top, UI components in CycleJS use streams as first class
citizens. The components are really just functions which accepts input streams and return output
streams. A common lingo in the streams world is &lt;em&gt;Sources&lt;/em&gt; and &lt;em&gt;Sinks&lt;/em&gt; to signify the input and
outputs. Thanks to this property of CycleJS, components can receive a stream of values (&amp;quot;props&amp;quot; in
React world) and return a stream of virtual DOM nodes and a stream of new values, emitted from the
component. React works differently. React components &lt;em&gt;must&lt;/em&gt; return JSX (or a virtual DOM node,
however you choose to write it). So we just can&#39;t make React components return a stream of JSX and
expect things to work, of course.&lt;/p&gt;
&lt;p&gt;Have a look at the &lt;a href=&quot;#view-model&quot;&gt;view figure&lt;/a&gt; again. We see that the view should accept a
state stream and &amp;quot;return&amp;quot; a messages stream (I say &amp;quot;return&amp;quot; within quotes since it&#39;s not really
gonna return the stream).&lt;/p&gt;
&lt;p&gt;But how do we draw a whole React app from a stream? We can&#39;t return a stream of virtual DOM nodes
here?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;We must open up the state stream somehow and let it drive the rendering of the top level
component.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;(This means the React app will re-render on each state update. &lt;em&gt;Again, this is fine&lt;/em&gt;. Does the app
feel slow? Profile with React&#39;s dev tools, as
&lt;a href=&quot;https://twitter.com/ryanflorence/status/1126734015950536706&quot;&gt;this tweet&lt;/a&gt; advises).&lt;/p&gt;
&lt;p&gt;In most stream libraries, there&#39;s a method called &lt;code&gt;subscribe&lt;/code&gt; which you can use on a stream. In
xstream, it adds a listener on a stream and returns a subscription that can be used to remove that
listener (read the &lt;a href=&quot;http://staltz.github.io/xstream/#subscribe&quot;&gt;docs&lt;/a&gt;). We can use that to subscribe
to state updates, and then unsubscribe when our app unmounts.&lt;/p&gt;
&lt;p&gt;In the &lt;code&gt;next&lt;/code&gt; callback of &lt;code&gt;subscribe&lt;/code&gt;, we&#39;ll receive each new element in the stream (we can also
catch errors in &lt;code&gt;error&lt;/code&gt;). We use &lt;code&gt;next&lt;/code&gt; to set the state of the React component at top level. From
then on, we&#39;ll let React figure out how to draw the DOM based on that very state. For each new state
update, &lt;code&gt;next&lt;/code&gt; will be called, and React will re-render the tree. Incremental, immutable state.&lt;/p&gt;
&lt;p&gt;Here&#39;s the function signature of &lt;code&gt;run&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;type Run = (Main, view$: Stream&amp;lt;ViewMsg&amp;gt;, startState: State) =&amp;gt; Stream&amp;lt;State&amp;gt;;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Before, we&#39;ve just called &lt;code&gt;run&lt;/code&gt; for funsies without really thinking too much about where and how
we&#39;ll handle it&#39;s output stream. I can reveal to you now that the function should ideally be called
when your top level React component mounts.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-tsx&quot;&gt;import React from &#39;react&#39;;
import { Stream, Subscription } from &#39;xstream&#39;;
import { run } from &#39;frap&#39;;

// Imported from our main file
import { app, startState, State, ViewMsg } from &#39;./main.ts&#39;;

/** The state of our React component */
interface AppState {
	state$: Stream&amp;lt;State&amp;gt;;
	/** This holds our &amp;quot;real&amp;quot; app state – ready to render! */
	appState: State;
}

type Send = (event: ViewMsg) =&amp;gt; void;

class App extends React.Component&amp;lt;any, AppState&amp;gt; {
	/** Instance variable holding the subscription to the state stream. */
	sub: Subscription;

	/** Instance function used to drive messages into the view stream. */
	send: Send | null = null;

	constructor(props) {
		super(props);

		// Stream of input from the views.
		const view$ = xs.create&amp;lt;ViewMsg&amp;gt;();

		// Create our &amp;quot;send&amp;quot; function which will drive messages on to
		// the view stream above.
		this.send = (v: ViewMsg) =&amp;gt; {
			view$.shamefullySendNext(v);
		};

		// Kick everything off! 🚀
		const state$ = run(app, view$, startState);

		// Attach on component&#39;s local state so we an access it
		// in life cycle methods
		this.state = {
			state$,
			appState: startState,
		};
	}

	componentDidMount(): void {
		// Start subscribing to incoming state and set the local
		// state of our React component. Will trigger re-render.
		this.sub = this.state.state$.subscribe({
			next: (appState) =&amp;gt; {
				this.setState({ appState });
			},
			error: (err) =&amp;gt; {
				console.error(err);
			},
		});
	}

	componentWillUnmount(): void {
		// Unsubscribe from state subscription:
		this.sub.unsubscribe();
	}

	render(): React.ReactNode {
		const { appState } = this.state;

		// Render the &#39;name&#39; state and a button to change it.
		return (
			&amp;lt;div&amp;gt;
				&amp;lt;h1&amp;gt;Hi {appState.name}!&amp;lt;/h1&amp;gt;

				&amp;lt;button
					onClick={() =&amp;gt;
						this.send({
							kind: &#39;set_name&#39;,
							name: &#39;Johnny Doe&#39;,
						})}
				&amp;gt;
					Set another name
				&amp;lt;/button&amp;gt;
			&amp;lt;/div&amp;gt;
		);
	}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;(The class approach is a bit verbose, but React Hooks is still a new concept which is outside the
scope of this post. Here&#39;s a
&lt;a href=&quot;https://gist.github.com/brookback/d98efdfb4a3087dbba767910f2eec2f3&quot;&gt;GitHub Gist&lt;/a&gt; including a Hooks
version).&lt;/p&gt;
&lt;p&gt;Notice how we:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Create a &lt;code&gt;view$&lt;/code&gt; stream in the constructor and pass it to &lt;code&gt;run&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Create a &lt;code&gt;send&lt;/code&gt; function on the app component which can be used from view event handlers to send
messages.&lt;/li&gt;
&lt;li&gt;Subscribe to state updates when mounted.&lt;/li&gt;
&lt;li&gt;Render the state in &lt;code&gt;render()&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The main fishy thing here might be the &lt;code&gt;shamefullySendNext&lt;/code&gt; method in &lt;code&gt;send&lt;/code&gt;. As from the
&lt;a href=&quot;http://staltz.github.io/xstream/#shamefullySendNext&quot;&gt;docs&lt;/a&gt;, this method forces a new value to be
emitted to the stream. This is the one of the two &amp;quot;bridges&amp;quot; between our functional app world and the
imperative view (the &lt;code&gt;subscribe()&lt;/code&gt; call being the other one).&lt;/p&gt;
&lt;p&gt;Phew. Lots of code and concepts. In this section, we&#39;ve:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;seen how to add the view layer (here React) to our app architecture.&lt;/li&gt;
&lt;li&gt;how to pass actual messages from the view.&lt;/li&gt;
&lt;li&gt;render a React component from our state.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There&#39;s one thing missing still. Where are all the async API calls, browser API functions, and
logging utilities?&lt;/p&gt;
&lt;p&gt;Yes: where are the &lt;em&gt;side effects&lt;/em&gt;?&lt;/p&gt;
&lt;h2&gt;Side effects 💀&lt;/h2&gt;
&lt;p&gt;In any non-trivial application, there &lt;em&gt;will&lt;/em&gt; be side effects. Side effects in this case refer to
things similar to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Fetching JSON from an API server&lt;/li&gt;
&lt;li&gt;Using Chrome&#39;s media APIs to gain access to the web camera&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The common denominator is that drivers include &lt;em&gt;imperative code&lt;/em&gt;. Code that isn&#39;t functional
streams. Code that affect the outside world. Code that is non-pure.&lt;/p&gt;
&lt;p&gt;I recommend reading the &lt;em&gt;Drivers&lt;/em&gt; section on &lt;a href=&quot;https://cycle.js.org/drivers.html&quot;&gt;CycleJS&#39;s page&lt;/a&gt;,
since we stole the concept of Drivers from there. There are many good examples there as well.&lt;/p&gt;
&lt;p&gt;Once you&#39;ve done that, return back here.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;We&#39;re gonna use the exact same concept of drivers in Frap. Drivers receive &lt;em&gt;Sinks&lt;/em&gt; and return
&lt;em&gt;Sources&lt;/em&gt;. This is in contrast to our main app function, which receives &lt;em&gt;Sources&lt;/em&gt; and returns
&lt;em&gt;Sinks&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;The flow diagram thus becomes:&lt;/p&gt;
&lt;figure id=&quot;view-model&quot;&gt;
  &lt;img width=&quot;624&quot; alt=&quot;Driver flow&quot; src=&quot;https://johan.im/{{ &#39;frap-driver-flow.png&#39; | postAssetUrl }}&quot; /&gt;
  &lt;figcaption&gt;App architecture with drivers and view.&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Let&#39;s nail down our Sources and Sinks here.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;To our &lt;code&gt;app&lt;/code&gt; function,&lt;/strong&gt; Sources are all input sources it needs to do its job. View messages,
driver input, the state stream. Sinks are output instructions to drivers and state updates.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;To the drivers,&lt;/strong&gt; Sources are the output instructions (as a stream) from &lt;code&gt;app()&lt;/code&gt;. Sinks can be
anything.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The &lt;code&gt;run()&lt;/code&gt; function from Frap takes care of glueing all of this together.&lt;/p&gt;
&lt;p&gt;We communicate with the drivers with a single &lt;em&gt;out&lt;/em&gt; stream with messages. A driver can thus look
like:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Driver&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;// ConsoleLogDriver.ts
import { Stream } from &#39;xstream&#39;;

interface DoLog {
	kind: &#39;do_log&#39;;
	label: string;
	args?: any[];
}

export type ConsoleOut = DoLog;

/** A logging driver that consumes log messages and
 * only performs writes to the console.
 */
const ConsoleLogDriver = (out$: Stream&amp;lt;ConsoleOut&amp;gt;) =&amp;gt; {
	out$.filter((m): m is DoLog =&amp;gt; !!m.kind &amp;amp;&amp;amp; m.kind === &#39;do_log&#39;).addListener(
		(m) =&amp;gt; console.log(m.label, ...m.args),
	);
};

export default ConsoleLogDriver;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As you see, a driver is 🌈Just A Function 🌈.&lt;/p&gt;
&lt;p&gt;This particular example of a driver only consumes sinks but doesn&#39;t return any sources back to our
&lt;code&gt;app()&lt;/code&gt; function.&lt;/p&gt;
&lt;p&gt;How do we hook up this driver? We need to modify the &lt;code&gt;run&lt;/code&gt; function!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Run&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;import xs from &#39;xstream&#39;;

interface Sources&amp;lt;V&amp;gt; {
  view$: Stream&amp;lt;V&amp;gt;;
  drivers?: {
    [key: string]: (s: Stream&amp;lt;any&amp;gt;) =&amp;gt; void | Stream&amp;lt;any&amp;gt;;
  };
}

const run = &amp;lt;V&amp;gt;(main: Main, sources: Sources, startState: State) =&amp;gt; {
  const { view$, drivers } = sources;

  const fakeUpdates$ = xs.create();
  const fakeDriverOuts = createFakeDriverOut(drivers);

  const state$ = stateUpdate$.fold((prev, update) =&amp;gt;
    ({ ...prev, ...update }), startState);

  // The sources to our app: state, messages, and driver input
  const mainSources = {
    state$,
    view$,
    ...callDrivers(drivers, fakeDriverOuts),
  }

  const { stateUpdate$, ...driverSinks } = main(mainSources);

  fakeUpdates$.imitate(stateUpdate$);

  for (const name in fakeDriverOuts) {
    const fake$ = fakeDriverOuts[name];
    const driverOut$ = driverSinks[name];

    fake$.imitate(driverOut$));
  }

  return state$;
};
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This might look a bit hairy. I&#39;ve left out the implementation of two functions here:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;createFakeDriverOut&lt;/code&gt;. Similarily to the state updates, we need to have a cyclic relationship
between the drivers&#39; sinks and sources and the main app function. In this function, we create a
fake stream for each driver specified.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;callDrivers&lt;/code&gt;. We call all the driver functions with the fake outputs and feed the drivers&#39;
returned output as sources to our main app function.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Main app&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;// main.ts
import { run } from &#39;frap&#39;;
import { ConsoleOut } from &#39;./ConsoleLogDriver.ts&#39;;

export interface State {
  name: string;
}

export const startState: State = {
  name: &#39;Johan&#39;,
};

interface SetName {
  kind: &#39;set_name&#39;;
  name: string;
}

export type ViewMsg = SetName;

interface MainSources {
  view$: Stream&amp;lt;ViewMsg&amp;gt;;
  state$: Stream&amp;lt;State&amp;gt;;
}

interface MainSinks {
  stateUpdate$: Stream&amp;lt;Partial&amp;lt;State&amp;gt;&amp;gt;;
  console: Stream&amp;lt;ConsoleOut&amp;gt;;
}

const app: Main = (sources: MainSources): MainSinks =&amp;gt; {

  // Access driver sources with:
  //   sources.myDriver.*

  const stateUpdate$ = /* updates to state */;

  // Send log message to log driver every second:
  const logDriverOut$ = xs
    .periodic(1000)
    .mapTo({
      kind: &#39;do_log&#39;,
      label: &#39;Hello!&#39;,
    }):

  // Return sinks
  return {
    // State updates as usual
    stateUpdate$,
    // Output instructions to the console driver. The key
    // needs to match the name of the driver specified in
    // the `drivers` argument to `run` below.
    console: logDriverOut$,
  };
};
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;View&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-typescript&quot;&gt;import ConsoleLogDriver from &#39;./ConsoleLogDriver.ts&#39;;

// In the react view, run our app:
run(
	app,
	{
		view$,
		drivers: {
			// ... with the console log driver function
			console: ConsoleLogDriver,
		},
	},
	startState,
);
&lt;/code&gt;&lt;/pre&gt;
&lt;hr&gt;
&lt;p&gt;That&#39;s it! Now we can handle all side effects in their special drivers, where they can do all kinds
of reads and writes with the external world, and safely pass back their results as sources (&amp;quot;input&amp;quot;)
to our app.&lt;/p&gt;
&lt;h2&gt;Parting words&lt;/h2&gt;
&lt;p&gt;What I love about this architecture we&#39;ve just built are these things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Reasoning in reactive streams! 😍 Forget about mutability and writing imperative code. Say hello to
declarative code and &amp;quot;tight&amp;quot; business logic.&lt;/li&gt;
&lt;li&gt;How well it goes along with React&#39;s virtual DOM nature.&lt;/li&gt;
&lt;li&gt;How the architecture is flexible enough to allow for all varieties of organising your app, still
being strict with what types you pass around.&lt;/li&gt;
&lt;li&gt;How well it scales. Almost every new feature you&#39;ll add to your app will be written in the same
style.&lt;/li&gt;
&lt;li&gt;How safe I feel when everything from the library layer (Frap) to the view layer (React) is handled
with a type system (Typescript).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here&#39;s the complete library code:&lt;/p&gt;
&lt;p class=&quot;tc&quot;&gt;
  &lt;a href=&quot;https://github.com/lookback/frap&quot; class=&quot;btn&quot;&gt;lookback/frap&lt;/a&gt;
&lt;/p&gt;
&lt;p&gt;A huge shoutout to the creators of CycleJS. We&#39;ve been inspired by them in just about everything.
Thanks for popularising the ideas of cyclical data flows!&lt;/p&gt;
&lt;p class=&quot;tc&quot;&gt;
  &lt;strong&gt;Thank you so much for reading ✨&lt;/strong&gt;
&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Recent improvements in our git discipline</title>
    <link href="https://johan.im/writings/git-guidelines/" />
    <updated>2020-02-23T00:00:00Z</updated>
    <id>https://johan.im/writings/git-guidelines/</id>
    <content type="html">&lt;p&gt;The git history of a repository a few years in or with more than one collaborator will look like
thick weed unless you take care of it. During last Autumn in &lt;a href=&quot;http://lookback.io/&quot;&gt;Lookback&lt;/a&gt;, the
engineering team noticed that we needed to take care of some weeds.&lt;/p&gt;
&lt;p&gt;Not only in our committing code culture, but also in the land of code reviews and Pull Requests at
GitHub.&lt;/p&gt;
&lt;p&gt;Here are some of the principles and guidelines we worked out.&lt;/p&gt;
&lt;h1&gt;Empathy for others and your future self&lt;/h1&gt;
&lt;p&gt;We say:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;quot;Please have empathy for your coworkers when committing code. Be considerate of them as well as
your future self&amp;quot;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;When working in a long living code base with lots of complex and moving parts, bugs can surface
weeks or months after you wrote the code. Guess what system helps you go back in time and find
exactly what, when, and who changed a line of code?! git can! Guess what doesn&#39;t help git help you?
These things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Unclear commit messages.&lt;/li&gt;
&lt;li&gt;Incoherent and too large commits.&lt;/li&gt;
&lt;li&gt;Not easily revertable commits (connected with the above).&lt;/li&gt;
&lt;li&gt;Merge commits.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Failure to avoid these things will bite you when debugging something in the future.&lt;/p&gt;
&lt;p&gt;For us, we didn&#39;t enforce or point these things out in code reviews either. One person could file a
Pull Request 10+ commits, where some of them wouldn&#39;t even be related to the PR itself. It was hard
to give good feedback on a commit which said &lt;code&gt;fix some things in logging&lt;/code&gt;: what did you fix? Why?&lt;/p&gt;
&lt;p&gt;&amp;quot;You&#39;ve got to give love to receive love&amp;quot;. Meaning, &amp;quot;you&#39;ve got to give your co-workers good PRs in
order to receive good feedback&amp;quot;. A related joke is the old &amp;quot;20 commit PR? LGTM. One commit? A
novella of feedback&amp;quot;.&lt;/p&gt;
&lt;p&gt;We decided to reboot our engineering culture around clean commits and PRs. What follows are some of
the guidelines we drafted for working with code.&lt;/p&gt;
&lt;hr&gt;
&lt;h1&gt;1. Committing code&lt;/h1&gt;
&lt;p&gt;Make each commit &lt;strong&gt;atomical&lt;/strong&gt;. That is, make it include only the relevant code for your intended
change. There&#39;s a lot to read about this subject on the web.&lt;/p&gt;
&lt;p&gt;When submitting a patch for code review, consider grouping together similar commits with
&lt;code&gt;git rebase&lt;/code&gt;(&amp;quot;squashing&amp;quot;) to keep commit count down (&lt;em&gt;without&lt;/em&gt; breaking the rule about atomical
commits above!).&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;master&lt;/code&gt; branch&#39;s history should ideally be a long string of commits. We should avoid merge
commits by rebasing in &lt;code&gt;master&lt;/code&gt; into your feature branch before merging back.&lt;/p&gt;
&lt;h2&gt;Commit messages&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Try to focus on the &lt;em&gt;why&lt;/em&gt; in commit messages. Not necessarily &lt;em&gt;what&lt;/em&gt;. Think about how this commit
will be read when doing a &lt;code&gt;git blame&lt;/code&gt; half a year later. The reader is probably interested in
&lt;em&gt;why&lt;/em&gt; this change happened.&lt;/li&gt;
&lt;li&gt;Capturing the &lt;em&gt;why&lt;/em&gt; context is super important, since it&#39;s probably tricky to recover later. Save
yourself some future slack and capture the why &lt;em&gt;now&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;Adding any references (external stories, cards, etc) is appreciated.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href=&quot;https://chris.beams.io/posts/git-commit/&quot;&gt;&amp;quot;How to Write a Git Commit Message&amp;quot;&lt;/a&gt; includes some no
brainer guidelines for good commit messages.&lt;/p&gt;
&lt;h1&gt;2. Submitting Pull Requests&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;Have mercy for your coworkers.&lt;/strong&gt; Don&#39;t dump an unstructured, large PR on them with &amp;quot;Review
this!!&amp;quot;. Be considerate of their time and energy when submitting, as it might be very hard for them
to get into the context you&#39;ve been into the last couple of days while working on the code.&lt;/p&gt;
&lt;p&gt;Make all PRs minimal, concise, and relevant. Don&#39;t include non-trivial refactors of modules in a PR
that&#39;s really supposed to do something else.&lt;/p&gt;
&lt;p&gt;Avoid long living branches. By making small, incremental changes, we avoid messy merge conflicts and
best of all: we avoid risky deploys. It&#39;s easier to reason about small patches, and potentially
rolling them back, than huge blobs of &amp;quot;fix everything&amp;quot; PRs.&lt;/p&gt;
&lt;p&gt;Make sure your PR is rebased on &lt;code&gt;master&lt;/code&gt; when submitting it. That removes the need for merge commits
when merging back to &lt;code&gt;master&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;When your PR is ready for review (implies that you also think it&#39;s ready for merge), &lt;strong&gt;you must make
sure it&#39;s neat and tidy&lt;/strong&gt;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Squash any similar commits together.&lt;/li&gt;
&lt;li&gt;Look at each commit and see if it makes sense: does it have a nice message? Is the code changes
relevant and atomical? If a coworker does a &lt;code&gt;git log&lt;/code&gt; in two months, will they be able to
understand this change?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;After receiving a code review with change requests, always try to squash those changes together with
the initial commits made when first submitting the PR. It&#39;s okay if you have lots of smaller commits
in your feature branch &lt;em&gt;while working&lt;/em&gt; with the code. But once it&#39;s ready for review and later merge
into &lt;code&gt;master&lt;/code&gt;, the final PR &lt;em&gt;must&lt;/em&gt; be in a concise, minimal state.&lt;/p&gt;
&lt;p&gt;The code reviewer may reject your PR if it&#39;s:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Too large (&amp;quot;please break into separate PRs&amp;quot;).&lt;/li&gt;
&lt;li&gt;Unstructured/needs squashing (&amp;quot;please restructure this PR&amp;quot;, &amp;quot;please redo your commit history&amp;quot;).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This does &lt;strong&gt;&lt;em&gt;not&lt;/em&gt;&lt;/strong&gt; mean &amp;quot;you suck&amp;quot;. It&#39;s a signal that you can learn how to avoid this the next
time, as well as avoding wasting your coworkers&#39; time. We aim to learn and become a better developer
(and co-developer!) with code reviews, since it&#39;s so easy to do your own thing when you&#39;ve been down
in a code cave for a couple of days.&lt;/p&gt;
&lt;h1&gt;3. Tools &amp;amp; patterns&lt;/h1&gt;
&lt;p&gt;When rebasing your branch – either to rebase in &lt;code&gt;master&lt;/code&gt; or rewrite history – the branch will be
diverging from the remote, if you&#39;ve pushed it already. So you need to force push next time
(&lt;code&gt;git push -f&lt;/code&gt;).&lt;/p&gt;
&lt;h2&gt;Commit message templates&lt;/h2&gt;
&lt;p&gt;I just learned about this a couple of months ago: git supports &lt;strong&gt;message templates.&lt;/strong&gt; Every time
you&#39;re committing something from an external editor (not from the command line), you can use a
pre-written template. The template I stole from the post linked below reminds me of the &amp;quot;Because&amp;quot;.
Why are you even doing this commit? Any business purpose, or is it tech?&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[one line-summary of changes]

Because:
- [relevant context]
- [why you decided to change things]
- [reason you&#39;re doing it now]

This commit:
- [does X]
- [does Y]
- [does Z]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;a href=&quot;https://thoughtbot.com/blog/better-commit-messages-with-a-gitmessage-template&quot;&gt;Read more about setting this template up&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Rebasing&lt;/h2&gt;
&lt;p&gt;See this guide from the git docs:
&lt;a href=&quot;https://git-scm.com/book/en/v2/Git-Branching-Rebasing&quot;&gt;&amp;quot;Rebasing&amp;quot;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;For instance:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git checkout my-feature-branch
# ...do work
# ...changes have been made in remote master
# fetch/pull latest master
git rebase master
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This will re-apply your commits in the feature branch on top of what&#39;s in &lt;code&gt;master&lt;/code&gt; , to make it
appear as your branch is branched off of latest commit in &lt;code&gt;master&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;💡&lt;strong&gt;Tip:&lt;/strong&gt; use &lt;code&gt;git fetch origin master:master&lt;/code&gt; from your feature branch to fetch latest &lt;code&gt;master&lt;/code&gt;
without leaving your branch.&lt;/p&gt;
&lt;p&gt;There&#39;s a ton of magic things one can do with &lt;code&gt;rebase&lt;/code&gt;, please consult the internet or ask coworkers
about rebasing strategies.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Do&lt;/strong&gt; rebase &lt;code&gt;master&lt;/code&gt; into your feature branch when there are upstream changes in &lt;code&gt;master&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Don&#39;t&lt;/strong&gt; use &lt;code&gt;git merge&lt;/code&gt; when including changes from &lt;code&gt;master&lt;/code&gt; to your feature branch.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Conflicts&lt;/h2&gt;
&lt;p&gt;At some point, there will be conflicts when rebasing. You&#39;ll be able to solve them in the same way
as when manually solving conflicts when doing &lt;code&gt;git merge&lt;/code&gt;. This is all described in the terminal
when there&#39;s a conflict. In a nutshell&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;# Find conflicts in code:
git status
# ..Fix them :)
# Mark as resolved:
git add &amp;lt;file&amp;gt;
# Continue rebasing
git rebase --continue
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Force pushing to collaborative branches&lt;/h2&gt;
&lt;p&gt;Rewriting history requires you to force push the PR branch. I.e. you need to push with &lt;code&gt;git push -f&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The problem with force pushing is that anyone collaborating on the branch will not be able to just
&lt;code&gt;git pull&lt;/code&gt;. However, git introduced a switch on &lt;code&gt;pull&lt;/code&gt; which fixes this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git pull --rebase
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This is essentially a&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git fetch origin
git rebase origin/&amp;lt;your-branch&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Squashing commits together&lt;/h2&gt;
&lt;p&gt;This is nice for when you&#39;ve done a lot of small, work preserving commits (WIPs or just to not lose
them) that need to be &amp;quot;beautified&amp;quot; before submitting for review.&lt;/p&gt;
&lt;p&gt;See this guide from the git docs:
&lt;a href=&quot;https://git-scm.com/book/en/v2/Git-Tools-Rewriting-History&quot;&gt;&amp;quot;Rewriting History&amp;quot;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In a nutshell:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;# -i is for &amp;quot;interactive&amp;quot;
# git rebase -i &amp;lt;git reference&amp;gt;
# HEAD~&amp;lt;number of commits to include in rebase&amp;gt;
git rebase -i HEAD~5
# or
git rebase -i git-hash^ # ^ is targetting the parent commit
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;An editor will open with your included commits listed. There&#39;ll be a legend below them describing
how to rewrite history. You can drop commits (&lt;code&gt;d&lt;/code&gt;), squash together commits (&lt;code&gt;s&lt;/code&gt;), and more. You&#39;ll
be able to rewrite the commits messages too.&lt;/p&gt;
&lt;h1&gt;Aftermath&lt;/h1&gt;
&lt;p&gt;After we introduced some baselines in how we commit and share code, I personally felt much more
motivated to keep things neat and tidy (aka.
&lt;a href=&quot;https://en.wikipedia.org/wiki/Broken_windows_theory&quot;&gt;&amp;quot;Broken window syndrome&amp;quot;&lt;/a&gt;). Git isn&#39;t just a
tool to transport code from your laptop to a server: it&#39;s a super cool tool created to help us
collaborate better, &lt;em&gt;and&lt;/em&gt; to fix stuff when things go bad (which &lt;em&gt;will&lt;/em&gt; happen sometime).&lt;/p&gt;
&lt;p&gt;I found myself actually enjoying writing extended paragraphs in my commit messages. It brought back
some memories in doing &lt;a href=&quot;https://en.wikipedia.org/wiki/Literate_programming&quot;&gt;literate programming&lt;/a&gt; in
CoffeeScript for university lab assignments. The shorter the commit diff, the longer my commit
message would be – a funny inverse proportional property!&lt;/p&gt;
&lt;p&gt;It also touches me every time I go back and see somebody had put in some effort in the commit
message, and documented the process, the Why, and the outcome. It&#39;s like a time machine in your
colleagues&#39; minds, and also in their personal development to become better programmers.&lt;/p&gt;</content>
  </entry>
  
  <entry>
    <title>Recently in books</title>
    <link href="https://johan.im/writings/recently-in-books/" />
    <updated>2020-02-01T00:00:00Z</updated>
    <id>https://johan.im/writings/recently-in-books/</id>
    <content type="html">&lt;p&gt;The year started off with three weeks in Sri Lanka, where I naturally didn&#39;t bring my laptop. I also
only had phone internet while on wi-fi (didn&#39;t buy a data plan), which was lovely. This, combined
with early evenings, led me to read much more than during whole 2019.&lt;/p&gt;
&lt;p&gt;Here are the ones I worked through:&lt;/p&gt;
&lt;h2&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/The_Alchemist_(novel)&quot;&gt;&amp;quot;The Alchemist&amp;quot;&lt;/a&gt; – Paolo Coelho&lt;/h2&gt;
&lt;p&gt;★★★☆☆&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary:&lt;/strong&gt; It&#39;s nice to have read it, but once is enough.&lt;/p&gt;
&lt;p&gt;The modern classic. The one &amp;quot;everybody&amp;quot; have read. The book is very short and succinct. Coelho uses
the story arc of a fable about a young herd boy, who sets out to find a treasure and follow his
dreams, while being challenged with delays, hinders, and personal developments.&lt;/p&gt;
&lt;p&gt;I liked it a lot as a travel book. It suited me well while I stepped away from my everyday life in
Stockholm. However, once I realised the meaning and aim with the book (which is pretty obvious), it
became less interesting. It has a lot of &amp;quot;lessons&amp;quot; which the protagonist learns along the way, but
after a while, it just felt &lt;em&gt;very&lt;/em&gt; repetitive and flat. Everything is an allegory. Everything is a
symbol for something else. I didn&#39;t see how some global Force, which is mentioned throughout the
book, could help me in everyday life.&lt;/p&gt;
&lt;h2&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/The_Zahir_(novel)&quot;&gt;&amp;quot;The Zahir&amp;quot;&lt;/a&gt; — Paolo Coelho&lt;/h2&gt;
&lt;p&gt;★★☆☆☆&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary:&lt;/strong&gt; Alright in the beginning, but becomes repetitive and flat.&lt;/p&gt;
&lt;p&gt;Another one by mr. Coelho. This one, I found in a &amp;quot;Free Books&amp;quot; box a long time ago, and decided to
bring on the Sri Lanka trip. After &lt;em&gt;The Alchemist&lt;/em&gt; above, it felt nice to continue with the same
author in the same writing style. Again, this is an okay book to have while travelling. It&#39;s about
how a man deals with the sudden disappearance of his wife; about finding clues and explanations of
her behaviour. Then it becomes, like &lt;em&gt;The Alchemist&lt;/em&gt;, a pilgrimage.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;The Zahir&lt;/em&gt; in the beginning started out alright. Then it escalated in the same New Age style Coelho
had in his other books, about &amp;quot;the power of love&amp;quot; which I thought never had any substance and
backing by the author. On top of that, it became obvious that the books is &lt;em&gt;very&lt;/em&gt; autobiographical.
The main protagonist&#39;s story strongly resembles the career of the author, which makes the whole book
seem egoistical and self centered. The text isn&#39;t that shy with sharing details about the finances,
luxury life, and sexual conquests of the protagonist/Coelho. It just shines through very much, which
makes the book less likable.&lt;/p&gt;
&lt;h2&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/The_Snow_Leopard&quot;&gt;&amp;quot;The Snow Leopard&amp;quot;&lt;/a&gt; – Peter Matthiessen&lt;/h2&gt;
&lt;p&gt;★★★★☆&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary:&lt;/strong&gt; Long sentences aside, I thought &lt;em&gt;The Snow Leopard&lt;/em&gt; is a beautiful book about nature –
both human and the one surrounding us.&lt;/p&gt;
&lt;p&gt;The subjects this book has in common with the two previous ones are &lt;em&gt;spirituality&lt;/em&gt; and &lt;em&gt;pilgrimage&lt;/em&gt;
(a funny coincidence, actually). Whereas Coelho&#39;s writing is based in an &amp;quot;idea world&amp;quot;, Matthiessen&#39;s
style is more tangible – more based in our physical world.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;The Snow Leopard&lt;/em&gt; is a non-fiction account of a 1973 expedition the author and naturalist George
Schaller made to Nepal, with the objective of studying the Himalayan &amp;quot;blue sheep&amp;quot; in their natural
habitat. For Matthiessen, the journey was a spiritual one, driven by the deep interest Buddhism and
Zen, in the aftermaths of his wife&#39;s death in cancer some year before. As the title prescribes, a
&amp;quot;side quest&amp;quot; of the expidition is to get a glimpse of the mythical Snow Leopard, which becomes a
symbol of the inner journey of the author.&lt;/p&gt;
&lt;p&gt;We get to follow the hardships of the two month long trip through the Himalayan mountains in western
Nepal. The language is old fashioned but elegant, and the author describes the mountains with great
skill (I say, without having been there!). The two Americans travel with porters, carrying the
equipment, and Sherpas: the local people of the mountains, often hired as guides. The myriad of
villages they pass through is described in detail by Matthiessen, as well as the surrounding
landscapes. Once in a while, he goes off in a flashback to the last months of his wife&#39;s suffering.
More often, he describes Buddhist history of the country, and his Zen practices of meditation and
quest for tranquility.&lt;/p&gt;
&lt;p&gt;For me, many topics in the book landed on the subject of &lt;em&gt;acceptance&lt;/em&gt;. Total acceptance of the state
of things and all beings. Total acceptance of the various mishaps during their trip, as well as
keeping zero expectations around seeing the shy Snow Leopard. I feel this &amp;quot;expectation management&amp;quot;
can be applied to modern life by anybody.&lt;/p&gt;
&lt;p&gt;Peter Matthiessen is not afraid to describe himself in bad manner: the frustration, the pettiness,
the eagerness, the anxiety over his wife&#39;s death. He&#39;s open about all these things. I appreciate
honesty and writing about things that are true. It&#39;s not hard to note the Zen undertones everywhere
(Matthiessen went off becoming a Zen priest himself), which creates a larger-than-life feel to the
text. After finishing the book, it really felt like having been on an adventure.&lt;/p&gt;
&lt;p&gt;It could be a slow read though. It&#39;s not a &amp;quot;page turner&amp;quot;, but doesn&#39;t try to be either. There are
long sentences and descriptions which might scare people off. Don&#39;t be in a hurry. Hopefully, it&#39;ll
open one&#39;s eyes more to Zen literature (it did for me).&lt;/p&gt;
&lt;h2&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Men_Without_Women_(Haruki_Murakami_short_story_collection)&quot;&gt;Men Without Women&lt;/a&gt; – Haruki Murakami&lt;/h2&gt;
&lt;p&gt;★★★★★&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Summary:&lt;/strong&gt; A beautiful short story collection with a shared theme. It&#39;s full of great story
telling, repressed emotions, and ultimately void.&lt;/p&gt;
&lt;p&gt;Haruki Murakami has written this short story collection which shares its name with Hemingway&#39;s
second collection of stories around a similar theme. I picked it out in the pocket shop before the
trip by two reasons:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;I had a faint memory of reading good reviews about this Murakami.&lt;/li&gt;
&lt;li&gt;I like short stories – nicer to invest time in a few pages rather than a full novel. Short
stories are often succinct and to the point. Great short stories often are incredibly sharp but
still subtle.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The last sentence is so very true in &lt;em&gt;Men Without Women&lt;/em&gt;. Murakami&#39;s writing is full of wit,
build-ups, and intense story telling. It&#39;s obviously hard to describe the plot in a collection like
this, but as mentioned, they all share a common theme around male protagonists. They all have lost,
are on the look for, or have rejected women in their lives.&lt;/p&gt;
&lt;p&gt;The main thing is Murakami&#39;s great skill in describing these fates, as well as his great source of
fantasy. There are some weird twists and turns of the stories, and all in all it&#39;s great writing.
For me, I felt once more that human beings are so damned interesting.&lt;/p&gt;</content>
  </entry>
  
</feed>
