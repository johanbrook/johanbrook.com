<!DOCTYPE html>
<html lang="en" class=" writingsreact-hooks-streams"><head itemtype="http://schema.org/Blog" itemscope="">
    <title>using streams in react with hooks –&nbsp;johan brook</title>

    <meta charset="utf-8">

    
    <meta name="description" content="Pairing React Hooks with Streams works beautifully, and leads to components with less verbosity and boilerplate. In this post, I convert a class component to a function component using hooks.">
    
    
    <meta name="keywords" content="react,hooks,xstream,javascript,typescript">
    
    <meta name="author" content="Johan Brook">

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Styles-->
    <link rel="stylesheet" href="/johan.css">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="Johan's RSS feed" href="/feed.xml">

    <link rel="shortcut icon" href="/favicon.png" type="image/png">
    <link rel="canonical" itemprop="url" href="https://johanbrook.com/writings/react-hooks-streams/">
    <link rel="author" href="https://johanbrook.com">

    <meta property="og:title" content="Using streams in React with Hooks">
    <meta property="og:url" content="https://johanbrook.com/writings/react-hooks-streams/">
    <meta property="og:site_name" itemprop="name" content="Johan Brook">
    <meta property="og:type" content="blog">
    <meta property="og:image" content="https://johanbrook.com/assets/images/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="1200">
    
    <meta property="og:description" content="Pairing React Hooks with Streams works beautifully, and leads to components with less verbosity and boilerplate. In this post, I convert a class component to a function component using hooks.">
    

    
    <meta property="article:tag" content="react,hooks,xstream,javascript,typescript">
    <meta property="article:published_time" content="2019-03-03T00:00:00Z">
    
  </head>

  <body>

    <div class="Content">
      
        <nav role="navigation" class="SideNav">
  <h1 class="f3 no-rhythm">
    <a href="/">Johan Brook</a>
  </h1>
  <ul>
      <li>
        <a href="/writings/">Writings</a>
      </li>
      <li>
        <a href="/now/">Now</a>
      </li>
      <li>
        <a href="/mind/">On my mind</a>
      </li>
      <li>
        <a href="/reading/">Reading</a>
      </li>
      <li>
        <a href="/about/">About me</a>
      </li>
      <li>
        <a href="/contact/">Contact</a>
      </li>
  </ul>
</nav>

      

      <main role="main">
  <article class="Post" role="article" itemscope="" itemtype="http://schema.org/BlogPosting">

    
    <header> 
      <h1 itemprop="name" class="title">Using streams in React with Hooks</h1>

      <p class="mb0 fw5 mt3">
          
          <time datetime="2019-03-03T00:00:00Z" itemprop="datePublished" pubdate="">March 3rd, 2019</time>
      </p>

      <p class="muted mb4">
          About 3 min reading time
      </p>
    </header>

    <div class="prose measure" itemprop="articleBody">
      <p><strong>As of React 16.8,</strong> there's a new tool in the toolbox: <a href="https://reactjs.org/docs/hooks-intro.html">Hooks</a>. Hooks are used in functional React components, extending their functionality to include state and side effects.</p>
<p>I recommend reading <a href="https://overreacted.io/making-setinterval-declarative-with-react-hooks/">this article</a> by Dan Abramov for a deeper understanding of hooks. It shows how the coding style moves away from imperative class code to declarative code.</p>
<p>I realised the beauty of hooks in user interface components when creating a component which shows the current time in a recording. We've recently started using Functional Reactive Streams for the frontend at Lookback (specifically, we're using the <a href="http://staltz.github.io/xstream/">xstream</a> library, but the concepts are similar in other libraries). Explaining the concept with streams is out of scope in this post, but the gist is that you manage state as immutable streams of values. <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">This post</a> is a nice intro to streams/reactive programming.</p>
<p>Streams actually play well with React. It's <em>basically</em>, on a conceptual level, all about doing a <code>.map</code> on a stream of values and draw the React virtual DOM based on the values. But React components must either have a <code>render()</code> function which return JSX, or be a function which returns JSX. How do we render our current time from a stream?</p>
<p>An intuitive approach of mine would be:</p>
<pre><code class="language-tsx hljs language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stream</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'xstream'</span>;

<span class="hljs-keyword">interface</span> Props {
  <span class="hljs-attr">currentTime$</span>: <span class="hljs-title class_">Stream</span>&lt;<span class="hljs-built_in">number</span>&gt;;
}

<span class="hljs-comment">// This won't work: our component can't return a Stream!</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">CurrentTime</span> = (<span class="hljs-params">props: Props</span>) =&gt;
  props.<span class="hljs-property">currentTime$</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span>
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">time</span>&gt;</span>{time}<span class="hljs-tag">&lt;/<span class="hljs-name">time</span>&gt;</span></span>
  );
</code></pre>
<p>We can't return a stream from a React component –&nbsp;it must somehow devour the stream and return JSX.</p>
<h2>The class(ical) approach</h2>
<p>So we need to take a more verbose approach:</p>
<ol>
<li>Subscribe to the stream in a class component.</li>
<li>For each new value, set the local state to the value.</li>
<li>Render based on local state.</li>
<li>Tear down the subscription on unmount.</li>
</ol>
<p>Very well then:</p>
<pre><code class="language-tsx hljs language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stream</span>, <span class="hljs-title class_">Subscription</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'xstream'</span>;
<span class="hljs-keyword">import</span> formatTime <span class="hljs-keyword">from</span> <span class="hljs-string">'./libs/format-time'</span>;

<span class="hljs-keyword">interface</span> Props {
    <span class="hljs-attr">currentTime$</span>: <span class="hljs-title class_">Stream</span>&lt;<span class="hljs-built_in">number</span>&gt;;
}

<span class="hljs-keyword">interface</span> State {
    <span class="hljs-attr">timeInSeconds</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeCounter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.PureComponent</span>&lt;<span class="hljs-title class_">Props</span>, <span class="hljs-title class_">State</span>&gt; {
    sub?: <span class="hljs-title class_">Subscription</span>;

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props: Props</span>) {
        <span class="hljs-variable language_">super</span>(props);

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {
            <span class="hljs-attr">timeInSeconds</span>: <span class="hljs-number">0</span>,
        };
    }

    <span class="hljs-title function_">componentDidMount</span>(): <span class="hljs-built_in">void</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">sub</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">currentTime$</span>.<span class="hljs-title function_">subscribe</span>({
            <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">time</span>) =&gt;</span> {
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">timeInSeconds</span>: time });
            },
        });
    }

    <span class="hljs-title function_">componentWillUnmount</span>(): <span class="hljs-built_in">void</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">sub</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">sub</span>.<span class="hljs-title function_">unsubscribe</span>();
    }

    <span class="hljs-title function_">render</span>(): <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span> {
        <span class="hljs-keyword">const</span> { timeInSeconds } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;

        <span class="hljs-comment">// Renders something like: "00:10"</span>
        <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">time</span>&gt;</span>{formatTime(timeInSeconds)}<span class="hljs-tag">&lt;/<span class="hljs-name">time</span>&gt;</span></span>;
    }
}
</code></pre>
<p>This totally works, but yeah... Very verbose and imperative. Hooks to the rescue!</p>
<h2>The Hook approach</h2>
<p>Let's follow the intro to Hooks from the React website, and convert our class to a function:</p>
<pre><code class="language-tsx hljs language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stream</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'xstream'</span>;
<span class="hljs-keyword">import</span> formatTime <span class="hljs-keyword">from</span> <span class="hljs-string">'./libs/format-time'</span>;

<span class="hljs-keyword">interface</span> Props {
  <span class="hljs-attr">currentTime$</span>: <span class="hljs-title class_">Stream</span>&lt;<span class="hljs-built_in">number</span>&gt;;
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TimeCounter</span> = (<span class="hljs-params">props: Props</span>) =&gt; {
  <span class="hljs-comment">// Create a state hook for our time state, with initial state of zero:</span>
  <span class="hljs-keyword">const</span> [current, setCurrent] = useState&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// On component mount, set up a side effect that subscribes to</span>
      <span class="hljs-comment">// the stream, and let `setCurrent` be called for new values:</span>
      <span class="hljs-keyword">const</span> sub = props.<span class="hljs-property">currentTime$</span>.<span class="hljs-title function_">subscribe</span>({
          <span class="hljs-attr">next</span>: setCurrent,
      });

      <span class="hljs-comment">// Unsubscribe on component tear down:</span>
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> sub.<span class="hljs-title function_">unsubscribe</span>();
  });

  <span class="hljs-comment">// Render our current time state as the returned JSX!</span>
  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">time</span>&gt;</span>{formatDuration(currentTime)}<span class="hljs-tag">&lt;/<span class="hljs-name">time</span>&gt;</span></span>;
}

<span class="hljs-comment">// Elsewhere, render as usual:</span>
&lt;<span class="hljs-title class_">TimeCounter</span> currentTime$={myStreamOfNumbers$} /&gt;
</code></pre>
<ul>
<li>We call <code>useEffect</code> to set up a subscription on the incoming stream. <a href="https://reactjs.org/docs/hooks-effect.html">Read more</a> about the effect hook.</li>
<li>We call <code>useState</code> with an inital value and receive back a tuple of the current value and a setter. <a href="https://reactjs.org/docs/hooks-state.html">Read more</a> about the state hook.</li>
</ul>
<p>So minimal, still readable. Even <em>more</em> readable than the class version, I think.</p>
<h2>Extracting our hook</h2>
<p>Since Hooks are <em>just functions</em>, we can extract common functional patterns into our own hooks and use them in other components. I found myself writing another component which also subscribed to an incoming stream and rendered its values. What a candidate for extraction into a hook!</p>
<p>If we analyse the component above, we see that <code>useState</code> and <code>useEffect</code> are going to work roughly, if not exactly, the same for any other component. Only the types in the incoming stream differ. Here we use the type <code>number</code>, but we can make our new Hook generic thanks to TypeScript's generics.</p>
<p>I came up with this:</p>
<pre><code class="language-ts hljs language-typescript"><span class="hljs-comment">// use-stream.ts</span>
<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stream</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'xstream'</span>;

<span class="hljs-keyword">const</span> useStream = &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">stream$: Stream&lt;T&gt;, initialState: T | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span></span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> [current, setCurrent] = useState&lt;T&gt;(initialState);

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> sub = stream$.<span class="hljs-title function_">subscribe</span>({
            <span class="hljs-attr">next</span>: setCurrent,
        });

        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> sub.<span class="hljs-title function_">unsubscribe</span>();
    });

    <span class="hljs-comment">// Just return our current value, since that's the thing we're interested in</span>
    <span class="hljs-comment">// (to render) when using this hook:</span>
    <span class="hljs-keyword">return</span> current;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useStream;
</code></pre>
<p>We've just made our own <code>useStream</code> hook by composing <code>useEffect</code> and <code>useState</code>!</p>
<p>The hook can be used like this:</p>
<pre><code class="language-tsx hljs language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stream</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'xstream'</span>;
<span class="hljs-keyword">import</span> { formatDuration } <span class="hljs-keyword">from</span> <span class="hljs-string">'./libs/format-time'</span>;
<span class="hljs-keyword">import</span> useStream <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/use-stream'</span>;

<span class="hljs-keyword">interface</span> Props {
    <span class="hljs-attr">currentTime$</span>: <span class="hljs-title class_">Stream</span>&lt;<span class="hljs-built_in">number</span>&gt;;
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">CurrentTimeCounter</span> = (<span class="hljs-params">props: Props</span>) =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">currentTime</span>: <span class="hljs-built_in">number</span> = useStream&lt;<span class="hljs-built_in">number</span>&gt;(props.<span class="hljs-property">currentTime$</span>, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">time</span>&gt;</span>{formatDuration(currentTime)}<span class="hljs-tag">&lt;/<span class="hljs-name">time</span>&gt;</span></span>;
};
</code></pre>
<p>And at last, there is beauty.</p>

    </div>

    <footer>
      
        <p class="f5 comp-grey mt5">
          <b class="mr1">Keywords</b> <span class="Post-Keyword">react</span><span class="Post-Keyword">hooks</span><span class="Post-Keyword">xstream</span><span class="Post-Keyword">javascript</span><span class="Post-Keyword">typescript</span>
        </p>
      

      <p class="mt3">
        <a href="/writings" class="btn">&lt;- More writings</a>
      </p>
    </footer>
  </article>
</main>

    </div>

    <footer role="contentinfo">
  <nav>
    <ul class="flex gap justify-center f6 list-reset mb2">
        <li><a href="/feed.xml" title="Atom">Feed</a></li>
        <li><a href="/mind.xml" title="Atom">Mind feed</a></li>
        <li><a href="/credits">Credits</a></li>
        <li><a href="/changelog">Changelog</a></li>
        <li><a href="/api.json">api.json</a></li>
    </ul>
  </nav>

  <p class="muted f6 tc mb0">
    Using <a class="font-mono" href="https://github.com/johanbrook/johanbrook.com/commit/cdb07f63818058171716f70f8f8f6c5c6c050a9a">cdb07f6</a> — built at <time>2022-01-11T22:16:58.948Z</time>
  </p>
</footer>


    <script>
        document.addEventListener('keydown', (evt) => {
            if (evt.code == 'KeyG') {
                document.body.classList.toggle('grid');
            }
        });
    </script>

    <script>
  // Only load on production environment.
  if (window.location.host !== 'johanbrook.com')
    window.goatcounter = {no_onload: true};

  // Skip own views
  if (window.location.hash === '#skipgc')
    localStorage.setItem('skipgc', 't');
  if (localStorage.getItem('skipgc') === 't')
    window.goatcounter = {no_onload: true};
</script>
<script data-goatcounter="https://johanbrook.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>

  


</body></html>