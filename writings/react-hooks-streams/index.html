<!DOCTYPE html>
<html lang="en-gb" class=" writingsreact-hooks-streams"><head itemtype="http://schema.org/Blog" itemscope="">
    <title>Using streams in React with Hooks / Johan</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="preconnect" href="https://gc.zgo.at">
    <link rel="preconnect" href="https://johanbrook.goatcounter.com">

    <meta name="generator" content="Lume">

    
    <meta name="description" content="Pairing React Hooks with Streams works beautifully, and leads to components with less verbosity and boilerplate. In this post, I convert a class component to a function component using hooks.">
    
    
    <meta name="keywords" content="react,hooks,xstream,javascript,typescript">
    
    <meta name="author" content="Johan Brook">

    <!-- Styles-->
    
        <!-- Naked Day has no styles: https://css-naked-day.github.io -->
    

    <!-- Feeds -->
    <link rel="alternate" type="application/rss+xml" title="Johan Brook: Posts feed (RSS)" href="/writings.xml">
    <link rel="alternate" type="application/feed+json" title="Johan Brook: Posts feed (JSON)" href="/writings.json">
    <link rel="alternate" type="application/rss+xml" title="Johan Brook: Micro feed (RSS)" href="/micro.xml">
    <link rel="alternate" type="application/feed+json" title="Johan Brook: Micro feed (JSON)" href="/micro.json">
    <link rel="alternate" type="application/rss+xml" title="Johan Brook: Book feed (RSS)" href="/reading.xml">
    <link rel="alternate" type="application/feed+json" title="Johan Brook: Book feed (JSON)" href="/reading.json">
    <link rel="alternate" type="application/rss+xml" title="Johan Brook: Recipes feed (RSS)" href="/recipes.xml">
    <link rel="alternate" type="application/feed+json" title="Johan Brook: Recipes feed (JSON)" href="/recipes.json">

    <link rel="shortcut icon" href="/favicon.png" type="image/png">
    <link rel="canonical" itemprop="url" href="https://johan.im/writings/react-hooks-streams/">
    <link rel="author" href="https://johan.im">
    <link rel="me" href="https://hachyderm.io/@brookie">

    <meta property="og:title" content="Using streams in React with Hooks">
    <meta property="og:url" content="https://johan.im/writings/react-hooks-streams/">
    <meta property="og:site_name" itemprop="name" content="Johan Brook">
    
    <meta property="og:locale" content="en_GB">
    
    <meta property="og:description" content="Pairing React Hooks with Streams works beautifully, and leads to components with less verbosity and boilerplate. In this post, I convert a class component to a function component using hooks.">
    

    

    
	<meta property="og:type" content="article">
    <meta property="article:tag" content="react,hooks,xstream,javascript,typescript">
    <meta property="article:published_time" content="2019-03-03T01:00:00+01:00">
   	
  </head>

  <body>
  	  <a href="#main" class="visually-hidden skip-link">Skip to content</a>

     
        <aside>
            <h1>Do you think my site is looking weird? That's because I've removed all styling only for today, <time>April 9th</time>, because it's <a href="https://css-naked-day.github.io">CSS Naked Day</a>!</h1>
        </aside>
        <hr>
     

	  <div class="Content">

		

<nav role="navigation" class="MobileNav">
    <p class="mb0">
        <a aria-label="Home" class="MobileNav__Home plain" href="/">Johan</a> <span class="faint">/</span> <a href="/writings" class="muted">Writings</a>
    </p>
    <div class="relative">
        <details>
            <summary>Menu</summary>
            <ul role="list" class="NavList">
              		<li>
             			<a href="/micro/">Micro</a>
              		</li>
              		<li>
             			<a href="/now/">Now</a>
              		</li>
              		<li>
             			<a href="/reading/">Reading</a>
              		</li>
              		<li>
             			<a href="/about/">About</a>
              		</li>
              		<li aria-current="page">
             			<a href="/writings/">Writings</a>
              		</li>
              		<li>
             			<a href="/recipes/">Recipes</a>
              		</li>
              		<li>
             			<a href="/feeds/">Feeds</a>
              		</li>
                <li>
         			<a href="/all">All pages</a>
          		</li>
            </ul>
        </details>
    </div>
</nav>


		<div id="main">
			<main role="main">
  <article class="Post" role="article" itemscope="" itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 itemprop="name" class="title">Using streams in React with Hooks</h1>

      <p class="mb0 fw5">
          <time class="text-color-contrast" datetime="2019-03-03T01:00:00+01:00" title="Sunday, 3 March 2019 at 01:00:00 Central European Time" itemprop="datePublished" pubdate="">
            March 3, 2019
          </time>
          
          
      </p>

      <p class="f5 mb4 font-sans muted">
          About 3 min reading time
      </p>
    </header>

    <div class="prose" itemprop="articleBody">
      
      <p><strong>As of React 16.8,</strong> there’s a new tool in the toolbox:
<a href="https://reactjs.org/docs/hooks-intro.html">Hooks</a>. Hooks are used in functional React components,
extending their functionality to include state and side effects.</p>
<p>I recommend reading
<a href="https://overreacted.io/making-setinterval-declarative-with-react-hooks/">this article</a> by Dan
Abramov for a deeper understanding of hooks. It shows how the coding style moves away from
imperative class code to declarative code.</p>
<p>I realised the beauty of hooks in user interface components when creating a component which shows
the current time in a recording. We’ve recently started using Functional Reactive Streams for the
frontend at Lookback (specifically, we’re using the <a href="http://staltz.github.io/xstream/">xstream</a>
library, but the concepts are similar in other libraries). Explaining the concept with streams is
out of scope in this post, but the gist is that you manage state as immutable streams of values.
<a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">This post</a> is a nice intro to streams/reactive
programming.</p>
<p>Streams actually play well with React. It’s <em>basically</em>, on a conceptual level, all about doing a
<code>.map</code> on a stream of values and draw the React virtual DOM based on the values. But React
components must either have a <code>render()</code> function which return JSX, or be a function which returns
JSX. How do we render our current time from a stream?</p>
<p>An intuitive approach of mine would be:</p>
<pre><code class="language-tsx">import React from 'react';
import { Stream } from 'xstream';

interface Props {
    currentTime$: Stream&lt;number&gt;;
}

// This won't work: our component can't return a Stream!
const CurrentTime = (props: Props) =&gt; props.currentTime$.map((time) =&gt; &lt;time&gt;{time}&lt;/time&gt;);
</code></pre>
<p>We can’t return a stream from a React component –&nbsp;it must somehow devour the stream and return JSX.</p>
<h2>The class(ical) approach</h2>
<p>So we need to take a more verbose approach:</p>
<ol>
<li>Subscribe to the stream in a class component.</li>
<li>For each new value, set the local state to the value.</li>
<li>Render based on local state.</li>
<li>Tear down the subscription on unmount.</li>
</ol>
<p>Very well then:</p>
<pre><code class="language-tsx">import React from 'react';
import { Stream, Subscription } from 'xstream';
import formatTime from './libs/format-time';

interface Props {
    currentTime$: Stream&lt;number&gt;;
}

interface State {
    timeInSeconds: number;
}

export default class TimeCounter extends React.PureComponent&lt;Props, State&gt; {
    sub?: Subscription;

    constructor(props: Props) {
        super(props);

        this.state = {
            timeInSeconds: 0,
        };
    }

    componentDidMount(): void {
        this.sub = this.props.currentTime$.subscribe({
            next: (time) =&gt; {
                this.setState({ timeInSeconds: time });
            },
        });
    }

    componentWillUnmount(): void {
        this.sub &amp;&amp; this.sub.unsubscribe();
    }

    render(): React.ReactNode {
        const { timeInSeconds } = this.state;

        // Renders something like: "00:10"
        return &lt;time&gt;{formatTime(timeInSeconds)}&lt;/time&gt;;
    }
}
</code></pre>
<p>This totally works, but yeah… Very verbose and imperative. Hooks to the rescue!</p>
<h2>The Hook approach</h2>
<p>Let’s follow the intro to Hooks from the React website, and convert our class to a function:</p>
<pre><code class="language-tsx">import React, { useEffect, useState } from 'react';
import { Stream } from 'xstream';
import formatTime from './libs/format-time';

interface Props {
    currentTime$: Stream&lt;number&gt;;
}

const TimeCounter = (props: Props) =&gt; {
    // Create a state hook for our time state, with initial state of zero:
    const [current, setCurrent] = useState&lt;number&gt;(0);

    useEffect(() =&gt; {
        // On component mount, set up a side effect that subscribes to
        // the stream, and let `setCurrent` be called for new values:
        const sub = props.currentTime$.subscribe({
            next: setCurrent,
        });

        // Unsubscribe on component tear down:
        return () =&gt; sub.unsubscribe();
    });

    // Render our current time state as the returned JSX!
    return &lt;time&gt;{formatDuration(currentTime)}&lt;/time&gt;;
};

// Elsewhere, render as usual:
&lt;TimeCounter currentTime$={myStreamOfNumbers$} /&gt;;
</code></pre>
<ul>
<li>We call <code>useEffect</code> to set up a subscription on the incoming stream.
<a href="https://reactjs.org/docs/hooks-effect.html">Read more</a> about the effect hook.</li>
<li>We call <code>useState</code> with an inital value and receive back a tuple of the current value and a
setter. <a href="https://reactjs.org/docs/hooks-state.html">Read more</a> about the state hook.</li>
</ul>
<p>So minimal, still readable. Even <em>more</em> readable than the class version, I think.</p>
<h2>Extracting our hook</h2>
<p>Since Hooks are <em>just functions</em>, we can extract common functional patterns into our own hooks and
use them in other components. I found myself writing another component which also subscribed to an
incoming stream and rendered its values. What a candidate for extraction into a hook!</p>
<p>If we analyse the component above, we see that <code>useState</code> and <code>useEffect</code> are going to work roughly,
if not exactly, the same for any other component. Only the types in the incoming stream differ. Here
we use the type <code>number</code>, but we can make our new Hook generic thanks to TypeScript’s generics.</p>
<p>I came up with this:</p>
<pre><code class="language-ts">// use-stream.ts
import { useEffect, useState } from 'react';
import { Stream } from 'xstream';

const useStream = &lt;T&gt;(stream$: Stream&lt;T&gt;, initialState: T | null = null) =&gt; {
    const [current, setCurrent] = useState&lt;T&gt;(initialState);

    useEffect(() =&gt; {
        const sub = stream$.subscribe({
            next: setCurrent,
        });

        return () =&gt; sub.unsubscribe();
    });

    // Just return our current value, since that's the thing we're interested in
    // (to render) when using this hook:
    return current;
};

export default useStream;
</code></pre>
<p>We’ve just made our own <code>useStream</code> hook by composing <code>useEffect</code> and <code>useState</code>!</p>
<p>The hook can be used like this:</p>
<pre><code class="language-tsx">import React from 'react';
import { Stream } from 'xstream';
import { formatDuration } from './libs/format-time';
import useStream from './hooks/use-stream';

interface Props {
    currentTime$: Stream&lt;number&gt;;
}

const CurrentTimeCounter = (props: Props) =&gt; {
    const currentTime: number = useStream&lt;number&gt;(props.currentTime$, 0);

    return &lt;time&gt;{formatDuration(currentTime)}&lt;/time&gt;;
};
</code></pre>
<p>And at last, there is beauty.</p>

    </div>
  </article>
</main>

		</div>

   		<nav role="navigation" class="MainNav">
	<div class="sticky">
		<h1 class="f4 font-sans">
			<a href="/" aria-label="Home">
				<span>Johan</span><span aria-hidden="true" class="BackLink ml2">←</span>
			</a>
		</h1>

		<ul role="list" class="NavList">
          		<li>
         			<a href="/micro/">Micro</a>
          		</li>
          		<li>
         			<a href="/now/">Now</a>
          		</li>
          		<li>
         			<a href="/reading/">Reading</a>
          		</li>
          		<li>
         			<a href="/about/">About</a>
          		</li>
          		<li aria-current="page">
         			<a href="/writings/">Writings</a>
          		</li>
          		<li>
         			<a href="/recipes/">Recipes</a>
          		</li>
          		<li>
         			<a href="/feeds/">Feeds</a>
          		</li>
            <li>
     			<a href="/all">All pages</a>
      		</li>
        </ul>
	</div>
</nav>

	  </div>

      <script>
  // Only load on production environment.
  if (window.location.host !== new URL('https://johan.im').host) {
    window.goatcounter = {no_onload: true};
  }

  // Skip own views
  if (window.location.hash === '#skipgc')
    localStorage.setItem('skipgc', 't');
  if (localStorage.getItem('skipgc') === 't')
    window.goatcounter = {no_onload: true};
</script>
<script data-goatcounter="https://johanbrook.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>

  


</body></html>