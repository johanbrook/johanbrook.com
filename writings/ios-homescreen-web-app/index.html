<!doctype html><html class=writingsios-homescreen-web-app lang=en><head itemscope itemtype=http://schema.org/Blog><title>customising an ios home screen web app in 2021 / johan brook</title><meta charset=utf-8><meta content="width=device-width,initial-scale=1"name=viewport><link as=font crossorigin=anonymous href=/assets/fonts/inter/Inter-italic.var.woff2 rel=preload type=font/woff2><link as=font crossorigin=anonymous href=/assets/fonts/inter/Inter-roman.var.woff2 rel=preload type=font/woff2><link as=font crossorigin=anonymous href=/assets/fonts/jetbrains-mono/JetBrainsMono-Regular.woff2 rel=preload type=font/woff2><link as=font crossorigin=anonymous href=/assets/fonts/jetbrains-mono/JetBrainsMono-Bold.woff2 rel=preload type=font/woff2><link href=https://gc.zgo.at rel=preconnect><link href=https://johanbrook.goatcounter.com rel=preconnect><meta content="hsl(173 7% 94%)"media="(prefers-color-scheme: light)"name=theme-color><meta content="hsl(173 7% 13%)"media="(prefers-color-scheme: dark)"name=theme-color><meta content="Developing a mobile web app for iOS is tricky, since with new iOS releases, features are being added and removed, and new bugs appear. In this post, I walk through what worked for me and my simple app in iOS 15 (in 2021)."name=description><meta content="ios,web apps,pwa"name=keywords><meta content="Johan Brook"name=author><link href=/johan.css rel=stylesheet><link title="Johan Brook: Posts feed"href=/feed.xml rel=alternate type=application/rss+xml><link title="Johan Brook: Mind feed"href=/mind.xml rel=alternate type=application/rss+xml><link title="Johan Brook: Book feed"href=/reading.xml rel=alternate type=application/rss+xml><link rel="shortcut icon"href=/favicon.png type=image/png><link href=https://johan.im/writings/ios-homescreen-web-app/ itemprop=url rel=canonical><link href=https://johan.im rel=author><meta content="Customising an iOS home screen web app in 2021"property=og:title><meta content=https://johan.im/writings/ios-homescreen-web-app/ property=og:url><meta content="Johan Brook"itemprop=name property=og:site_name><meta content=en_GB property=og:locale><meta content="Developing a mobile web app for iOS is tricky, since with new iOS releases, features are being added and removed, and new bugs appear. In this post, I walk through what worked for me and my simple app in iOS 15 (in 2021)."property=og:description><meta content=article property=og:type><meta content="ios,web apps,pwa"property=article:tag><meta content=2021-12-14T00:00:00Z property=article:published_time><body><a class="visually-hidden skip-link"href=#main>Skip to content</a><div class=Content><nav class=MainNav role=navigation><h1 class=f4><a aria-label=Home href=/> <span class="BackLink mr2"aria-hidden=true>←</span><span>Johan Brook</span> </a></h1><ul class=NavCommon><li aria-current=page><a href=/writings/>Writings</a><li><a href=/mind/>On my mind</a><li><a href=/now/>Now</a><li><a href=/reading/>Reading</a><li><a href=/about/>About me</a></ul></nav><div id=main><main role=main><article class=Post itemscope itemtype=http://schema.org/BlogPosting role=article><header><h1 class=title itemprop=name>Customising an iOS home screen web app in 2021</h1><p class="mb0 fw5 mt3"><time datetime=2021-12-14T00:00:00Z itemprop=datePublished pubdate> December 14th, 2021 </time><p class="muted f5 mb4">About 9 min reading time</header><div class=prose itemprop=articleBody><h2>Background</h2><p>During parental leave, I’ve started to run. Not away from the baby, for heaven’s sakes, but regular exercise running. I really prioritised keeping it super straight-forward: I refuse wear any kind of wearable, such an Apple Watch or Garmin in order to track heart rate and so on (I won’t go into why here, I just don’t need another tech device). But. Even I see the need for tracking basic stats, like duration, length of run, and average speed. Those are literally the three things I need.<p>Let’s see what running apps there are! <em>Opens up App Store.</em> “Strava, yes I’ve heard about that one. Runkeeper… that one I’ve used before! ( = a lifetime ago)”. I installed Strava because it was at the top, and hell begins. It prompts me for an account, which is fair enough I guess, but it still put me off a bit. It’s also paid. Monthly subscription. And it shows nagging reminders to upgrade to a paid plan <em>everywhere</em>. And it has social features, which I of course don’t need. It has so much <em>stuff</em> I neither need nor want! As a developer on leave, the only sane thing to do is to write my own running app.<p>Since I’m not a Swift or Objective-C developer (and have no intentions of becoming one), I need to do it as a web app. Approximately 5 seconds after I decided to develop my own running tracker app I realise I really must ensure that this single API is available in the iOS browser: being able to <em>watch</em> the GPS position as it changes with the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API>Geolocation API</a>. Thank god, <code>Geolocation.watchPosition()</code> exists, and a wave of relief is showering over me. That means I can watch the position, stash away the raw coordinates, and do things with them. Such as converting to <a href=https://geojson.org>GeoJSON</a> in order to calculate the length in kilometers and drawing the route in an embedded map from Mapbox.<ul><li>You can try the final app here: <a href=https://runloop.pages.dev>runloop.pages.dev</a>. Be sure to add it to your homescreen.<li>The source code for my app is over <a href=https://github.com/johanbrook/runloop>at GitHub</a>.</ul><h2>Apple documentation feels out of date</h2><p>I start out by going straight into the horse’s mouth: the Apple documentation on (mobile) Safari. This should be the truth, and nothing but the truth! I head over to <a href=https://developer.apple.com>developer.apple.com</a> and browse to some “Technologies” page where one can input a “technology”. I put in <a href="https://developer.apple.com/documentation/technologies?tags=Safari">“safari”</a>. The search results only yield things that are interesting from a native app perspective, such as embedding web views.<p>Okay. I scroll around to the footer, and see <a href=https://developer.apple.com/safari/>“Safari and the web”</a>. Score! These are the only interesting links:<p><img alt="Apple docs"src=/assets/posts/apple-docs-safari.png><p>Clicking that “More” link leads me to the <a href="https://developer.apple.com/library/archive/navigation/index.html?filter=safari">“Documentation Archive”</a>. That sounds nice. Latest change as of writing is in June 2018. Gulp.<p>Unless I’m missing something, there’s no official Apple documentation on iOS Safari. Except for browsing through blog posts over at <a href=https://webkit.org>WebKit.org</a> and other release notes. Note that I’m talking about proprietary Safari tech — not regular Web APIs you’d find over at MDN.<p>My next bet was simply googling around on problems as I encountered them.<h2>How to make a web app behave and look nicely on iOS 15 in 2021</h2><p>What follows is a stream of things I encountered while researching how to make a super slick iOS web app in 2021. My phone is an iPhone 12 mini, and I’m using iOS 15.2 at the time of writing this post.<h3>Adding to home screen — don’t forget the icon</h3><p>I knew from before that adding a web page to the iOS home screen grants it special privileges. Like not <a href=https://webkit.org/blog/10218/full-third-party-cookie-blocking-and-more/>wiping LocalStorage after just 7 days</a>. Also, there’s the UX aspect, which is important: adding to the home screen removes the Safari chrome (UI) and runs the web app in a frameless mode. This is nice.<p>This hasn’t changed since last time I looked, thank god. The option is still there in the Safari UI. It’ll add use the <code>&LTtitle></code> from your web page as the app title. You need to supply an icon yourself (iOS will pick a fugly screenshot of your app otherwise).<p>Put this in your <code>&LThead></code>:<pre class=language-html><code class=language-html><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>apple-touch-icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>apple-touch-icon.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
</code></pre><p>where the <code>href</code> attribute points to a PNG image with the icon file.<p>Refer to <a href=https://developer.apple.com/design/human-interface-guidelines/ios/icons-and-images/app-icon/>Apple’s official guide on icons</a> for sizes, since you can control which icon file that goes with which size, like this:<pre class=language-html><code class=language-html><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>apple-touch-icon<span class="token punctuation">"</span></span> <span class="token attr-name">sizes</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>152x152<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>touch-icon-ipad.png<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
</code></pre><h3>Viewport settings</h3><p>The single most important thing you’d want to do is to set the viewport width to the width of the device. This is old school, but important:<pre class=language-html><code class=language-html><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre><p>If you feel like disabling the pinch-to-zoom behaviour of web pages, tack on an <code>user-scalable=no</code>:<pre class=language-html><code class=language-html><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0, user-scalable=no<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre><p>For me, I wanted more native feel, so I disabled zoom. Even though it’s a bit user hostile. But the user in this case is me, so I don’t care.<h3>Frameless mode and <code>manifest.json</code></h3><p>The next most important thing is to tell iOS that we’d like to run the web app in “frameless mode”, or “without the browser chrome”. Otherwise your home screen web app icon only leads to a web page, and thus merely becomes a shortcut. We want it to feel like an app!<pre class=language-html><code class=language-html><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>apple-mobile-web-app-capable<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre><p>This still is the way to tell iOS to hide the address bar and all that.<p>But. When I clicked around on internal links in my app, I saw the browser chrome appear for every link click! It would suck if Apple had crippled mobile web apps in this way, but I wasn’t too surprised after all — this is Apple.<p>I started reading about <a href=https://developer.mozilla.org/en-US/docs/Web/Manifest>“Web app manifests”</a>. Those manifests is a JSON file which tells the browser more things when it runs the app in “PWA” (Progressive Web App) mode. I’s mainly about customising presentation, such as titles, icons, splash screens, etc. So I sort of wrote it off at first, and also thought Apple wouldn’t care about these kinds of valiant efforts by the web community.<p>But I was wrong. I stuck a simple <code>manifest.json</code> in my root directory and linked it from my HTML:<pre class=language-html><code class=language-html><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>manifest<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/manifest.json<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre><pre class=language-json><code class=language-json><span class="token punctuation">{</span>
	<span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Runloop"</span><span class="token punctuation">,</span>
	<span class="token property">"scope"</span><span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
	<span class="token property">"display"</span><span class="token operator">:</span> <span class="token string">"standalone"</span>
<span class="token punctuation">}</span>
</code></pre><p>I’m not sure whether it was the <code>scope</code> or <code>display</code> parameter that made the internal links work without chrome again, but this did the trick! iOS Safari <em>is</em> parsing this file after all. And I have no idea why the <code>apple-mobile-web-app-capable</code> tag won’t cut it, but oh well. This feels like an extra guard to <em>really</em> tell the system that my app is running standalone without any browser chrome (“please”).<h3>Using the whole screen on iPhone models with notches</h3><p>My iPhone 12 mini has a notch, and is thus not a perfect rectangular display. We can tell the web app to use the whole display with this:<pre class=language-html><code class=language-html><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>viewport<span class="token punctuation">'</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>initial-scale=1, viewport-fit=cover<span class="token punctuation">'</span></span> <span class="token punctuation">/></span></span>
</code></pre><p>That is, adding <code>viewport-fit=cover</code> to the <code>viewport</code> meta tag. Otherwise, Safari will play it safe and make sure your app lives within a rectangular area far away from the notch.<p>Apple is kind and provides tech for us in order to avoid colliding with the notch and the virtual home button at the bottom of the iPhone screen. <a href=https://webkit.org/blog/7929/designing-websites-for-iphone-x/>I recommend reading this article</a>.<p>Basically, we’ve got four <code>env()</code> values to use:<pre class=language-css><code class=language-css><span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-top<span class="token punctuation">)</span>
<span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span>
<span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-left<span class="token punctuation">)</span>
<span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-right<span class="token punctuation">)</span>
</code></pre><p><code>env()</code> works where <code>var()</code> works — even inside <code>calc()</code>, which is nice. For instance, this is the styling for my bottom <code>NavBar</code> component:<pre class=language-css><code class=language-css><span class="token selector">.NavBar</span> <span class="token punctuation">{</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--inset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
  <span class="token property">bottom</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">right</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span> + 10px<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">padding-left</span><span class="token punctuation">:</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-left<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">var</span><span class="token punctuation">(</span>--inset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">padding-right</span><span class="token punctuation">:</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-right<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">var</span><span class="token punctuation">(</span>--inset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><code>--inset</code> is set on <code>:root</code>, and is the “global padding” in my app. As you can see, I use it with the <code>max()</code> function to make the left and right padding be whatever’s the max value of the safe area and my inset.<h3>Styling taps on links and buttons</h3><p>Since the arrival of the first iOS (“iPhone OS”?), it’s been tricky to style taps on interactive elements. Such as a different background on a button when you tap it. <code>:active</code> and <code>:hover</code> pseudo selectors are both weird and strangely enough don’t manage to produce that native feel.<p>In 2021, turns your all you have to is adding a single no-op touch listener, and then you can use <code>:active</code> as it’s intended to:<pre class=language-js><code class=language-js><span class="token comment">// Adding an empty touch listener will make :active CSS pseudo selector</span>
<span class="token comment">// work in order to style taps on elements. Joy.</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Insert that snippet somewhere in your JS, and off you go.<h3>Making the app be 100% height and don’t show scrollbars</h3><p>You thought this was the kind of stuff you’d stop put up with in 2021? Think again. <code>100vh</code> won’t do what you think it does, and Apple devs think it works “as intended”. <a href=https://chanind.github.io/javascript/2019/09/28/avoid-100vh-on-mobile-web.html>Read more here</a> for a demonstration. I almost can’t muster strength to explain it all, but the gist of it is that the browser chrome in mobile Safari is dynamic in height and take up space. This affects the <code>vh</code> unit and produces overflow.<p><a href=https://www.bram.us/2021/07/08/the-large-small-and-dynamic-viewports/>Dynamic viewports</a> will fix this. But until then, I went with a boring Javascript fix:<pre class=language-ts><code class=language-ts><span class="token keyword">let</span> lastHeight<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> setAppHeight <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> doc <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">;</span>
	<span class="token keyword">const</span> height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>height <span class="token operator">!=</span> lastHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		doc<span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">'--app-height'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>height <span class="token operator">-</span> <span class="token constant">MAGIC_NUMBER</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		lastHeight <span class="token operator">=</span> height<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This is the magic offset which one can subtract in order to hide scrollbars</span>
<span class="token comment">// AT LEAST ON MY PHONE. YMMV.</span>
<span class="token keyword">const</span> <span class="token constant">MAGIC_NUMBER</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">/** This is solving the STILL outstanding problem of using
 * height: 100vh on Mobile Safari. The problem is outlined here:
 * https://chanind.github.io/javascript/2019/09/28/avoid-100vh-on-mobile-web.html
 *
 * Instead, we control the height of a CSS variable which is mirroring
 * the window.innerHeight property.
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">fixMobileHeight</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
	window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> setAppHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">setAppHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> setAppHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Util</span>
<span class="token keyword">const</span> <span class="token function-variable function">debounce</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function-variable function">func</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> wait<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> timeout<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>Timeout<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> <span class="token function-variable function">later</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			<span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">func</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
		timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>later<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">fixMobileHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><pre class=language-css><code class=language-css><span class="token selector">#app</span> <span class="token punctuation">{</span>
  <span class="token property">min-height</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--app-height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>We use the <code>resize</code> event which fires on <code>window</code> to set a CSS variable, which we can use in our stylesheet. It has some guards so that we won’t fire it too often.<h3>Dark mode</h3><p>Don’t forget enabling dark mode so Safari can style native elements:<pre class=language-css><code class=language-css><span class="token selector">:root</span> <span class="token punctuation">{</span>
  <span class="token property">color-scheme</span><span class="token punctuation">:</span> light dark<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>This is controllable from a tag within <code>&LThead></code> too (which I guess is faster since the browser doesn’t have to download and parse the CSS to decide).<h3>Theme colours</h3><p>This is new, and very marketed by Apple dev evangelists: the possibility to set the “theme colour”, which makes Safari use a configured colour of your choice in the browser chrome. Safari is trying to be smart, and defaults to the <code>background-color</code> on your <code>html</code> or <code>body</code> elements, but sometimes you need to set it on your own:<pre class=language-html><code class=language-html><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theme-color<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#fff<span class="token punctuation">"</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(prefers-color-scheme: light)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation"><</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theme-color<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#000<span class="token punctuation">"</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(prefers-color-scheme: dark)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre><h3>System colours</h3><p>Speaking of colours: dark mode isn’t cool, you know what’s cool? System colours (that joke fell…). I stumbled upon this blog post: <a href=https://blog.jim-nielsen.com/2021/css-system-colors/>“CSS System Colors”</a>. The author emphasised not hard coding any colours for light and dark modes. Instead, he lets the system decide from sensible defaults. For a website or app without need for any special branding, this is probably what you want.<p>But what do you do when you actually want to <em>use</em> one of these system colours elsewhere in your CSS? That’s the core question in the linked blog post, I’ll let you read it.<p><em>tldr</em>: there are “system colors” defined in the <a href=https://drafts.csswg.org/css-color/#css-system-colors>CSS spec</a>, which you can use like any other colour:<pre class=language-css><code class=language-css><span class="token selector">.dropdown</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> Canvas<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Of course, there’s a bug (?) in iOS, so <code>Canvas</code> backgrounds don’t work properly. The blog post suggests using the <code>-apple-system-control-background</code> value as a hack, and it works. Copied from the post:<pre class=language-css><code class=language-css><span class="token comment">/* Defaults/fallbacks for 1) */</span>
<span class="token selector">:root</span> <span class="token punctuation">{</span>
  <span class="token property">--color-bg</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
  <span class="token property">--color-text</span><span class="token punctuation">:</span> #222<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 1) For browsers that don’t support `color-scheme` and therefore
   don't handle system dark mode for you automatically 
   (Firefox), handle it for them. */</span>
<span class="token atrule"><span class="token rule">@supports</span> <span class="token keyword">not</span> <span class="token punctuation">(</span><span class="token property">color-scheme</span><span class="token punctuation">:</span> light dark<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">html</span> <span class="token punctuation">{</span>
    <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--color-bg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--color-text<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 2) For browsers that support automatic dark/light mode
   As well as system colors, set those */</span>
<span class="token atrule"><span class="token rule">@supports</span> <span class="token punctuation">(</span><span class="token property">color-scheme</span><span class="token punctuation">:</span> light dark<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">background-color</span><span class="token punctuation">:</span> Canvas<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">color</span><span class="token punctuation">:</span> CanvasText<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">:root</span> <span class="token punctuation">{</span>
    <span class="token property">--color-bg</span><span class="token punctuation">:</span> Canvas<span class="token punctuation">;</span>
    <span class="token property">--color-text</span><span class="token punctuation">:</span> CanvasText<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 3) For Safari on iOS. Hacky, but it works. */</span>
<span class="token atrule"><span class="token rule">@supports</span> <span class="token punctuation">(</span><span class="token property">background-color</span><span class="token punctuation">:</span> -apple-system-control-background<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token property">color</span><span class="token punctuation">:</span> text<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">:root</span> <span class="token punctuation">{</span>
    <span class="token property">--color-bg</span><span class="token punctuation">:</span> -apple-system-control-background<span class="token punctuation">;</span>
    <span class="token property">--color-text</span><span class="token punctuation">:</span> text<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token selector">html</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--color-bg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--color-text<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>This worked for me. Now I can use <code>--color-bg</code> wherever I want to use the (dynamic, non hard coded) background colour.<h3>Disabling selecting text</h3><p>This also goes in the “user hostile” department. Use are your own discretion:<pre class=language-css><code class=language-css><span class="token selector">html</span> <span class="token punctuation">{</span>
  <span class="token property">-webkit-tap-highlight-color</span><span class="token punctuation">:</span> transparent<span class="token punctuation">;</span>
  <span class="token property">-webkit-user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token property">user-select</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3>Use an iOS-y font stack</h3><p>I went with this, to get the SF font:<pre class=language-css><code class=language-css><span class="token property">font-family</span><span class="token punctuation">:</span> -apple-system<span class="token punctuation">,</span> BlinkMacSystemFont<span class="token punctuation">,</span> <span class="token string">'Segoe UI'</span><span class="token punctuation">,</span> <span class="token string">'Roboto'</span><span class="token punctuation">,</span> <span class="token string">'Oxygen'</span><span class="token punctuation">,</span> <span class="token string">'Ubuntu'</span><span class="token punctuation">,</span> <span class="token string">'Cantarell'</span><span class="token punctuation">,</span>
        <span class="token string">'Fira Sans'</span><span class="token punctuation">,</span> <span class="token string">'Droid Sans'</span><span class="token punctuation">,</span> <span class="token string">'Helvetica Neue'</span><span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
</code></pre><h2>Conclusion</h2><p>After all these fixes, my app finally felt pretty good to use on an iPhone. It looked gorgeous in dark mode, the typography was great, it felt snappy navigating around, and not like a wEbSiTe at all.<p>I’m most impressed over how easy it is to make the <em>styling</em> look nice. Before iOS 7, when we were in skeumorphism land, it was a pain to make web apps blend into the system. Now it’s just some typography, spacing, and default colours, and we’ve come a long way. If you just “know” how a typical iOS app looks like — with list views, headings and so on — I bet you’ll get something that looks decent in no time thanks to the CSS snippets I’ve posted throughout the text.<p>I was most surprised over the show-chrome-on-link-tap thing in the home screen app. I had no idea one needed to use a Webmanifest JSON file to get rid of that. I’ve found <em>very little</em> documentation on iOS’ use of the web manifest file too.<h3>Nice Web APIs</h3><p>Overall, Web APIs have gone a long way with I/O: we can now upload, download, and <em>share</em> files in iOS. I built and export and import feature to try this out, and it worked great on mobile:<pre class=language-ts><code class=language-ts><span class="token keyword">const</span> <span class="token function-variable function">doImport</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>evt<span class="token operator">:</span> Event<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token punctuation">{</span> files <span class="token punctuation">}</span> <span class="token operator">=</span> evt<span class="token punctuation">.</span>target <span class="token keyword">as</span> HTMLInputElement<span class="token punctuation">;</span>

	<span class="token keyword">const</span> file <span class="token operator">=</span> files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>type <span class="token operator">!=</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Only JSON files, please.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">await</span> file<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// do stuff with object</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to read "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">". Reason: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

document<span class="token punctuation">.</span><span class="token function">findElementById</span><span class="token punctuation">(</span><span class="token string">'import'</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> doImport<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><pre class=language-html><code class=language-html><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>import<span class="token punctuation">"</span></span> <span class="token attr-name">accept</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>application/json<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre><p>Exporting works good with the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share>Share API</a>:<pre class=language-ts><code class=language-ts><span class="token keyword">const</span> <span class="token function-variable function">doExport</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token comment">// Will show native iOS share pane</span>
		<span class="token keyword">await</span> navigator<span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			title<span class="token operator">:</span> <span class="token string">'Run data as JSON'</span><span class="token punctuation">,</span>
			files<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">fileOf</span><span class="token punctuation">(</span>appConf<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ex <span class="token keyword">as</span> DOMException<span class="token punctuation">)</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'AbortError'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Sharing failed. Reason: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span>ex <span class="token keyword">as</span> Error<span class="token punctuation">)</span><span class="token punctuation">.</span>message <span class="token operator">||</span> ex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fileOf <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> File <span class="token operator">=></span>
	<span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>appConf<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'runloop.json'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
		type<span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>The user now gets the choice of saving the file somewhere, or sending it with the native UI controls.<h2>Epilogue</h2><p>The irony is that my running tracker app didn’t work <em>at all</em> out in the wild… Turns out that the system turns off any background geolocation services when the screen is locked — which totally is the case when I’m running. And there’s no Geolocation in Service Workers or similar background magic place. Argh.<p>See it in action here: <a href=https://runloop.pages.dev>runloop.pages.dev</a>.</div></article></main><footer class=mb3 role=contentinfo><nav><ul class=mb3><li><a href=/>Home</a><li><a href=mailto:webmaster@johan.im rel=me>Email</a><li><a href=https://hachyderm.io/@brookie rel=me>Mastodon</a><li><a href=/feed.xml title=Atom>Post feed</a><li><a href=/mind.xml title=Atom>Mind feed</a><li><a href=/reading.xml title=Atom>Reading feed</a><li><a href=/credits>Credits</a><li><a href=/changelog>Changelog</a></ul></nav><p class="muted mb0">Using <a class=font-mono href=https://github.com/johanbrook/johanbrook.com/commit/5994704f2646b9598c34c2d9d2658276f9ea8613>5994704</a> — built at <time>2023-05-04T05:24:17.142Z</time> — web 1.0 and 2.0 compatible.</footer></div></div><script>if(window.location.host!==new URL('https://johan.im').host){window.goatcounter={no_onload:true}};if(window.location.hash==='#skipgc')localStorage.setItem('skipgc','t');if(localStorage.getItem('skipgc')==='t')window.goatcounter={no_onload:true}</script><script async data-goatcounter=https://johanbrook.goatcounter.com/count src=//gc.zgo.at/count.js></script>